<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FFXBan Panel</title>
    <link rel="stylesheet" href="/panel.css?v=20260228g">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ansi_up@6.0.2/ansi_up.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
</head>
<body>
  <div id="progressTop" class="progress-top"></div>
  <header class="topbar">
    <div class="brand"><span class="brand-badge">‚ö°</span>FFXBan <span class="page-current" id="currentPage">–î–∞—à–±–æ—Ä–¥</span></div>
    <div class="search-wrap">
      <span>üîç</span>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ email / ID..." autocomplete="off">
    </div>
    <div class="top-actions"><button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button><button class="btn warn" id="logoutBtn">–í—ã—Ö–æ–¥</button></div>
  </header>
  <div class="app" id="appGrid">
    <aside class="sidebar" id="sidebar">
      <div class="side-head">
        <div class="side-head-text"><h2 class="side-title">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä</h2><p class="side-sub">FFXBan Monitoring</p></div>
        <button class="sidebar-toggle" id="sidebarToggle" title="–°–≤–µ—Ä–Ω—É—Ç—å">‚óÄ</button>
      </div>
      <nav class="nav">
        <button class="menu active" data-p="dashboard" data-title="–î–∞—à–±–æ—Ä–¥"><i>‚óà</i><span class="menu-text">–î–∞—à–±–æ—Ä–¥</span></button>
        <button class="menu" data-p="users" data-title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"><i>‚óâ</i><span class="menu-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span></button>
        <button class="menu" data-p="traffic" data-title="–†–∞—Å—Ö–æ–¥ —Ç—Ä–∞—Ñ–∏–∫–∞"><i>‚óå</i><span class="menu-text">–†–∞—Å—Ö–æ–¥ —Ç—Ä–∞—Ñ–∏–∫–∞</span></button>
        <button class="menu" data-p="activebans" data-title="–ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞–Ω—ã"><i>üîí</i><span class="menu-text">–ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞–Ω—ã</span></button>
        <button class="menu" data-p="nodeops" data-title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏"><i>‚åò</i><span class="menu-text">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏</span></button>
        <button class="menu" data-p="sshterm" data-title="SSH –¢–µ—Ä–º–∏–Ω–∞–ª"><i>‚ñ∂</i><span class="menu-text">SSH –¢–µ—Ä–º–∏–Ω–∞–ª</span></button>
        <button class="menu" data-p="permanent-ban" data-title="–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω"><i>‚ò†</i><span class="menu-text">–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω</span></button>
        <button class="menu" data-p="settings" data-title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i>‚öô</i><span class="menu-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
      </nav>
      <div class="side-foot"><span class="pulse">–û–Ω–ª–∞–π–Ω</span><span id="wsStatusLabel" style="display:flex;align-items:center"><span id="wsDot" class="ws-dot"></span><span id="wsText">live</span></span></div>
    </aside>
    <main class="content">

      <!-- DASHBOARD -->
      <section id="p-dashboard" class="page active">
        <div class="stats-grid">
          <div class="stat-card blue"><div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div><div class="stat-value" id="kUsers">0</div><div class="stat-hint">–∞–∫—Ç–∏–≤–Ω—ã–µ –≤ —Å–∏—Å—Ç–µ–º–µ</div></div>
          <div class="stat-card green"><div class="stat-label">–û–Ω–ª–∞–π–Ω</div><div class="stat-value" id="kActive">0</div><div class="stat-hint">–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–∏–Ω—É—Ç—ã</div></div>
          <div class="stat-card amber"><div class="stat-label">–ù–∞—Ä—É—à–∏—Ç–µ–ª–∏</div><div class="stat-value" id="kViolators">0</div><div class="stat-hint">–≤—ã—à–µ –ª–∏–º–∏—Ç–∞</div></div>
          <div class="stat-card red"><div class="stat-label">–í –±–∞–Ω–µ</div><div class="stat-value" id="kBanned">0</div><div class="stat-hint">—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ</div></div>
          <div class="stat-card cyan"><div class="stat-label">–ù–æ–¥—ã</div><div class="stat-value" id="kNodes">0</div><div class="stat-hint">–∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π</div></div>
          <div class="stat-card"><div class="stat-label">–û—á–µ—Ä–µ–¥–∏</div><div class="stat-value" id="kQueue">0</div><div class="stat-hint">log + side effect</div></div>
        </div>
        <!-- –¢—Ä–µ–Ω–¥—ã + –ê–ª–µ—Ä—Ç—ã -->
        <div class="db-row-main">
          <div class="panel">
            <div class="db-ph">
              <div>
                <h3>–¢—Ä–µ–Ω–¥—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                <span class="muted" style="font-size:12px" id="trendLabel">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
              </div>
            </div>
            <div style="position:relative;height:200px"><canvas id="chartTrend"></canvas></div>
          </div>
          <div class="panel db-flex-col">
            <div class="db-ph">
              <h3>–ê–ª–µ—Ä—Ç—ã</h3>
              <span class="alerts-count" id="alertsCount">0</span>
            </div>
            <div id="alertsCenter" class="db-alerts-list"></div>
            <div class="db-alerts-ts"><span id="alertsUpdatedAt">–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span></div>
          </div>
        </div>
        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è -->
        <div class="db-row-charts">
          <div class="panel"><h3>–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3><div class="chart-wrap"><canvas id="chartStatus"></canvas></div></div>
          <div class="panel"><h3>–¢–∏–ø—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</h3><div class="chart-wrap"><canvas id="chartNetwork"></canvas></div></div>
        </div>
        <!-- –ù–æ–¥—ã -->
        <div class="panel nodes-panel db-nodes-full">
          <div class="db-ph">
            <div class="nodes-title-wrap">
              <div class="nodes-icon">‚ñ£</div>
              <div class="nodes-title-text">
                <h3 style="margin:0 0 2px">–ù–æ–¥—ã</h3>
                <p id="nodesSummaryHint" style="margin:0;color:#88a6d3;font-size:13px">0 –æ–Ω–ª–∞–π–Ω / 0 –≤—Å–µ–≥–æ</p>
              </div>
            </div>
            <div class="nodes-legend">
              <span class="nodes-legend-item"><i class="nodes-legend-dot ok"></i><span id="nodesOnlineCount">0</span></span>
              <span class="nodes-legend-item"><i class="nodes-legend-dot err"></i><span id="nodesOfflineCount">0</span></span>
            </div>
          </div>
          <div id="nodesCards" class="nodes-cards"></div>
          <div id="nodesToggleWrap" class="nodes-toggle-wrap" style="display:none">
            <button class="btn nodes-toggle-btn" id="nodesToggleBtn" type="button">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
          </div>
        </div>
        <!-- –ì–æ—Ä—è—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ + –°–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å -->
        <div class="db-row-bottom">
          <div class="panel">
            <div class="db-ph">
              <h3>–ì–æ—Ä—è—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
              <select id="fHotNode" class="select" style="min-width:210px"><option value="all">–ù–æ–¥–∞: –≤—Å–µ</option></select>
            </div>
            <div class="table-wrap"><table><thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>IP</th><th>–õ–∏–º–∏—Ç</th><th>–ù–æ–¥–∞</th><th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th></tr></thead><tbody id="tbHotUsers"></tbody></table></div>
          </div>
          <div class="panel">
            <h3>–°–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å</h3>
            <div id="sysinfoBlock" style="margin-top:14px"></div>
          </div>
        </div>
      </section>

      <!-- USERS -->
      <section id="p-users" class="page">
        <div class="section-head"><div><h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2><p>–ü–æ–∏—Å–∫ –∏ —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p></div></div>
        <div class="toolbar sticky-toolbar">
          <input id="qUser" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ email, IP, –Ω–æ–¥–µ">
          <select id="fState" class="select"><option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option><option value="ok">–ù–æ—Ä–º–∞</option><option value="bad">–ù–∞—Ä—É—à–µ–Ω–∏–µ</option><option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option></select>
          <select id="fNode" class="select"><option value="all">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –≤—Å–µ</option></select>
        </div>
        <div class="bulk-bar" id="usersBulkBar">
          <span class="bulk-count" id="usersBulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          <select id="usersBulkDuration" class="select" style="height:36px;min-width:140px">
            <option value="30m">30 –º–∏–Ω</option>
            <option value="1h">1 —á–∞—Å</option>
            <option value="6h">6 —á–∞—Å–æ–≤</option>
            <option value="24h">24 —á–∞—Å–∞</option>
            <option value="permanent">–ù–∞–≤—Å–µ–≥–¥–∞</option>
          </select>
          <button class="btn danger" id="usersBulkBlock">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" id="usersBulkUnblock">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" style="margin-left:auto" id="usersBulkDeselect">–°–Ω—è—Ç—å</button>
        </div>
        <div class="table-wrap"><table><thead><tr><th class="th-check"><input type="checkbox" id="usersCheckAll"></th><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>IP</th><th>–õ–∏–º–∏—Ç</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫–∏</th><th>–¢—Ä–∏–≥–≥–µ—Ä—ã</th><th>–ù–æ–¥–∞</th><th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th></tr></thead><tbody id="tbUsers"></tbody></table></div>
        <div id="usersPager" class="pager"></div>
      </section>

      <!-- TRAFFIC -->
      <section id="p-traffic" class="page">
        <div class="section-head">
          <div><h2>–†–∞—Å—Ö–æ–¥ —Ç—Ä–∞—Ñ–∏–∫–∞</h2><p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –Ω–æ–¥–∞–º</p></div>
          <div class="section-head-actions">
            <button class="btn" id="trafficExportBtn">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
          </div>
        </div>
        <div class="mini-grid" style="margin-top:0">
          <div class="mini"><span class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span><b id="kTrafficUsers">0</b></div>
          <div class="mini"><span class="muted">–û–Ω–ª–∞–π–Ω</span><b id="kTrafficOnline">0</b></div>
          <div class="mini"><span class="muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</span><b id="kTrafficUsed">0 B</b></div>
          <div class="mini"><span class="muted">–õ–∏–º–∏—Ç</span><b id="kTrafficLimit">0 B</b></div>
        </div>
        <div class="toolbar sticky-toolbar">
          <div id="trafficPeriodGroup" class="seg-group">
            <button class="seg-btn" data-period="1d">1–¥</button>
            <button class="seg-btn" data-period="3d">3–¥</button>
            <button class="seg-btn" data-period="7d">7–¥</button>
            <button class="seg-btn" data-period="14d">14–¥</button>
            <button class="seg-btn active" data-period="30d">30–¥</button>
          </div>
          <input id="qTraffic" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ user_id">
          <select id="fTrafficTariff" class="select"><option value="all">–¢–∞—Ä–∏—Ñ: –≤—Å–µ</option></select>
          <select id="fTrafficNode" class="select"><option value="all">–ù–æ–¥—ã: –≤—Å–µ</option></select>
          <select id="fTrafficStatus" class="select"><option value="all">–°—Ç–∞—Ç—É—Å: –≤—Å–µ</option></select>
        </div>
        <p class="muted" id="trafficMetaHint" style="margin:0 2px 10px"></p>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–¢–∞—Ä–∏—Ñ</th>
                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</th>
                <th>–ü–æ–¥–∫–ª.</th>
                <th>–í—Å–µ–≥–æ –ì–ë</th>
                <th>Lifetime –ì–ë</th>
                <th>–õ–∏–º–∏—Ç –ì–ë</th>
                <th>–ü–æ–∫—Ä—ã—Ç–∏–µ</th>
                <th>–ù–∞—á–∞–ª–æ</th>
                <th>–ö–æ–Ω–µ—Ü</th>
                <th>–ü–æ—Å–ª. –Ω–æ–¥–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody id="tbTraffic"></tbody>
          </table>
        </div>
      </section>

      <!-- VIOLATORS -->
      <section id="p-violators" class="page">
        <div class="section-head">
          <div><h2>–ù–∞—Ä—É—à–∏—Ç–µ–ª–∏</h2><p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–∞</p></div>
          <div class="section-head-actions">
            <button class="btn" id="exportViolatorsBtn">‚¨á CSV</button>
          </div>
        </div>
        <div class="bulk-bar" id="violBulkBar">
          <span class="bulk-count" id="violBulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          <button class="btn danger" id="violBulkUnban">–†–∞–∑–±–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
          <button class="btn" id="violBulkClear">–°–±—Ä–æ—Å–∏—Ç—å IP</button>
          <button class="btn" style="margin-left:auto" id="violBulkDeselect">–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        </div>
        <div class="table-wrap"><table><thead><tr><th class="th-check"><input type="checkbox" id="violCheckAll"></th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>IP —Å–µ–π—á–∞—Å</th><th>–õ–∏–º–∏—Ç</th><th>–¢—Ä–∏–≥–≥–µ—Ä—ã</th><th>–ù–æ–¥–∞</th><th>–í—Ä–µ–º—è</th></tr></thead><tbody id="tbViolators"></tbody></table></div>
      </section>

      <!-- BAN LIST -->
      <section id="p-ban" class="page">
        <div class="section-head">
          <div><h2>–ë–∞–Ω-–ª–∏—Å—Ç</h2><p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º</p></div>
          <div class="section-head-actions">
            <button class="btn" id="exportBanBtn">‚¨á CSV</button>
          </div>
        </div>
        <div class="bulk-bar" id="banBulkBar">
          <span class="bulk-count" id="banBulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          <button class="btn danger" id="banBulkUnban">–†–∞–∑–±–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
          <button class="btn" style="margin-left:auto" id="banBulkDeselect">–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        </div>
        <div class="table-wrap"><table><thead><tr><th class="th-check"><input type="checkbox" id="banCheckAll"></th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>IP</th><th>–õ–∏–º–∏—Ç</th><th>–ë–∞–Ω–æ–≤</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th></tr></thead><tbody id="tbBan"></tbody></table></div>
      </section>

      <!-- ACTIVE BANS -->
      <section id="p-activebans" class="page">
        <div class="section-head"><div><h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞–Ω—ã</h2><p>IP-–±–∞–Ω—ã —Å –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á—ë—Ç–æ–º</p></div></div>
        <div class="table-wrap"><table><thead><tr><th>IP</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th><th>–ù–æ–¥–∞</th><th>–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</th><th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th><th>–û—Å—Ç–∞–ª–æ—Å—å</th></tr></thead><tbody id="tbActiveBans"></tbody></table></div>
      </section>

      <!-- NODE OPS -->
      <section id="p-nodeops" class="page">
        <div class="section-head">
          <div><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏</h2><p>SSH-–∫–æ–º–∞–Ω–¥—ã –Ω–∞ –Ω–æ–¥—ã —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</p></div>
        </div>
        <div class="nodeops-grid">
          <div class="nodeops-side">
            <div class="panel">
              <h3>–ù–æ–¥—ã</h3>
              <div class="nodeops-actions">
                <button class="btn" id="nodeSshSelectAll">–í—Å–µ</button>
                <button class="btn" id="nodeSshSelectOnline">–û–Ω–ª–∞–π–Ω</button>
                <button class="btn" id="nodeSshClear">–°–Ω—è—Ç—å</button>
                <button class="btn" id="nodeSshRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
              </div>
              <p class="nodeops-counter" id="nodeSshCounter">–í—ã–±—Ä–∞–Ω–æ: 0</p>
              <div class="nodeops-list" id="nodeSshList"></div>
            </div>
          </div>
          <div class="nodeops-main">
            <div class="panel" id="nodeSshSinglePanel">
              <h3 id="nodeSshSingleTitle">–¢–µ—Ä–º–∏–Ω–∞–ª –Ω–æ–¥—ã</h3>
              <textarea id="nodeSshSingleCommand" class="nodeops-cmd" placeholder="–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–æ–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: uname -a"></textarea>
              <div class="nodeops-runbar" style="margin-top:10px">
                <select id="nodeSshSingleTimeout" class="select">
                  <option value="20">–¢–∞–π–º–∞—É—Ç: 20 —Å–µ–∫</option>
                  <option value="45" selected>–¢–∞–π–º–∞—É—Ç: 45 —Å–µ–∫</option>
                  <option value="90">–¢–∞–π–º–∞—É—Ç: 90 —Å–µ–∫</option>
                  <option value="180">–¢–∞–π–º–∞—É—Ç: 180 —Å–µ–∫</option>
                </select>
                <button class="btn primary" id="nodeSshRunSingle">–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –Ω–æ–¥–µ</button>
                <button class="btn" id="nodeSshSingleClear">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–≤–æ–¥</button>
              </div>
              <p class="nodeops-summary" id="nodeSshSingleHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª.</p>
            </div>
            <div class="panel nodeops-panel-hide" id="nodeSshMultiPanel">
              <h3>–ö–æ–º–∞–Ω–¥–∞ (–º–∞—Å—Å–æ–≤–æ)</h3>
              <textarea id="nodeSshCommand" class="nodeops-cmd" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: sudo systemctl status xray --no-pager"></textarea>
              <div class="nodeops-runbar" style="margin-top:10px">
                <select id="nodeSshTimeout" class="select">
                  <option value="20">–¢–∞–π–º–∞—É—Ç: 20 —Å–µ–∫</option>
                  <option value="45" selected>–¢–∞–π–º–∞—É—Ç: 45 —Å–µ–∫</option>
                  <option value="90">–¢–∞–π–º–∞—É—Ç: 90 —Å–µ–∫</option>
                  <option value="180">–¢–∞–π–º–∞—É—Ç: 180 —Å–µ–∫</option>
                </select>
                <button class="btn primary" id="nodeSshRun">–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
                <button class="btn primary" id="nodeSshRunAll" style="background:linear-gradient(135deg,#8b5cf6,#1ad5f0)">‚ö° –í—Å–µ –Ω–æ–¥—ã</button>
                <button class="btn" id="nodeSshOutputClear">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–≤–æ–¥</button>
              </div>
              <p class="nodeops-summary" id="nodeSshSummary">–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é.</p>
            </div>
            <div class="panel">
              <h3 id="nodeSshOutputTitle">–¢–µ—Ä–º–∏–Ω–∞–ª</h3>
              <div id="nodeSshOutput" class="term-wrap">
                <div class="term-empty">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- NODE CREDENTIALS MODAL -->
      <div id="credModalShell" class="cred-modal-shell">
        <div class="cred-modal-backdrop" id="credModalBackdrop"></div>
        <div class="cred-modal">
          <div class="cred-modal-head">
            <div>
              <h3 class="cred-modal-title" id="credModalTitle">SSH-—É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
              <p class="cred-modal-sub" id="credModalSub"></p>
            </div>
            <button class="cred-modal-close" id="credModalClose">‚úï</button>
          </div>
          <div class="cred-field">
            <label for="credUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <input id="credUser" class="input" type="text" placeholder="root" autocomplete="off" spellcheck="false">
          </div>
          <div class="cred-field">
            <label for="credPassword">–ü–∞—Ä–æ–ª—å</label>
            <div class="cred-pw-wrap">
              <input id="credPassword" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å SSH" autocomplete="new-password">
              <button class="cred-pw-toggle" id="credPwToggle" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
            </div>
          </div>
          <div class="cred-field">
            <label for="credPrivateKey">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea id="credPrivateKey" class="input cred-key-input" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" spellcheck="false"></textarea>
            <p class="cred-hint">–î–ª—è key-only –Ω–æ–¥ —É–∫–∞–∂–∏—Ç–µ user –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á. –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å.</p>
          </div>
          <div class="cred-modal-actions">
            <button class="btn primary" id="credSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" id="credOpenTermBtn" style="background:linear-gradient(135deg,#1a2e50,#0f2040);border-color:rgba(26,213,240,.3)">‚ñ∂ –¢–µ—Ä–º–∏–Ω–∞–ª</button>
            <button class="btn danger" id="credDeleteBtn" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
            <button class="btn" id="credCancelBtn">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>

      <!-- SSH TERMINAL -->
      <section id="p-sshterm" class="page">
        <div class="section-head">
          <div><h2>SSH –¢–µ—Ä–º–∏–Ω–∞–ª</h2><p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p></div>
        </div>
        <div class="sshterm-toolbar">
          <select id="sstNodeSelect" class="select"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–¥—É ‚Äî</option></select>
          <button class="btn primary" id="sstConnect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
          <button class="btn" id="sstDisconnectAll">–ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ</button>
          <span id="sstStatus" style="font-size:12px;color:#7a9bc5"></span>
        </div>
        <div class="sshterm-tabs" id="sstTabs"></div>
        <div class="sshterm-panel" id="sstPanel">
          <div class="sshterm-empty-state" id="sstEmptyState">
            <div class="sst-icon">‚ñ∂</div>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–¥—É –∏ –Ω–∞–∂–º–∏—Ç–µ <b>–ü–æ–¥–∫–ª—é—á–∏—Ç—å</b></p>
            <p style="font-size:12px;color:#3d5880">–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã credentials ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚öô –≤ —Ä–∞–∑–¥–µ–ª–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏</p>
          </div>
        </div>
      </section>

      <!-- PERMANENT BAN -->
      <section id="p-permanent-ban" class="page"><div class="section-head"><div><h2>–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω</h2><p>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π —à–∞—Ä–∏–Ω–≥ —Å –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π</p></div></div><div class="table-wrap"><table><thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>IP</th><th>–õ–∏–º–∏—Ç</th><th>–¢—Ä–∏–≥–≥–µ—Ä—ã</th><th>–ù–æ–¥—ã</th><th>–ù–∞–≤—Å–µ–≥–¥–∞ —Å</th></tr></thead><tbody id="tbPermBan"></tbody></table></div></section>

      <!-- NETWORK STATS -->
      <section id="p-net" class="page"><div class="section-head"><div><h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ—Ç—è–º</h2><p>–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: mobile / wifi / cable</p></div></div><div class="table-wrap"><table><thead><tr><th>–¢–∏–ø —Å–µ—Ç–∏</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th><th>IP</th><th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã</th><th>–ü—Ä–∏–º–µ—Ä—ã IP</th></tr></thead><tbody id="tbNet"></tbody></table></div></section>

      <!-- SHARED IPS -->
      <section id="p-shared" class="page"><div class="section-head"><div><h2>–û–±—â–∏–µ IP</h2><p>IP, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p></div></div><div class="table-wrap"><table><thead><tr><th>IP</th><th>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–π</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th></tr></thead><tbody id="tbShared"></tbody></table></div></section>

      <!-- LOGS -->
      <section id="p-logs" class="page">
        <div class="section-head"><div><h2>–õ–æ–≥–∏</h2><p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</p></div></div>
        <div class="log-filter sticky-toolbar">
          <span class="lf-label">–§–∏–ª—å—Ç—Ä:</span>
          <label><input type="checkbox" class="lf-cb" data-cat="block" checked>BLOCK</label>
          <label><input type="checkbox" class="lf-cb" data-cat="violation" checked>VIOLATION</label>
          <label><input type="checkbox" class="lf-cb" data-cat="pending" checked>PENDING</label>
          <label><input type="checkbox" class="lf-cb" data-cat="info" checked>INFO</label>
        </div>
        <div class="table-wrap"><table><thead><tr><th>–í—Ä–µ–º—è</th><th>Email</th><th>–¢–∏–ø</th><th>IP</th><th>–ù–æ–¥–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th></tr></thead><tbody id="tbLogs"></tbody></table></div>
      </section>

      <!-- HWID -->
      <section id="p-hwid" class="page"><div class="section-head"><div><h2>HWID –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h2><p>–û—Ü–µ–Ω–∫–∞ –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º IP –ø—Ä–æ—Ç–∏–≤ –ª–∏–º–∏—Ç–æ–≤</p></div></div><div class="table-wrap"><table><thead><tr><th>Email</th><th>–í —Å–∏—Å—Ç–µ–º–µ</th><th>–õ–∏–º–∏—Ç</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody id="tbHwid"></tbody></table></div></section>

      <!-- SETTINGS -->
      <section id="p-settings" class="page">
        <div class="section-head"><div><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><p>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</p></div></div>
        <div class="panel" style="margin-bottom:14px">
          <h3>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
          <div class="toolbar">
            <input id="curPass" type="password" class="input" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
            <input id="newPass" type="password" class="input" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 8)">
            <input id="newPass2" type="password" class="input" placeholder="–ü–æ–≤—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è">
            <button class="btn primary" id="changePassBtn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
          </div>
          <p id="passMsg" class="muted"></p>
        </div>
        <div class="panel" style="margin-bottom:14px">
          <h3>Runtime overrides</h3>
          <p class="muted" style="margin:8px 0 12px">–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis.</p>
          <div id="cfgEditor"><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞...</p></div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" id="saveOverridesBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
            <button class="btn" id="resetOverridesBtn">–°–±—Ä–æ—Å–∏—Ç—å overrides</button>
          </div>
          <p id="runtimeCfgMsg" class="muted"></p>
        </div>
        <div class="panel">
          <h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã <span style="font-size:12px;color:var(--muted);font-weight:600">(effective)</span></h3>
          <div id="cfgPanel"><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
        </div>
      </section>

    </main>
  </div>

  <div id="auth" class="auth active"><div class="login"><h2 style="margin:0;font-family:Sora,sans-serif;font-size:26px">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å</h2><p class="muted" style="margin:8px 0 14px">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p><input id="loginPass" type="password" class="input" style="width:100%" placeholder="–ü–∞—Ä–æ–ª—å"><div style="display:flex;gap:8px;margin-top:12px"><button class="btn primary" id="loginBtn">–í–æ–π—Ç–∏</button></div><p id="authMsg" class="muted"></p></div></div>
  <div id="modal" class="modal"><div class="box"><button class="close" id="closeM">–ó–∞–∫—Ä—ã—Ç—å</button><h2 id="mTitle" style="margin:2px 0 12px;font-family:Sora,sans-serif">–ö–∞—Ä—Ç–æ—á–∫–∞</h2><div id="mBody"></div></div></div>
  <div id="confirmModal" class="auth">
    <div class="confirm-card">
      <h3 id="confirmTitle" class="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
      <p id="confirmSub" class="confirm-sub">–ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</p>
      <input id="confirmReason" class="input" style="width:100%" placeholder="manual">
      <div class="confirm-actions">
        <button class="btn" id="confirmCancel">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button class="btn primary" id="confirmOk">–î–ê</button>
      </div>
    </div>
  </div>
  <div id="nodeDrawer" class="drawer-shell">
    <div id="nodeDrawerBackdrop" class="drawer-backdrop"></div>
    <aside class="drawer-panel">
      <div class="drawer-head">
        <div>
          <h3 class="drawer-title" id="nodeDrawerTitle">–ù–æ–¥–∞</h3>
          <p class="drawer-sub" id="nodeDrawerSub">–¥–µ—Ç–∞–ª–∏</p>
        </div>
        <button type="button" class="btn" id="nodeDrawerClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="nodeDrawerBody" class="drawer-body"></div>
    </aside>
  </div>
  <div id="notice" class="notice"></div>

  <script>
    let stats={}, users=[], nodes=[], logs=[], activeBans=[], sharingBanUsers=[], permanentSharers=[], nodeHealth=[], networkTypes=[], cfgData={}, sysinfo={}, trafficData={rows:[],summary:{},filters:{},meta:{}};
    let usersPage = 0;
    const USERS_PAGE_SIZE = 50;
    let trafficPeriod = "30d";
    let chartStatus=null, chartNetwork=null, chartNodes=null;
    let loadInFlight = false;
    let openCardId = null;  // ID –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –≤ –º–æ–¥–∞–ª–µ (null = –∑–∞–∫—Ä—ã—Ç–∞)
    // WebSocket
    let wsConn = null;
    let wsReconnectTimer = null;
    let wsReconnectDelay = 1000;
    let wsFailCount = 0;
    let lastWsMessageAt = 0;
    let wsShouldReconnect = false;
    // Polling fallback (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ WS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
    let autoRefreshTimer = null;
    const autoRefreshMs = 10000;
    let violatorSel = new Set();
    let banSel = new Set();
    let usersSel = new Set();
    const TREND_MAX_POINTS = 60;
    const trendHistory = { timestamps: [], activeUsers: [], violators: [], bans: [] };
    let chartTrend = null;
    const logFilters = new Set(['block','violation','pending','info']);
    const prevStatVals = {};
    const BAN_SPIKE_THRESHOLD = 3;
    const QUEUE_SPIKE_THRESHOLD = 15;
    const QUEUE_HIGH_THRESHOLD = 80;
    const ALERT_HISTORY_SIZE = 20;
    const alertHistory = { bans: [], queue: [] };
    let apiHealth = { down: false, since: 0, message: "" };
    let nodeDrawerRef = "";
    let nodeSshSelection = new Set();
    let nodeSshActiveKey = "";
    let nodeSshLastResults = [];
    let nodeSshRunning = false;
    let nodeSshLiveExecId = "";
    let nodeSshLiveHeader = "";
    let nodeSshLiveNodes = {};
    let nodeSshCreds = {};   // nodeKey -> {user, has_password, has_private_key}
    let _sshLiveRafId = 0;   // rAF handle for debounced SSH live render
    let _nodeFilterKey = "";  // cache key for renderNodeFilters
    let credModalNodeKey = "";
    let ansiUp = null;
    const NODE_TREND_WINDOW_MS = 60 * 60 * 1000;
    const NODE_TREND_MAX_POINTS = 360;
    const nodeTrendHistory = new Map();
    const DASHBOARD_NODES_LIMIT = 4;
    let dashboardNodesExpanded = false;
    const TABLE_SKELETON_LAYOUT = {
      tbHotUsers: 7,
      tbUsers: 11,
      tbTraffic: 12,
      tbViolators: 7,
      tbBan: 7,
      tbActiveBans: 6,
      tbPermBan: 6,
      tbNet: 5,
      tbShared: 3,
      tbLogs: 6,
      tbHwid: 4
    };
    const CONFIG_EDIT_SCHEMA = [
      {
        key:"max_ips_per_user", label:"–ú–∞–∫—Å. IP –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", type:"int", min:1, max:100,
        help:"–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ IP –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.",
        note:"–£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∞—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å.",
        example:"–ü—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏–∏ 12 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å 8 IP —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ; 13-–π IP –Ω–∞—á–∏–Ω–∞–µ—Ç –∫–æ–ø–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã.",
        placeholder:"12"
      },
      {
        key:"block_duration", label:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏", type:"duration",
        help:"–í—Ä–µ–º—è –±–∞–∑–æ–≤–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP –ø–æ—Å–ª–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç—ã.",
        note:"–ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ—â–∞–µ—Ç, –¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫ –∂–µ—Å—Ç—á–µ —Ä–µ–∂–µ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.",
        example:"5m: IP –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç –∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
        placeholder:"5m"
      },
      {
        key:"user_ip_ttl_seconds", label:"TTL IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–µ–∫)", type:"int", min:1,
        help:"–°–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ IP —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ runtime –±–µ–∑ –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
        note:"–ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ, –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç; —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ - —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ IP –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ–ª—å—à–µ.",
        example:"1200: –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π IP —É–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ 20 –º–∏–Ω—É—Ç.",
        placeholder:"1200"
      },
      {
        key:"clear_ips_delay_seconds", label:"–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—á–∏—Å—Ç–∫–∏ IP (—Å–µ–∫)", type:"int", min:1,
        help:"–ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π IP –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Å–æ–±—ã—Ç–∏—è.",
        note:"–ü–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫, –∫–æ–≥–¥–∞ –ª–æ–≥ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ—á—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.",
        example:"900: –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç.",
        placeholder:"900"
      },
      {
        key:"sharing_detection_enabled", label:"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —à–∞—Ä–∏–Ω–≥–∞", type:"bool",
        help:"–ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤—Å–µ–π –∞–Ω—Ç–∏-—à–∞—Ä–∏–Ω–≥ –ª–æ–≥–∏–∫–∏.",
        note:"–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ —à–∞—Ä–∏–Ω–≥—É –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–∫–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞.",
        placeholder:""
      },
      {
        key:"trigger_count", label:"–ü–æ—Ä–æ–≥ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤", type:"int", min:1, max:100,
        help:"–°–∫–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –Ω—É–∂–Ω–æ –¥–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è.",
        note:"–ú–µ–Ω—å—à–µ —á–∏—Å–ª–æ - –±—ã—Å—Ç—Ä–µ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ, –±–æ–ª—å—à–µ —á–∏—Å–ª–æ - –º—è–≥—á–µ –ø–æ–ª–∏—Ç–∏–∫–∞.",
        example:"3: –ø–æ—Å–ª–µ —Ç—Ä–µ—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –≤ –æ–∫–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–º.",
        placeholder:"3"
      },
      {
        key:"trigger_period_seconds", label:"–ü–µ—Ä–∏–æ–¥ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (—Å–µ–∫)", type:"int", min:1,
        help:"–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä—ã.",
        note:"–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–∫–Ω–∞ –¥–µ–ª–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É —Å—Ç—Ä–æ–∂–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª—å—à–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.",
        example:"3600: —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å.",
        placeholder:"3600"
      },
      {
        key:"trigger_min_interval_seconds", label:"–ú–∏–Ω. –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (—Å–µ–∫)", type:"int", min:1,
        help:"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏.",
        note:"–ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–µ–π, –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤—Å–ø–ª–µ—Å–∫ –ª–æ–≥–æ–≤ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–∞—á–∫–æ–π.",
        example:"150: –≤—Ç–æ—Ä–æ–π —Ç—Ä–∏–≥–≥–µ—Ä —Ä–∞–Ω—å—à–µ —á–µ–º —á–µ—Ä–µ–∑ 150 —Å–µ–∫—É–Ω–¥ –Ω–µ –±—É–¥–µ—Ç –∑–∞—Å—á–∏—Ç–∞–Ω.",
        placeholder:"150"
      },
      {
        key:"sharing_sustain_seconds", label:"Sustain —à–∞—Ä–∏–Ω–≥–∞ (—Å–µ–∫)", type:"int", min:1,
        help:"–°–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å—Å—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ.",
        note:"–§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–∫–∞—á–∫–∏ –∏ –ª–æ–∂–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏.",
        example:"50: –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–µ—Ä–∂–∏—Ç—Å—è –º–µ–Ω—å—à–µ 50 —Å–µ–∫—É–Ω–¥, –æ–Ω–æ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤—ã–º.",
        placeholder:"50"
      },
      {
        key:"banlist_threshold_seconds", label:"–ü–æ—Ä–æ–≥ –¥–ª—è –±–∞–Ω-–ª–∏—Å—Ç–∞ (—Å–µ–∫)", type:"int", min:1,
        help:"–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –±–∞–Ω-–ª–∏—Å—Ç.",
        note:"–û–±—ã—á–Ω–æ —Å—Ç–∞–≤—è—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –±–æ–ª—å—à–µ, —á–µ–º sustain, —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö.",
        example:"1800: –≤ –±–∞–Ω-–ª–∏—Å—Ç –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å—Ç–æ–π—á–∏–≤–æ–º –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –æ–∫–æ–ª–æ 30 –º–∏–Ω—É—Ç.",
        placeholder:"1800"
      },
      {
        key:"sharing_source_window_seconds", label:"–û–∫–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —à–∞—Ä–∏–Ω–≥–∞ (—Å–µ–∫)", type:"int", min:1,
        help:"–ó–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–∏ IP –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —à–∞—Ä–∏–Ω–≥–∞.",
        note:"–°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —à—É–º.",
        example:"180: —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–∏–Ω—É—Ç—ã.",
        placeholder:"180"
      },
      {
        key:"subnet_grouping", label:"–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ /24", type:"bool",
        help:"–°—á–∏—Ç–∞–µ—Ç IP –∏–∑ –æ–¥–Ω–æ–π /24 –ø–æ–¥—Å–µ—Ç–∏ –±–ª–∏–∂–µ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É.",
        note:"–ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å —á–∞—Å—Ç–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π –∞–¥—Ä–µ—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –ø–æ–¥—Å–µ—Ç–∏.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: 10.10.10.5 –∏ 10.10.10.200 —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –º—è–≥—á–µ, —á–µ–º IP –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç–µ–π.",
        placeholder:""
      },
      {
        key:"sharing_block_on_banlist_only", label:"–ë–ª–æ–∫ —Ç–æ–ª—å–∫–æ –ø–æ –±–∞–Ω-–ª–∏—Å—Ç—É", type:"bool",
        help:"–†–∞–∑—Ä–µ—à–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –±–∞–Ω-–ª–∏—Å—Ç.",
        note:"–°–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –±–∞–Ω–æ–≤ –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: –¥–æ –±–∞–Ω-–ª–∏—Å—Ç–∞ –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å.",
        placeholder:""
      },
      {
        key:"sharing_block_on_violator_only", label:"–ë–ª–æ–∫ —Ç–æ–ª—å–∫–æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π", type:"bool",
        help:"–ü—Ä–∏–º–µ–Ω—è–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è.",
        note:"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º—è–≥–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª–∏ –µ–¥–∏–Ω–∏—á–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏.",
        placeholder:""
      },
      {
        key:"sharing_hardware_guard", label:"Hardware Guard", type:"bool",
        help:"–£—á–∏—Ç—ã–≤–∞–µ—Ç HWID/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.",
        note:"–û—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç IP, –Ω–æ —Å–∏–¥–∏—Ç —Å –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π HWID —É–º–µ–Ω—å—à–∞–µ—Ç —à–∞–Ω—Å –ª–æ–∂–Ω–æ–≥–æ –±–∞–Ω–∞.",
        placeholder:""
      },
      {
        key:"sharing_permanent_ban_enabled", label:"–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω (—à–∞—Ä–∏–Ω–≥)", type:"bool",
        help:"–†–∞–∑—Ä–µ—à–∞–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–∞–Ω –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è–º.",
        note:"–í–∫–ª—é—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Ä–∞–±–æ—Ç–µ –∞–ø–µ–ª–ª—è—Ü–∏–π.",
        example:"–í—ã–∫–ª—é—á–µ–Ω–æ: –¥–∞–∂–µ —Ç—è–∂–µ–ª—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.",
        placeholder:""
      },
      {
        key:"sharing_permanent_ban_duration", label:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–º. –±–∞–Ω–∞", type:"duration",
        help:"–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –±–∞–Ω–∞.",
        note:"–û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ permanent; –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫ –≤–º–µ—Å—Ç–æ –≤–µ—á–Ω–æ–≥–æ.",
        example:"permanent: –±–∞–Ω –±–µ–∑ —Å—Ä–æ–∫–∞; 30d: –¥–ª–∏–Ω–Ω—ã–π, –Ω–æ –æ–±—Ä–∞—Ç–∏–º—ã–π –±–∞–Ω.",
        placeholder:"permanent"
      },
      {
        key:"ban_escalation_enabled", label:"–≠—Å–∫–∞–ª–∞—Ü–∏—è –±–∞–Ω–æ–≤", type:"bool",
        help:"–ö–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –±–∞–Ω –¥–µ–ª–∞–µ—Ç –¥–ª–∏–Ω–Ω–µ–µ –ø–æ –ª–µ—Å—Ç–Ω–∏—Ü–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π.",
        note:"–ü–æ–º–æ–≥–∞–µ—Ç –º—è–≥–∫–æ –Ω–∞–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç –∏ –∂–µ—Å—Ç–∫–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: 1-–π –±–∞–Ω 1h, 2-–π 6h, 3-–π 24h.",
        placeholder:""
      },
      {
        key:"ban_escalation_durations", label:"–°—Ç—É–ø–µ–Ω–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏", type:"list",
        help:"–°–ø–∏—Å–æ–∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –±–∞–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.",
        note:"–ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: –ø–µ—Ä–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –±–∞–Ω–∞, –≤—Ç–æ—Ä–∞—è –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.",
        example:"1h, 6h, 24h, permanent: –ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–±—ã—á–Ω–æ –±–µ—Ä–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥.",
        placeholder:"1h, 6h, 24h, permanent"
      },
      {
        key:"geo_sharing_enabled", label:"–ì–µ–æ-—à–∞—Ä–∏–Ω–≥", type:"bool",
        help:"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω.",
        note:"–¢—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–µ–æ –ø–æ IP, –∏–Ω–∞—á–µ –±—É–¥—É—Ç false-positive.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏–∑ –ì–µ—Ä–º–∞–Ω–∏–∏ –∏ –ë—Ä–∞–∑–∏–ª–∏–∏ –º–æ–≥—É—Ç –¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä.",
        placeholder:""
      },
      {
        key:"geo_sharing_min_countries", label:"–ú–∏–Ω. —Å—Ç—Ä–∞–Ω –¥–ª—è –≥–µ–æ-–±–∞–Ω–∞", type:"int", min:1,
        help:"–°–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –¥–ª—è –≥–µ–æ-—Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è.",
        note:"–ú–∏–Ω–∏–º—É–º 2 –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ; –≤—ã—à–µ - –º—è–≥—á–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.",
        example:"2: –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∏–¥–Ω–æ 2 —Å—Ç—Ä–∞–Ω—ã, —É—Å–ª–æ–≤–∏–µ –≥–µ–æ-—à–∞—Ä–∏–Ω–≥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.",
        placeholder:"2"
      },
      {
        key:"network_policy_enabled", label:"–ü–æ–ª–∏—Ç–∏–∫–∞ —Å–µ—Ç–∏", type:"bool",
        help:"–£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∏–ø —Å–µ—Ç–∏ (mobile/wifi/cable/unknown) –≤ –∞–Ω—Ç–∏-—à–∞—Ä–∏–Ω–≥ —Ä–µ—à–µ–Ω–∏—è—Ö.",
        note:"–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –º—è–≥–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: –¥–ª—è mobile –º–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –±–æ–ª—å—à–µ IP, —á–µ–º –¥–ª—è cable.",
        placeholder:""
      },
      {
        key:"network_mobile_grace_ips", label:"Grace IP –¥–ª—è mobile", type:"int", min:0,
        help:"–°–∫–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö IP —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –º–æ–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏.",
        note:"–ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç–æ–π —Å–º–µ–Ω–µ NAT/CGNAT —É –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.",
        example:"1: –ø—Ä–∏ –±–∞–∑–æ–≤–æ–º –ª–∏–º–∏—Ç–µ 2, –¥–ª—è mobile —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–æ 3 IP.",
        placeholder:"1"
      },
      {
        key:"network_force_block_excess_ips", label:"–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ (IP)", type:"int", min:0,
        help:"–ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–ª–æ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∂–µ—Å—Ç–∫–∏–π –±–ª–æ–∫.",
        note:"0 –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞.",
        example:"3: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç —Å—Ä–∞–∑—É –Ω–∞ 3 IP, –±–ª–æ–∫ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –±–µ–∑ —Å–º—è–≥—á–µ–Ω–∏–π.",
        placeholder:"3"
      },
      {
        key:"heuristics_enabled", label:"Heuristics", type:"bool",
        help:"–í–∫–ª—é—á–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ç–∏–≤ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π.",
        note:"–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ—Ä–∂–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –≤ –±–æ—é.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –±–∞–Ω–æ–º.",
        placeholder:""
      },
      {
        key:"heuristics_window_seconds", label:"–û–∫–Ω–æ heuristics (—Å–µ–∫)", type:"int", min:1,
        help:"–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.",
        note:"–°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ —à—É–º–∏—Ç, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏—é –º–µ–¥–ª–µ–Ω–Ω–æ–π.",
        example:"120: —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
        placeholder:"120"
      },
      {
        key:"node_heartbeat_timeout_seconds", label:"–¢–∞–π–º–∞—É—Ç heartbeat –Ω–æ–¥—ã (—Å–µ–∫)", type:"int", min:1,
        help:"–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –±–µ–∑ heartbeat –Ω–æ–¥–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è offline.",
        note:"–°—Ç–∞–≤—å—Ç–µ —á—É—Ç—å –≤—ã—à–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ heartbeat, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å –ª–æ–∂–Ω—ã–π offline.",
        example:"120: –µ—Å–ª–∏ 2 –º–∏–Ω—É—Ç—ã –Ω–µ—Ç heartbeat, –Ω–æ–¥–∞ —Å—Ç–∞–Ω–µ—Ç offline –≤ –ø–∞–Ω–µ–ª–∏.",
        placeholder:"120"
      },
      {
        key:"prometheus_enabled", label:"Prometheus –º–µ—Ç—Ä–∏–∫–∏", type:"bool",
        help:"–í–∫–ª—é—á–∞–µ—Ç –æ—Ç–¥–∞—á—É –º–µ—Ç—Ä–∏–∫ –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ /metrics.",
        note:"–í–∫–ª—é—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤–Ω–µ—à–Ω–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.",
        example:"–í–∫–ª—é—á–µ–Ω–æ: Prometheus –º–æ–∂–µ—Ç —Å–∫—Ä–µ–π–ø–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã.",
        placeholder:""
      }
    ];

    const $ = id => document.getElementById(id);
    const esc = s => String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    const normNodeKey = v => String(v || "").trim().toLowerCase();
    const semanticBadge = (kind, text, extra="") => `<span class="badge st-${kind}${extra ? ` ${extra}` : ""}">${esc(text)}</span>`;
    const netTypeName = t => { const tp=String(t||"unknown").toLowerCase(); if(tp==="mobile")return"–°–æ—Ç–æ–≤—ã–π"; if(tp==="wifi")return"Wi-Fi"; if(tp==="cable")return"–ö–∞–±–µ–ª—å–Ω—ã–π"; return"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"; };
    const isBadDate = d => Number.isNaN(d.getTime()) || d.getUTCFullYear() < 2000 || d.getTime() > Date.now() + 5*60*1000;
    const api = async (url, opts={}) => {
      const { headers: extraHeaders = {}, ...restOpts } = opts || {};
      const r = await fetch(url,{
        credentials:"include",
        cache:"no-store",
        headers:{"Content-Type":"application/json",...extraHeaders},
        ...restOpts
      });
      if(!r.ok){
        let msg = `HTTP ${r.status}`;
        try{ const j=await r.json(); msg=j.error||j.message||msg; }catch{}
        throw new Error(msg);
      }
      if(r.status===204) return null;
      return r.json();
    };

    const showNotice = (message, kind="ok") => {
      const n = $("notice");
      if(!n) return;
      n.textContent = String(message || "");
      n.className = `notice ${kind} show`;
      clearTimeout(showNotice.timer);
      showNotice.timer = setTimeout(()=>n.classList.remove("show"), 2800);
    };
    const progressBar = {
      _tmr: null,
      start(){ const el=$("progressTop"); if(!el) return; el.style.transition="none"; el.style.width="0"; el.style.opacity="1"; requestAnimationFrame(()=>{ el.style.transition="width .6s ease"; el.style.width="70%"; }); },
      done(){ const el=$("progressTop"); if(!el) return; el.style.width="100%"; clearTimeout(this._tmr); this._tmr=setTimeout(()=>{ el.style.opacity="0"; setTimeout(()=>{ el.style.width="0"; el.style.opacity="1"; },300); },300); }
    };

    const countByTypes = (events, types) => {
      const set = new Set(types || []);
      return (events || []).filter(e => set.has(String(e?.type || ""))).length;
    };
    const t = s => {
      if(!s) return "-";
      const d = new Date(s);
      return isBadDate(d) ? "-" : d.toLocaleString("ru-RU");
    };
    const until = s => {
      if(!s) return "-";
      const d = new Date(s);
      if(isBadDate(d)) return "-";
      const sec = Math.max(0, Math.floor((d.getTime() - Date.now())/1000));
      if(sec === 0) return "–∏—Å—Ç—ë–∫";
      if(sec < 60) return `${sec} —Å–µ–∫`;
      const min = Math.floor(sec/60);
      if(min < 60) return `${min} –º–∏–Ω ${sec%60} —Å–µ–∫`;
      const hr = Math.floor(min/60);
      return `${hr} —á ${min%60} –º–∏–Ω`;
    };
    const pickValidTime = (...values) => {
      for (const v of values) {
        if (!v) continue;
        const d = new Date(v);
        if (!isBadDate(d)) return v;
      }
      return "";
    };
    const rel = s => {
      if(!s) return "-";
      const d = new Date(s);
      if(isBadDate(d)) return "-";
      const sec = Math.max(0, Math.floor((Date.now() - d.getTime())/1000));
      if(sec < 60) return `${sec} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
      const min = Math.floor(sec/60);
      if(min < 60) return `${min} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      const hr = Math.floor(min/60);
      if(hr < 24) return `${hr} —á –Ω–∞–∑–∞–¥`;
      return `${Math.floor(hr/24)} –¥–Ω –Ω–∞–∑–∞–¥`;
    };
    const displayName = u => (u.username && String(u.username).trim()) ? String(u.username).trim() : String(u.user_identifier ?? "");
    const sub = ip => { const p=String(ip).split("."); return p.length===4?`${p[0]}.${p[1]}.${p[2]}.0/24`:ip; };
    const renderActivityBadge = online => online
      ? semanticBadge("online", "–û–Ω–ª–∞–π–Ω", "status-primary")
      : semanticBadge("offline", "–û—Ñ—Ñ–ª–∞–π–Ω", "status-primary");
    const emptyRow = (colspan, icon, title, sub="") =>
      `<tr><td colspan="${colspan}" class="tbl-empty"><span class="tbl-empty-icon">${icon}</span><p class="tbl-empty-title">${title}</p>${sub?`<p class="tbl-empty-sub">${sub}</p>`:""}</td></tr>`;
    const renderSafetyBadge = exceeds => exceeds
      ? semanticBadge("warn", "–ù–∞—Ä—É—à–µ–Ω–∏–µ", "status-primary")
      : semanticBadge("online", "–ù–æ—Ä–º–∞", "status-primary");
    const renderStatusBadge = u => {
      if (u && u.blocked) return semanticBadge("offline", "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", "status-primary");
      return renderSafetyBadge(!!u?.exceeds);
    };
    const renderUserCell = (userId, explicitName="") => {
      const id = String(userId ?? "").trim();
      const known = (users || []).find(u => String(u?.user_identifier ?? "") === id);
      const name = String(explicitName || (known ? displayName(known) : id || "-")).trim() || "-";
      const sub = id && name !== id ? id : (id && id !== "-" ? id : "");
      if (!id || id === "-") {
        return `<b>${esc(name)}</b>${sub ? `<div class="muted" style="font-size:12px">${esc(sub)}</div>` : ""}`;
      }
      return `<div class="user-open-link" data-u="${esc(id)}"><b>${esc(name)}</b>${sub ? `<div class="muted" style="font-size:12px">${esc(sub)}</div>` : ""}</div>`;
    };
    const bindUserOpenLinks = (rootEl) => {
      if(!rootEl) return;
      rootEl.querySelectorAll(".user-open-link[data-u]").forEach(el=>{
        el.onclick = (e)=>{
          e.preventDefault();
          e.stopPropagation();
          const id = String(el.dataset.u || "").trim();
          if(id) openUser(id);
        };
      });
    };
    function skelCell(width="70%"){
      return `<span class="skel skel-line" style="width:${width}"></span>`;
    }

    function renderTableSkeleton(id, cols, rows=6){
      const el = $(id);
      if(!el) return;
      el.innerHTML = Array.from({length: rows}, (_,r)=>`<tr class="skel-row">${
        Array.from({length: cols}, (_,c)=>`<td>${skelCell(c===0 ? "58%" : (c%2===0 ? "72%" : "46%"))}</td>`).join("")
      }</tr>`).join("");
    }

    function showLoadingSkeletons(){
      ["kUsers","kActive","kViolators","kBanned","kNodes","kQueue"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.textContent = "";
        el.classList.add("skel","skel-num");
      });
      const sum = $("nodesSummaryHint");
      if(sum){
        sum.textContent = "";
        sum.classList.add("skel","skel-line");
      }
      ["nodesOnlineCount","nodesOfflineCount"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.textContent = "";
        el.classList.add("skel","skel-line");
      });
      const nodesCards = $("nodesCards");
      if(nodesCards){
        nodesCards.innerHTML = Array.from({length: 4}, ()=>`<article class="node-card skel"><div class="node-head"><div class="node-ident">${skelCell("76px")}</div>${skelCell("60px")}</div><div class="node-kpis"><div class="node-kpi">${skelCell("48px")}${skelCell("50px")}</div><div class="node-kpi">${skelCell("48px")}${skelCell("50px")}</div></div><div class="node-spark-empty skel">${skelCell("60%")}</div><div class="node-foot">${skelCell("100px")}${skelCell("56px")}</div></article>`).join("");
      }
      Object.entries(TABLE_SKELETON_LAYOUT).forEach(([id, cols])=>renderTableSkeleton(id, cols));
    }

    function clearLoadingSkeletons(){
      document.querySelectorAll(".skel-num").forEach(el=>el.classList.remove("skel","skel-num"));
      document.querySelectorAll("#nodesSummaryHint, #nodesOnlineCount, #nodesOfflineCount").forEach(el=>el.classList.remove("skel","skel-line"));
    }

    function updateNodeTrend(rows, onlineUsersByNode, trafficByNode){
      const now = Date.now();
      const cutoff = now - NODE_TREND_WINDOW_MS;
      const active = new Set();
      rows.forEach(r=>{
        const nodeLabel = resolveNodeLabel(r.node_name, r.node_id);
        const key = normNodeKey(nodeLabel);
        if(!key) return;
        active.add(key);
        const history = nodeTrendHistory.get(key) || [];
        const sample = {
          ts: now,
          online: Number(onlineUsersByNode.get(key) || 0),
          traffic: Number(trafficByNode.get(key) || 0)
        };
        const prev = history[history.length-1];
        if(!prev || (now - prev.ts) > 5000 || prev.online !== sample.online || prev.traffic !== sample.traffic){
          history.push(sample);
        }else{
          prev.ts = sample.ts;
          prev.online = sample.online;
          prev.traffic = sample.traffic;
        }
        while(history.length && history[0].ts < cutoff) history.shift();
        if(history.length > NODE_TREND_MAX_POINTS){
          history.splice(0, history.length - NODE_TREND_MAX_POINTS);
        }
        nodeTrendHistory.set(key, history);
      });
      for(const [key, history] of nodeTrendHistory.entries()){
        while(history.length && history[0].ts < cutoff) history.shift();
        if(!history.length){
          nodeTrendHistory.delete(key);
          continue;
        }
        if(!active.has(key) && (now - history[history.length-1].ts) > NODE_TREND_WINDOW_MS){
          nodeTrendHistory.delete(key);
        }
      }
    }

    function nodeSparklineHtml(nodeKey){
      const history = nodeTrendHistory.get(nodeKey) || [];
      if(history.length < 2){
        return `<div class="node-spark-empty">–°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞ 60 –º–∏–Ω—É—Ç...</div>`;
      }
      const w = 228, h = 48, pad = 3;
      const maxOnline = Math.max(1, ...history.map(p=>Number(p.online||0)));
      const maxTraffic = Math.max(1, ...history.map(p=>Number(p.traffic||0)));
      const toPolyline = (selector, maxVal) => history.map((p, i)=>{
        const x = pad + ((history.length === 1 ? 0 : i/(history.length-1)) * (w - pad*2));
        const y = h - pad - ((Number(selector(p)||0) / maxVal) * (h - pad*2));
        return `${x.toFixed(1)},${Math.max(pad,Math.min(h-pad,y)).toFixed(1)}`;
      }).join(" ");
      const lineTraffic = toPolyline(p=>p.traffic, maxTraffic);
      const lineOnline = toPolyline(p=>p.online, maxOnline);
      return `<div class="node-spark-wrap">
        <svg class="node-spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
          <polyline class="spark-line traffic" points="${lineTraffic}"></polyline>
          <polyline class="spark-line online" points="${lineOnline}"></polyline>
        </svg>
        <div class="node-spark-legend">
          <span class="node-spark-key"><i class="online"></i>–æ–Ω–ª–∞–π–Ω</span>
          <span class="node-spark-key"><i class="traffic"></i>—Ç—Ä–∞—Ñ–∏–∫</span>
          <span class="muted">60–º</span>
        </div>
      </div>`;
    }

    function animateStat(id, value) {
      const el = $(id);
      if (!el) return;
      el.classList.remove("skel","skel-num");
      const newVal = String(value);
      if (prevStatVals[id] !== undefined && prevStatVals[id] !== newVal) {
        el.animate(
          [{transform:'scale(1.18)',color:'#6daaff'},{transform:'scale(1)',color:''}],
          {duration:350, easing:'ease-out'}
        );
      }
      el.textContent = newVal;
      prevStatVals[id] = newVal;
    }

    function toggleSidebar(){
      const sidebar = $("sidebar");
      const app = $("appGrid");
      const btn = $("sidebarToggle");
      sidebar.classList.toggle('collapsed');
      app.classList.toggle('sidebar-collapsed');
      btn.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    }

    function globalSearch(){
      const q = $("globalSearch").value.trim().toLowerCase();
      if(!q) return;
      const found = (users||[]).find(u =>
        String(u.user_identifier||"").toLowerCase().includes(q) ||
        String(u.username||"").toLowerCase().includes(q)
      );
      if(found){
        openUser(found.user_identifier);
      } else {
        // try direct open by raw input
        openUser($("globalSearch").value.trim());
      }
      $("globalSearch").value = "";
    }

    async function askReason(title, subtitle, defaultReason=""){
      return new Promise(resolve => {
        const modal = $("confirmModal");
        const input = $("confirmReason");
        const okBtn = $("confirmOk");
        const cancelBtn = $("confirmCancel");
        $("confirmTitle").textContent = title;
        $("confirmSub").textContent = subtitle;
        input.value = defaultReason;
        const close = (value) => {
          modal.classList.remove("active");
          okBtn.onclick = null;
          cancelBtn.onclick = null;
          modal.onclick = null;
          input.onkeydown = null;
          resolve(value);
        };
        okBtn.onclick = () => close(input.value.trim());
        cancelBtn.onclick = () => close(null);
        modal.onclick = (e) => { if (e.target === modal) close(null); };
        input.onkeydown = (e) => {
          if (e.key === "Enter") { e.preventDefault(); close(input.value.trim()); }
          if (e.key === "Escape") close(null);
        };
        modal.classList.add("active");
        setTimeout(()=>input.focus(), 0);
      });
    }

    function updateWsStatus(state){
      const dot=$('wsDot'), txt=$('wsText');
      if(!dot||!txt) return;
      if(state==='connected'){ dot.className='ws-dot'; txt.textContent='live'; dot.title='WebSocket –∞–∫—Ç–∏–≤–µ–Ω'; }
      else if(state==='reconnecting'){ dot.className='ws-dot warn'; txt.textContent='reconnect...'; dot.title='–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'; }
      else { dot.className='ws-dot err'; txt.textContent='polling'; dot.title='–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling'; }
    }

    function connectWS(){
      if(!wsShouldReconnect || wsConn) return;
      const proto = location.protocol==='https:' ? 'wss' : 'ws';
      wsConn = new WebSocket(`${proto}://${location.host}/api/ws`);
      wsConn.onopen = ()=>{ wsReconnectDelay=1000; wsFailCount=0; lastWsMessageAt=Date.now(); updateWsStatus('connected'); };
      wsConn.onmessage = (e)=>{
        lastWsMessageAt=Date.now();
        try{
          const m=JSON.parse(e.data);
          if(m.type==='refresh') liveRefresh();
          else if(m.type==='node_ssh_stream' || m.type==='node_ssh_stream_done') handleNodeSshWsEvent(m);
        }catch{}
      };
      wsConn.onclose = ()=>{
        wsConn=null;
        if(!wsShouldReconnect){
          updateWsStatus('polling');
          return;
        }
        wsFailCount++;
        updateWsStatus(wsFailCount>=3 ? 'polling' : 'reconnecting');
        if(wsReconnectTimer) clearTimeout(wsReconnectTimer);
        wsReconnectTimer=setTimeout(()=>{
          wsReconnectTimer=null;
          connectWS();
        }, wsReconnectDelay);
        wsReconnectDelay=Math.min(wsReconnectDelay*2,30000);
      };
      wsConn.onerror = ()=>{};
    }

    function startAutoRefresh(){
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(async () => {
        if (document.visibilityState !== "visible") return;
        if ($("auth").classList.contains("active")) return;
        const wsHealthy = wsConn && wsConn.readyState === WebSocket.OPEN && (Date.now() - lastWsMessageAt) < autoRefreshMs * 2;
        if (wsHealthy) return;
        await liveRefresh();
      }, autoRefreshMs);
    }

    function stopAutoRefresh(){
      if (!autoRefreshTimer) return;
      clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;
    }

    async function checkAuth(){
      try{
        await api("/api/panel/me");
        wsShouldReconnect = true;
        $("auth").classList.remove("active");
        await load(false);
        startAutoRefresh();
        connectWS();
      }catch{
        wsShouldReconnect = false;
        stopAutoRefresh();
        if(wsConn){ wsConn.close(); wsConn=null; }
        if(wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer=null; }
        $("auth").classList.add("active");
      }
    }

    async function login(){
      $("authMsg").textContent="";
      try{
        await api("/api/panel/login",{method:"POST",body:JSON.stringify({password:$("loginPass").value})});
        wsShouldReconnect = true;
        $("auth").classList.remove("active");
        await load(false);
        startAutoRefresh();
        connectWS();
      }catch{
        $("authMsg").textContent="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Ö–æ–¥–∞";
      }
    }

    async function logout(){
      try{ await api("/api/panel/logout",{method:"POST"}); }catch{}
      wsShouldReconnect = false;
      stopAutoRefresh();
      if(wsConn){ wsConn.close(); wsConn=null; }
      if(wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer=null; }
      $("auth").classList.add("active");
    }

    async function load(silent=false){
      if (loadInFlight) return;
      loadInFlight = true;
      if(!silent){
        showLoadingSkeletons();
        progressBar.start();
      }
      try{
        [stats, users, trafficData, nodes, logs, activeBans, sharingBanUsers, permanentSharers, nodeHealth, networkTypes, cfgData, sysinfo] = await Promise.all([
          api("/api/stats"),
          api("/api/users?limit=2000&panel_only=true"),
          api(`/api/traffic/users?period=${encodeURIComponent(trafficPeriod)}&online_only=true`).catch(()=>({rows:[],summary:{},filters:{},meta:{}})),
          api("/api/nodes").catch(()=>[]),
          api("/api/logs?limit=500").catch(()=>[]),
          api("/api/bans/active?limit=2000").catch(()=>[]),
          api("/api/banlist/users?limit=2000").catch(()=>[]),
          api("/api/sharing/permanent?limit=2000").catch(()=>[]),
          api("/api/nodes/health").catch(()=>[]),
          api("/api/networks/types").catch(()=>[]),
          api("/api/config").catch(()=>({})),
          api("/api/sysinfo").catch(()=>({}))
        ]);
        console.log("Loaded users:", users ? users.length : "null");
        if(users && users.length === 0) showNotice("–í–Ω–∏–º–∞–Ω–∏–µ: API –≤–µ—Ä–Ω—É–ª 0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "warn");
        if(trafficData && trafficData.meta && trafficData.meta.selected_period){
          trafficPeriod = String(trafficData.meta.selected_period || trafficPeriod);
        }
        markApiHealthy();
        render();
        if (openCardId && $("modal").classList.contains("active")) {
          refreshOpenCard();
        }
        if (nodeDrawerRef) {
          renderNodeDrawer(nodeDrawerRef, true);
        }
      }catch(e){
        markApiDown(e);
        if (!silent) showNotice("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API: "+e.message, "err");
      } finally {
        loadInFlight = false;
        if(!silent){
          clearLoadingSkeletons();
          progressBar.done();
        }
      }
    }

    async function liveRefresh(){
      if (loadInFlight) return;
      loadInFlight = true;
      try{
        const prev = {
          stats, users, trafficData, nodes, logs, activeBans, sharingBanUsers,
          permanentSharers, nodeHealth, networkTypes, sysinfo
        };
        const next = await Promise.all([
          api("/api/stats"),
          api("/api/users?limit=2000&panel_only=true"),
          api(`/api/traffic/users?period=${encodeURIComponent(trafficPeriod)}&online_only=true`).catch(()=>trafficData),
          api("/api/nodes").catch(()=>nodes),
          api("/api/logs?limit=500").catch(()=>logs),
          api("/api/bans/active?limit=2000").catch(()=>activeBans),
          api("/api/banlist/users?limit=2000").catch(()=>sharingBanUsers),
          api("/api/sharing/permanent?limit=2000").catch(()=>permanentSharers),
          api("/api/nodes/health").catch(()=>nodeHealth),
          api("/api/networks/types").catch(()=>networkTypes),
          api("/api/sysinfo").catch(()=>sysinfo)
        ]);

        [stats, users, trafficData, nodes, logs, activeBans, sharingBanUsers, permanentSharers, nodeHealth, networkTypes, sysinfo] = next;
        markApiHealthy();
        applyLivePatch(prev);
        if (openCardId && $("modal").classList.contains("active")) {
          refreshOpenCard();
        }
        if (nodeDrawerRef) {
          renderNodeDrawer(nodeDrawerRef, true);
        }
      }catch(e){
        markApiDown(e);
      } finally {
        loadInFlight = false;
      }
    }

    async function refreshOpenCard(){
      if (!openCardId) return;
      const box = $("modal").querySelector(".box");
      const scrollTop = box ? box.scrollTop : 0;
      await openUser(openCardId, true);
      if (box) box.scrollTop = scrollTop;
    }

    const fmtBytes = (b) => {
      if(!b) return "0 B";
      const units=["B","KB","MB","GB","TB","PB"];
      let i=0; b=Number(b);
      while(b>=1024&&i<units.length-1){b/=1024;i++;}
      return b.toFixed(i?1:0)+" "+units[i];
    };
    const barCls = (pct) => pct>=90?"crit":pct>=70?"warn":"ok";
    const sysBar = (pct) => {
      const p=Math.min(100,Math.max(0,pct));
      return `<div class="sys-bar"><div class="sys-bar-fill ${barCls(p)}" style="width:${p}%"></div></div>
              <div class="sys-bar-label"><span>${p.toFixed(1)}%</span></div>`;
    };

    function renderSysinfo(){
      const el=$("sysinfoBlock");
      if(!el||!sysinfo||!sysinfo.ram) return;
      const {go={},ram={},cpu={},uptime={},disk={},redis={}} = sysinfo;

      // RAM
      const ramTotal=Number(ram.total||0), ramUsed=Number(ram.used||0), ramAvail=Number(ram.available||0);
      const ramPct=ramTotal?ramUsed*100/ramTotal:0;
      const ramCard=`<div class="sys-card" style="--sys-accent:#12c9e8">
        <h4>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å</h4>
        ${sysBar(ramPct)}
        <div class="sys-row"><span>–í—Å–µ–≥–æ</span><b>${fmtBytes(ramTotal)}</b></div>
        <div class="sys-row"><span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</span><b>${fmtBytes(ramUsed)}</b></div>
        <div class="sys-row"><span>–î–æ—Å—Ç—É–ø–Ω–æ</span><b>${fmtBytes(ramAvail)}</b></div>
        <div class="sys-row"><span>–ö—ç—à</span><b>${fmtBytes(Number(ram.cached||0))}</b></div>
      </div>`;

      // Disk
      const dkTotal=Number(disk.total||0), dkUsed=Number(disk.used||0), dkAvail=Number(disk.avail||0);
      const dkPct=parseFloat(disk.used_pct||0);
      const diskCard=`<div class="sys-card" style="--sys-accent:#ffbe3b">
        <h4>–î–∏—Å–∫ /</h4>
        ${sysBar(dkPct)}
        <div class="sys-row"><span>–í—Å–µ–≥–æ</span><b>${fmtBytes(dkTotal)}</b></div>
        <div class="sys-row"><span>–ó–∞–Ω—è—Ç–æ</span><b>${fmtBytes(dkUsed)}</b></div>
        <div class="sys-row"><span>–°–≤–æ–±–æ–¥–Ω–æ</span><b>${fmtBytes(dkAvail)}</b></div>
        <div class="sys-row"><span>–ê–ø—Ç–∞–π–º</span><b>${uptime.uptime_human||"-"}</b></div>
      </div>`;

      // CPU / Load
      const cpuPct=Math.min(100, parseFloat(cpu.load1||0) / (go.num_cpu||1) * 100);
      const cpuCard=`<div class="sys-card" style="--sys-accent:#24c47a">
        <h4>CPU / –ù–∞–≥—Ä—É–∑–∫–∞</h4>
        ${sysBar(cpuPct)}
        <div class="sys-row"><span>–ù–∞–≥—Ä—É–∑–∫–∞ 1–º</span><b>${cpu.load1||"-"}</b></div>
        <div class="sys-row"><span>–ù–∞–≥—Ä—É–∑–∫–∞ 5–º</span><b>${cpu.load5||"-"}</b></div>
        <div class="sys-row"><span>–ù–∞–≥—Ä—É–∑–∫–∞ 15–º</span><b>${cpu.load15||"-"}</b></div>
        <div class="sys-row"><span>–Ø–¥–µ—Ä CPU</span><b>${go.num_cpu||"-"}</b></div>
        <div class="sys-row"><span>–ì–æ—Ä—É—Ç–∏–Ω—ã Go</span><b>${go.goroutines||0}</b></div>
        <div class="sys-row"><span>–í–µ—Ä—Å–∏—è Go</span><b>${go.go_version||"-"}</b></div>
      </div>`;

      // Go heap
      const heapUsed=Number(go.heap_inuse||0), heapSys=Number(go.heap_sys||0);
      const heapPct=heapSys?heapUsed*100/heapSys:0;
      const goCard=`<div class="sys-card" style="--sys-accent:#4f71ff">
        <h4>Go Runtime (heap)</h4>
        ${sysBar(heapPct)}
        <div class="sys-row"><span>Heap –∑–∞–Ω—è—Ç–æ</span><b>${fmtBytes(heapUsed)}</b></div>
        <div class="sys-row"><span>Heap –≤—ã–¥–µ–ª–µ–Ω–æ</span><b>${fmtBytes(Number(go.heap_alloc||0))}</b></div>
        <div class="sys-row"><span>Heap –≤—Å–µ–≥–æ</span><b>${fmtBytes(heapSys)}</b></div>
        <div class="sys-row"><span>–°—Ç–µ–∫</span><b>${fmtBytes(Number(go.stack_inuse||0))}</b></div>
        <div class="sys-row"><span>–ó–∞–ø—É—Å–∫–æ–≤ GC</span><b>${go.gc_runs||0}</b></div>
      </div>`;

      // Redis
      const rUsed=Number(redis.used_memory||0), rMax=Number(redis.maxmemory||0);
      const rPct=rMax?rUsed*100/rMax:0;
      const rPeak=Number(redis.used_memory_peak||0);
      const rClients=redis.connected_clients||"-";
      const rUptime=redis.uptime_in_seconds?formatSeconds(Number(redis.uptime_in_seconds)):"-";
      const rHits=Number(redis.keyspace_hits||0), rMisses=Number(redis.keyspace_misses||0);
      const rHitRate=rHits+rMisses>0?(rHits*100/(rHits+rMisses)).toFixed(1)+"%":"‚Äî";
      const redisCard=`<div class="sys-card" style="grid-column:1/-1;--sys-accent:#ff5477">
        <h4>Redis</h4>
        ${rMax?sysBar(rPct):""}
        <div class="sys-grid" style="margin-top:6px">
          <div>
            <div class="sys-row"><span>–ü–∞–º—è—Ç—å</span><b>${redis.used_memory_human||fmtBytes(rUsed)}</b></div>
            <div class="sys-row"><span>–ü–∏–∫ –ø–∞–º—è—Ç–∏</span><b>${redis.used_memory_peak_human||fmtBytes(rPeak)}</b></div>
            <div class="sys-row"><span>–õ–∏–º–∏—Ç</span><b>${rMax?fmtBytes(rMax):"–±–µ–∑ –ª–∏–º–∏—Ç–∞"}</b></div>
            <div class="sys-row"><span>–í–µ—Ä—Å–∏—è</span><b>${redis.redis_version||"-"}</b></div>
          </div>
          <div>
            <div class="sys-row"><span>–ö–ª–∏–µ–Ω—Ç—ã</span><b>${rClients}</b></div>
            <div class="sys-row"><span>–ê–ø—Ç–∞–π–º</span><b>${rUptime}</b></div>
            <div class="sys-row"><span>–ö–æ–º–∞–Ω–¥/—Å–µ–∫</span><b>${redis.instantaneous_ops_per_sec||"0"}</b></div>
            <div class="sys-row"><span>–ü–æ–ø–∞–¥–∞–Ω–∏–π</span><b>${rHitRate}</b></div>
          </div>
        </div>
      </div>`;

      el.innerHTML=`<div class="sys-grid">${ramCard}${diskCard}${cpuCard}${goCard}${redisCard}</div>`;
    }

    function formatSeconds(s){
      const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60);
      if(d>0) return d+"–¥ "+h+"—á "+m+"–º";
      if(h>0) return h+"—á "+m+"–º";
      return m+"–º";
    }

    function collectDashboardMeta(srcUsers=users, srcStats=stats, srcNodeHealth=nodeHealth){
      const safeUsers = Array.isArray(srcUsers) ? srcUsers : [];
      const safeNodeHealth = Array.isArray(srcNodeHealth) ? srcNodeHealth : [];
      const viol = safeUsers.filter(u=>u.exceeds);
      const ban = Array.isArray(sharingBanUsers) && sharingBanUsers.length > 0
        ? sharingBanUsers
        : (Array.isArray(activeBans) ? activeBans : []);
      const nodesSet = new Set(safeNodeHealth.map(n=>n.node_name).filter(Boolean));
      const online = safeUsers.filter(u=>u.online).length;
      const queueTotal = (srcStats.log_queue_len||0) + (srcStats.side_effect_queue_len||0);
      return {
        viol,
        banCount: Number(srcStats.sharing_banlist_users ?? ban.length ?? 0),
        onlineCount: online,
        nodeCount: nodesSet.size,
        queueTotal
      };
    }

    function applyDashboardMeta(meta){
      animateStat("kUsers", users.length);
      animateStat("kActive", meta.onlineCount);
      animateStat("kViolators", meta.viol.length);
      animateStat("kBanned", meta.banCount);
      animateStat("kNodes", meta.nodeCount);
      animateStat("kQueue", meta.queueTotal);
    }

    function rememberAlertSample(meta){
      const bansNow = Number(stats?.real_active_bans ?? stats?.sharing_banlist_users ?? meta?.banCount ?? 0);
      const queueNow = Number(meta?.queueTotal ?? 0);
      alertHistory.bans.push(bansNow);
      alertHistory.queue.push(queueNow);
      if(alertHistory.bans.length > ALERT_HISTORY_SIZE) alertHistory.bans.splice(0, alertHistory.bans.length - ALERT_HISTORY_SIZE);
      if(alertHistory.queue.length > ALERT_HISTORY_SIZE) alertHistory.queue.splice(0, alertHistory.queue.length - ALERT_HISTORY_SIZE);
    }

    function updateTrendSample(meta){
      const now = new Date();
      const label = now.toLocaleTimeString("ru-RU", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
      trendHistory.timestamps.push(label);
      trendHistory.activeUsers.push(meta.onlineCount || 0);
      trendHistory.violators.push(meta.viol ? meta.viol.length : 0);
      trendHistory.bans.push(meta.banCount || 0);
      if(trendHistory.timestamps.length > TREND_MAX_POINTS){
        trendHistory.timestamps.shift();
        trendHistory.activeUsers.shift();
        trendHistory.violators.shift();
        trendHistory.bans.shift();
      }
      const lbl = $("trendLabel");
      if(lbl) lbl.textContent = `–ø–æ—Å–ª–µ–¥–Ω–∏–µ ~${Math.round(trendHistory.timestamps.length * 10 / 60)} –º–∏–Ω`;
    }

    function buildAlerts(meta){
      const out = [];
      const now = new Date();

      if(apiHealth.down){
        out.push({
          level: "critical",
          title: "API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
          text: apiHealth.message || "–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å API.",
          time: apiHealth.since ? rel(new Date(apiHealth.since).toISOString()) : "—Å–µ–π—á–∞—Å"
        });
      }

      const offlineNodes = (Array.isArray(nodeHealth) ? nodeHealth : []).filter(n=>!n.online);
      if(offlineNodes.length > 0){
        const names = offlineNodes.slice(0, 4).map(n=>n.node_name || n.node_id).filter(Boolean);
        const extra = offlineNodes.length > names.length ? ` +${offlineNodes.length - names.length}` : "";
        out.push({
          level: "warn",
          title: "Offline –Ω–æ–¥—ã",
          text: `${offlineNodes.length} –Ω–æ–¥ –æ—Ñ—Ñ–ª–∞–π–Ω: ${names.join(", ")}${extra}`,
          time: rel(now.toISOString())
        });
      }

      if(alertHistory.bans.length >= 2){
        const prev = alertHistory.bans[alertHistory.bans.length - 2];
        const curr = alertHistory.bans[alertHistory.bans.length - 1];
        const diff = curr - prev;
        if(diff >= BAN_SPIKE_THRESHOLD){
          out.push({
            level: diff >= BAN_SPIKE_THRESHOLD * 2 ? "critical" : "warn",
            title: "–í—Å–ø–ª–µ—Å–∫ –±–∞–Ω–æ–≤",
            text: `–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–∞–Ω–æ–≤: ${curr} (—Ä–æ—Å—Ç +${diff} –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ü–∏–∫–ª).`,
            time: rel(now.toISOString())
          });
        }
      }

      if(alertHistory.queue.length >= 2){
        const prevQ = alertHistory.queue[alertHistory.queue.length - 2];
        const currQ = alertHistory.queue[alertHistory.queue.length - 1];
        const diffQ = currQ - prevQ;
        if(currQ >= QUEUE_HIGH_THRESHOLD || diffQ >= QUEUE_SPIKE_THRESHOLD){
          out.push({
            level: currQ >= QUEUE_HIGH_THRESHOLD ? "critical" : "warn",
            title: "–†–æ—Å—Ç –æ—á–µ—Ä–µ–¥–∏",
            text: `–û—á–µ—Ä–µ–¥–∏: ${currQ} (${diffQ > 0 ? "+"+diffQ : diffQ} –∑–∞ —Ü–∏–∫–ª).`,
            time: rel(now.toISOString())
          });
        }
      }

      if(out.length === 0){
        out.push({
          level: "ok",
          title: "–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞",
          text: "–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.",
          time: rel(now.toISOString())
        });
      }

      return out;
    }

    function renderAlertsCenter(meta){
      const box = $("alertsCenter");
      const count = $("alertsCount");
      const updated = $("alertsUpdatedAt");
      if(!box || !count || !updated) return;
      const alerts = buildAlerts(meta);
      const realCount = alerts.filter(a=>a.level!=="ok").length;
      count.textContent = String(realCount);
      updated.textContent = `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${rel(new Date().toISOString())}`;
      box.innerHTML = alerts.map(a=>`<article class="alert-item ${a.level}">
        <div class="alert-item-head"><i class="alert-dot"></i><span>${esc(a.title)}</span></div>
        <div class="alert-text">${esc(a.text)}</div>
        <div class="alert-foot">${esc(a.time)}</div>
      </article>`).join("");
    }

    function markApiDown(err){
      if(!apiHealth.down){
        apiHealth.down = true;
        apiHealth.since = Date.now();
      }
      apiHealth.message = String(err?.message || err || "API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      const meta = collectDashboardMeta();
      renderAlertsCenter(meta);
    }

    function markApiHealthy(){
      if(apiHealth.down){
        apiHealth.down = false;
        apiHealth.since = 0;
        apiHealth.message = "";
      }
    }

    function activePageId(){
      return document.querySelector(".page.active")?.id || "";
    }

    function render(){
      const meta = collectDashboardMeta();
      applyDashboardMeta(meta);
      rememberAlertSample(meta);
      renderAlertsCenter(meta);
      updateTrendSample(meta);

      renderNodeFilters();
      renderTopNodes();
      renderHotUsers();
      renderCharts();
      renderSysinfo();

      // Render only the currently visible page to avoid heavy off-screen work
      const pg = activePageId();
      if(pg && pg !== "p-dashboard"){
        renderPageContents(pg.replace("p-", ""));
      }
    }

    function displayNodeName(raw){
      const key = String(raw || "").trim();
      if(!key) return "-";
      const found = (nodes||[]).find(n => String(n?.id||"").trim() === key);
      return found?.name || key;
    }

    function isUnknownNodeValue(raw){
      const v = String(raw ?? "").trim().toLowerCase();
      return !v || v==="unknown" || v==="-" || v==="n/a" || v==="none" || v==="null";
    }

    function resolveNodeLabel(displayValue, rawValue){
      if(!isUnknownNodeValue(displayValue)){
        return String(displayValue).trim();
      }
      if(!isUnknownNodeValue(rawValue)){
        return displayNodeName(rawValue);
      }
      return "unknown";
    }

    function nodeStableKey(row){
      const byID = String(row?.node_id || "").trim();
      if(byID) return byID.toLowerCase();
      const byName = String(row?.node_name || "").trim();
      return byName.toLowerCase();
    }

    function nodeAggregates(sourceUsers=users, sourceTraffic=trafficData){
      const onlineUsersByNode = new Map();
      (Array.isArray(sourceUsers) ? sourceUsers : []).forEach(u=>{
        if(!u || !u.online) return;
        const key = normNodeKey(resolveNodeLabel(u.last_node_display, u.last_node));
        if(!key || key === "unknown") return;
        onlineUsersByNode.set(key, (onlineUsersByNode.get(key) || 0) + 1);
      });

      const trafficByNode = new Map();
      const trafficRows = Array.isArray(sourceTraffic?.rows) ? sourceTraffic.rows : [];
      trafficRows.forEach(row=>{
        const key = normNodeKey(resolveNodeLabel(row?.last_node_display, row?.last_node));
        if(!key || key === "unknown") return;
        const used = Number(row?.used_traffic_bytes || 0);
        trafficByNode.set(key, (trafficByNode.get(key) || 0) + (Number.isFinite(used) ? used : 0));
      });
      return {onlineUsersByNode, trafficByNode};
    }

    function nodeCardDigest(row, onlineUsersByNode, trafficByNode){
      const nodeKey = normNodeKey(resolveNodeLabel(row?.node_name, row?.node_id) || row?.node_name || row?.node_id || "");
      const lastSeen = pickValidTime(row?.last_traffic_at, row?.last_blocker_heartbeat_at, row?.last_blocker_action_at);
      return [
        String(row?.node_id || ""),
        String(row?.node_name || ""),
        row?.online ? "1":"0",
        String(lastSeen || ""),
        String(row?.last_traffic_at || ""),
        String(row?.last_blocker_heartbeat_at || ""),
        String(row?.last_blocker_action_at || ""),
        Number(onlineUsersByNode.get(nodeKey) || 0),
        Number(trafficByNode.get(nodeKey) || 0)
      ].join("|");
    }

    function nodeCardHtml(r, onlineUsersByNode, trafficByNode){
      const uuidRE = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
      const name = String(r.node_name || r.node_id || "unknown");
      const nodeID = String(r.node_id || "").trim();
      const showSub = !!nodeID && nodeID !== name && !uuidRE.test(nodeID);
      const nodeKey = normNodeKey(resolveNodeLabel(r.node_name, r.node_id) || name);
      const nodeOnlineUsers = onlineUsersByNode.get(nodeKey) || 0;
      const nodeTrafficBytes = trafficByNode.get(nodeKey) || 0;
      const lastSeen = pickValidTime(r.last_traffic_at, r.last_blocker_heartbeat_at, r.last_blocker_action_at);
      return `<article class="node-card ${r.online?'online':'offline'}" tabindex="0" data-node-id="${esc(nodeID)}" data-node-name="${esc(name)}">
        <div class="node-head">
          <div class="node-ident">
            <span class="node-dot"></span>
            <div>
              <div class="node-name">${esc(name)}</div>
              ${showSub ? `<div class="node-sub">${esc(nodeID)}</div>` : ``}
            </div>
          </div>
          ${r.online ? semanticBadge("online", "–û–Ω–ª–∞–π–Ω") : semanticBadge("offline", "–û—Ñ—Ñ–ª–∞–π–Ω")}
        </div>
        <div class="node-kpis">
          <div class="node-kpi kpi-online"><div class="node-kpi-label">–û–Ω–ª–∞–π–Ω</div><div class="node-kpi-val">${nodeOnlineUsers}</div></div>
          <div class="node-kpi"><div class="node-kpi-label">–¢—Ä–∞—Ñ–∏–∫</div><div class="node-kpi-val">${fmtBytes(nodeTrafficBytes)}</div></div>
        </div>
        ${nodeSparklineHtml(nodeKey)}
        <div class="node-foot">
          <span>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
          <b>${rel(lastSeen)}</b>
        </div>
      </article>`;
    }

    function bindNodeCards(){
      const wrap = $("nodesCards");
      if(!wrap) return;
      wrap.querySelectorAll(".node-card").forEach(card=>{
        card.onclick = () => openNodeDrawer(card.dataset.nodeId || card.dataset.nodeName || "");
        card.onkeydown = (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            openNodeDrawer(card.dataset.nodeId || card.dataset.nodeName || "");
          }
        };
      });
    }

    function nodeRowsForDashboard(rows){
      const list = Array.isArray(rows) ? rows : [];
      if(dashboardNodesExpanded || list.length <= DASHBOARD_NODES_LIMIT) return list;
      return list.slice(0, DASHBOARD_NODES_LIMIT);
    }

    function updateDashboardNodesToggle(total){
      const btn = $("nodesToggleBtn");
      const wrap = $("nodesToggleWrap");
      if(!btn) return;
      if(total <= DASHBOARD_NODES_LIMIT){
        if(wrap) wrap.style.display = "none";
        return;
      }
      if(wrap) wrap.style.display = "block";
      btn.textContent = dashboardNodesExpanded ? `–ü–æ–∫–∞–∑–∞—Ç—å ${DASHBOARD_NODES_LIMIT}` : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (${total})`;
    }

    function toggleDashboardNodes(){
      dashboardNodesExpanded = !dashboardNodesExpanded;
      renderTopNodes();
    }

    function renderTopNodes(){
      const rows = Array.isArray(nodeHealth) ? nodeHealth : [];
      const showRows = nodeRowsForDashboard(rows);
      const online = rows.filter(r=>!!r.online).length;
      const total = rows.length;
      const offline = Math.max(0, total - online);
      $("nodesSummaryHint").textContent = `${online} –æ–Ω–ª–∞–π–Ω / ${total} –≤—Å–µ–≥–æ`;
      $("nodesOnlineCount").textContent = String(online);
      $("nodesOfflineCount").textContent = String(offline);
      updateDashboardNodesToggle(total);

      const agg = nodeAggregates(users, trafficData);
      updateNodeTrend(rows, agg.onlineUsersByNode, agg.trafficByNode);
      $("nodesCards").innerHTML = showRows.map(r=>nodeCardHtml(r, agg.onlineUsersByNode, agg.trafficByNode)).join("") || `<div class="nodes-empty muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–æ–¥–∞–º</div>`;
      bindNodeCards();
    }

    function patchNodeCards(prev){
      const prevRows = Array.isArray(prev?.nodeHealth) ? prev.nodeHealth : [];
      const nextRows = Array.isArray(nodeHealth) ? nodeHealth : [];
      const prevShowRows = nodeRowsForDashboard(prevRows);
      const nextShowRows = nodeRowsForDashboard(nextRows);
      const cardsWrap = $("nodesCards");
      if(!cardsWrap){
        return;
      }

      const online = nextRows.filter(r=>!!r.online).length;
      const total = nextRows.length;
      const offline = Math.max(0, total - online);
      $("nodesSummaryHint").textContent = `${online} –æ–Ω–ª–∞–π–Ω / ${total} –≤—Å–µ–≥–æ`;
      $("nodesOnlineCount").textContent = String(online);
      $("nodesOfflineCount").textContent = String(offline);
      updateDashboardNodesToggle(total);

      const prevAgg = nodeAggregates(prev?.users, prev?.trafficData);
      const nextAgg = nodeAggregates(users, trafficData);
      updateNodeTrend(nextRows, nextAgg.onlineUsersByNode, nextAgg.trafficByNode);

      const prevKeys = prevShowRows.map(nodeStableKey);
      const nextKeys = nextShowRows.map(nodeStableKey);
      if(prevKeys.length !== nextKeys.length || prevKeys.some((k,i)=>k!==nextKeys[i])){
        renderTopNodes();
        return;
      }

      const domCards = Array.from(cardsWrap.querySelectorAll(".node-card"));
      if(domCards.length !== nextShowRows.length){
        renderTopNodes();
        return;
      }

      let changed = 0;
      for(let i=0;i<nextShowRows.length;i++){
        const prevDigest = nodeCardDigest(prevShowRows[i], prevAgg.onlineUsersByNode, prevAgg.trafficByNode);
        const nextDigest = nodeCardDigest(nextShowRows[i], nextAgg.onlineUsersByNode, nextAgg.trafficByNode);
        if(prevDigest !== nextDigest){
          const tmp = document.createElement("div");
          tmp.innerHTML = nodeCardHtml(nextShowRows[i], nextAgg.onlineUsersByNode, nextAgg.trafficByNode);
          const nextCard = tmp.firstElementChild;
          if(nextCard){
            domCards[i].replaceWith(nextCard);
            changed++;
          }
        }
      }

      if(changed > 0){
        bindNodeCards();
      }
    }

    function hotUsersRowsFrom(sourceUsers=users){
      const hotNode = $("fHotNode")?.value || "all";
      return [...(Array.isArray(sourceUsers) ? sourceUsers : [])]
        .filter(u=>{
          const node = resolveNodeLabel(u.last_node_display, u.last_node);
          if(hotNode !== "all" && node !== hotNode) return false;
          return true;
        })
        .sort((a,b)=>{
          if((b.blocked?1:0)!==(a.blocked?1:0)) return (b.blocked?1:0)-(a.blocked?1:0);
          if((b.exceeds?1:0)!==(a.exceeds?1:0)) return (b.exceeds?1:0)-(a.exceeds?1:0);
          return (b.ip_count||0)-(a.ip_count||0);
        })
        .slice(0,10);
    }

    function hotUserRowHtml(u){
      const node = resolveNodeLabel(u.last_node_display, u.last_node);
      return `<tr class="row-click" data-u="${esc(u.user_identifier)}"><td><b>${esc(displayName(u))}</b><div class="muted" style="font-size:12px">${esc(u.user_identifier||"")}</div></td><td><span class="badge b-blue">${u.ip_count}</span></td><td>${u.limit}</td><td>${esc(node)}</td><td>${rel(u.last_seen_at || u.heuristics?.last_event_at)}</td><td>${renderStatusBadge(u)}</td><td>${renderActivityBadge(u.online)}</td></tr>`;
    }

    function hotUserDigest(u){
      return [
        String(u?.user_identifier||""),
        String(displayName(u)||""),
        Number(u?.ip_count||0),
        Number(u?.limit||0),
        String(u?.last_node_display||u?.last_node||""),
        String(u?.last_seen_at||u?.heuristics?.last_event_at||""),
        u?.blocked ? "1":"0",
        u?.exceeds ? "1":"0",
        u?.online ? "1":"0"
      ].join("|");
    }

    function renderHotUsers(){
      const rows = hotUsersRowsFrom(users);
      $("tbHotUsers").innerHTML = rows.map(hotUserRowHtml).join("") || emptyRow(7, "‚óà", "–ù–µ—Ç –≥–æ—Ä—è—á–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "–°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å");
      $("tbHotUsers").querySelectorAll("tr.row-click").forEach(tr=>tr.onclick=()=>openUser(tr.dataset.u));
    }

    function patchHotUsers(prevUsers){
      const prevRows = hotUsersRowsFrom(prevUsers);
      const nextRows = hotUsersRowsFrom(users);
      const tbody = $("tbHotUsers");
      const domRows = Array.from(tbody?.querySelectorAll("tr.row-click") || []);
      if(!tbody || domRows.length !== nextRows.length){
        renderHotUsers();
        return;
      }

      for(let i=0;i<nextRows.length;i++){
        const prevKey = String(prevRows[i]?.user_identifier||"");
        const nextKey = String(nextRows[i]?.user_identifier||"");
        if(prevKey !== nextKey){
          renderHotUsers();
          return;
        }
      }

      let changed = 0;
      for(let i=0;i<nextRows.length;i++){
        if(hotUserDigest(prevRows[i]) !== hotUserDigest(nextRows[i])){
          const wrap = document.createElement("tbody");
          wrap.innerHTML = hotUserRowHtml(nextRows[i]);
          const nextTr = wrap.firstElementChild;
          if(nextTr){
            domRows[i].replaceWith(nextTr);
            changed++;
          }
        }
      }
      if(changed > 0){
        $("tbHotUsers").querySelectorAll("tr.row-click").forEach(tr=>tr.onclick=()=>openUser(tr.dataset.u));
      }
    }

    function renderNodeFilters(){
      const selUsers = $("fNode");
      const selHot = $("fHotNode");
      const nameSet = new Set();
      (nodes||[]).forEach(n => { if(n && n.name) nameSet.add(String(n.name)); });
      users.forEach(u => {
        const n = String(resolveNodeLabel(u.last_node_display, u.last_node) || "").trim();
        if(n) nameSet.add(n);
      });
      const sorted = [...nameSet].sort((a,b)=>a.localeCompare(b,"ru"));
      const key = sorted.join("\0");
      if(key === _nodeFilterKey) return;  // node list unchanged ‚Äî skip DOM rebuild
      _nodeFilterKey = key;
      const prevUsers = selUsers?.value || "all";
      const prevHot = selHot?.value || "all";
      const usersOptions = `<option value="all">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: –≤—Å–µ</option>` + sorted.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
      const hotOptions = `<option value="all">–ù–æ–¥–∞: –≤—Å–µ</option>` + sorted.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
      if(selUsers){
        selUsers.innerHTML = usersOptions;
        selUsers.value = sorted.includes(prevUsers) ? prevUsers : "all";
      }
      if(selHot){
        selHot.innerHTML = hotOptions;
        selHot.value = sorted.includes(prevHot) ? prevHot : "all";
      }
    }

    function filteredUsersFrom(sourceUsers=users){
      const q=$("qUser").value.trim().toLowerCase();
      const st=$("fState").value;
      const nf=$("fNode").value;
      return (Array.isArray(sourceUsers) ? sourceUsers : []).filter(u=>{
        if(st==="ok" && (u.exceeds || u.blocked)) return false;
        if(st==="bad" && !(u.exceeds && !u.blocked)) return false;
        if(st==="blocked" && !u.blocked) return false;
        const node = resolveNodeLabel(u.last_node_display, u.last_node);
        if(nf!=="all" && node!==nf) return false;
        if(!q) return true;
        return displayName(u).toLowerCase().includes(q) || String(u.user_identifier||"").toLowerCase().includes(q) || node.toLowerCase().includes(q) || (u.active_ips||[]).some(ip=>ip.includes(q));
      });
    }

    function filteredUsers(){
      return filteredUsersFrom(users);
    }

    function usersPageSlice(sourceUsers=users){
      const all = filteredUsersFrom(sourceUsers);
      const total = all.length;
      const totalPages = Math.max(1, Math.ceil(total / USERS_PAGE_SIZE));
      const page = Math.min(usersPage, totalPages - 1);
      const start = page * USERS_PAGE_SIZE;
      const rows = all.slice(start, start + USERS_PAGE_SIZE);
      return {all, total, totalPages, page, start, rows};
    }

    function usersRowHtml(u, rowNo){
      const name = displayName(u);
      const idLine = name !== String(u.user_identifier) ? `<div class="muted" style="font-size:12px">${esc(u.user_identifier)}</div>` : "";
      const activity = rel(u.last_seen_at || u.heuristics?.last_event_at);
      const sharing = u.sharing || null;
      const concurrent = sharing ? `${sharing.concurrent_ips}/${sharing.concurrent_limit}` : "-";
      const triggers = sharing ? `${sharing.trigger_hits}/${sharing.trigger_required}` : "-";
      const node = resolveNodeLabel(u.last_node_display, u.last_node);
      const rowCls = u.blocked ? "row-click row-blocked" : (u.exceeds ? "row-click row-violated" : "row-click");
      const colIp = `<span class="badge b-blue">${u.ip_count}</span>`;
      const colLimit = `<span class="badge b-amber">${u.limit}</span>`;
      return `<tr class="${rowCls}" data-u="${esc(u.user_identifier)}"><td class="td-check"><input type="checkbox" class="user-cb" data-id="${esc(u.user_identifier)}"></td><td>${rowNo}</td><td><b>${esc(name)}</b>${idLine}</td><td>${colIp}</td><td>${colLimit}</td><td>${esc(concurrent)}</td><td>${esc(triggers)}</td><td>${esc(node)}</td><td>${activity}</td><td>${renderStatusBadge(u)}</td><td>${renderActivityBadge(u.online)}</td></tr>`;
    }

    function userRowDigest(u){
      return [
        String(u?.user_identifier||""),
        String(displayName(u)||""),
        Number(u?.ip_count||0),
        Number(u?.limit||0),
        String(u?.last_node_display||u?.last_node||""),
        String(u?.last_seen_at||u?.heuristics?.last_event_at||""),
        String(u?.sharing?.concurrent_ips||"-"),
        String(u?.sharing?.concurrent_limit||"-"),
        String(u?.sharing?.trigger_hits||"-"),
        String(u?.sharing?.trigger_required||"-"),
        u?.blocked ? "1":"0",
        u?.exceeds ? "1":"0",
        u?.online ? "1":"0"
      ].join("|");
    }

    function bindUsersCbs(){
      $("tbUsers").querySelectorAll(".user-cb").forEach(cb=>{
        cb.onchange=()=>{
          if(cb.checked) usersSel.add(cb.dataset.id);
          else usersSel.delete(cb.dataset.id);
          updateUsersBulkBar();
          const allCb = $("usersCheckAll");
          if(allCb) allCb.checked = false;
        };
      });
    }

    function renderUsers(){
      usersSel = new Set();
      updateUsersBulkBar();
      const page = usersPageSlice(users);
      usersPage = page.page;

      $("tbUsers").innerHTML = page.rows.map((u,i)=>usersRowHtml(u, page.start+i+1)).join("")
        || emptyRow(11, "‚óâ", "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å");
      $("tbUsers").querySelectorAll("tr.row-click").forEach(tr=>tr.onclick=()=>openUser(tr.dataset.u));
      bindUsersCbs();

      // Pagination controls
      const pager = $("usersPager");
      if(page.total <= USERS_PAGE_SIZE){ pager.innerHTML=""; return; }
      const from = page.total ? page.start+1 : 0, to = Math.min(page.start+USERS_PAGE_SIZE, page.total);
      let btns = `<span class="pager-info">–ü–æ–∫–∞–∑–∞–Ω–æ ${from}‚Äì${to} –∏–∑ ${page.total}</span>`;
      btns += `<button class="pager-btn" onclick="usersPage=0;renderUsers()" ${usersPage===0?"disabled":""}>¬´</button>`;
      btns += `<button class="pager-btn" onclick="usersPage--;renderUsers()" ${usersPage===0?"disabled":""}>‚Äπ</button>`;
      const winStart = Math.max(0, usersPage-2), winEnd = Math.min(page.totalPages, winStart+5);
      for(let p=winStart;p<winEnd;p++){
        btns += `<button class="pager-btn${p===usersPage?" active":""}" onclick="usersPage=${p};renderUsers()">${p+1}</button>`;
      }
      btns += `<button class="pager-btn" onclick="usersPage++;renderUsers()" ${usersPage===page.totalPages-1?"disabled":""}>‚Ä∫</button>`;
      btns += `<button class="pager-btn" onclick="usersPage=${page.totalPages-1};renderUsers()" ${usersPage===page.totalPages-1?"disabled":""}>¬ª</button>`;
      pager.innerHTML = btns;
    }

    function patchUsersTable(prevUsers){
      const prevPage = usersPageSlice(prevUsers);
      const nextPage = usersPageSlice(users);
      const tbody = $("tbUsers");
      const rowsDom = Array.from(tbody?.querySelectorAll("tr.row-click") || []);
      if(!tbody){
        return;
      }

      if(prevPage.total !== nextPage.total || prevPage.totalPages !== nextPage.totalPages || prevPage.page !== nextPage.page){
        usersPage = nextPage.page;
        renderUsers();
        return;
      }

      if(rowsDom.length !== nextPage.rows.length){
        renderUsers();
        return;
      }

      for(let i=0;i<nextPage.rows.length;i++){
        const prevKey = String(prevPage.rows[i]?.user_identifier || "");
        const nextKey = String(nextPage.rows[i]?.user_identifier || "");
        if(prevKey !== nextKey){
          renderUsers();
          return;
        }
      }

      let changed = 0;
      for(let i=0;i<nextPage.rows.length;i++){
        const prevDigest = userRowDigest(prevPage.rows[i]);
        const nextDigest = userRowDigest(nextPage.rows[i]);
        if(prevDigest !== nextDigest){
          const wrap = document.createElement("tbody");
          wrap.innerHTML = usersRowHtml(nextPage.rows[i], nextPage.start+i+1);
          const nextTr = wrap.firstElementChild;
          if(nextTr){
            rowsDom[i].replaceWith(nextTr);
            changed++;
          }
        }
      }

      if(changed > 0){
        $("tbUsers").querySelectorAll("tr.row-click").forEach(tr=>tr.onclick=()=>openUser(tr.dataset.u));
        $("tbUsers").querySelectorAll(".user-cb").forEach(cb=>{
          cb.checked = usersSel.has(cb.dataset.id);
          cb.onchange=()=>{
            if(cb.checked) usersSel.add(cb.dataset.id);
            else usersSel.delete(cb.dataset.id);
            updateUsersBulkBar();
            const allCb = $("usersCheckAll");
            if(allCb) allCb.checked = false;
          };
        });
      }
    }

    function applyLivePatch(prev){
      const meta = collectDashboardMeta();
      applyDashboardMeta(meta);
      rememberAlertSample(meta);
      renderAlertsCenter(meta);

      const page = activePageId();
      if(page === "p-dashboard"){
        patchNodeCards(prev);
        patchHotUsers(prev?.users);
        updateTrendSample(meta);
        renderCharts();
        renderSysinfo();
      } else if(page === "p-users"){
        renderNodeFilters();
        patchUsersTable(prev?.users);
      } else if(page === "p-traffic"){
        renderTraffic();
      } else if(page === "p-violators"){
        renderViolators(meta.viol);
      } else if(page === "p-ban"){
        renderBan();
      } else if(page === "p-activebans"){
        renderActiveBans();
      } else if(page === "p-nodeops"){
        loadNodeSSHCreds().then(()=>renderNodeSshNodes());
      } else if(page === "p-sshterm"){
        renderSshterm();
        initSstResizeObserver();
      } else if(page === "p-permanent-ban"){
        renderPermBan();
      } else if(page === "p-net"){
        renderNet();
      } else if(page === "p-shared"){
        renderShared();
      } else if(page === "p-logs"){
        renderLogs();
      } else if(page === "p-hwid"){
        renderHwid();
      }
    }

    function normNodeMatch(v){
      return String(v || "").trim().toLowerCase();
    }

    function findNodeRowByRef(ref){
      const needle = normNodeMatch(ref);
      if(!needle) return null;
      const rows = Array.isArray(nodeHealth) ? nodeHealth : [];
      return rows.find(r=>{
        const byID = normNodeMatch(r?.node_id);
        const byName = normNodeMatch(r?.node_name);
        return needle === byID || needle === byName || (byID && byID.includes(needle)) || (byName && byName.includes(needle));
      }) || null;
    }

    function nodeMatchesEvent(nodeRow, eventRow){
      const nodeKeys = new Set([
        normNodeMatch(nodeRow?.node_id),
        normNodeMatch(nodeRow?.node_name)
      ].filter(Boolean));
      const eNode = normNodeMatch(eventRow?.node_name);
      if(!eNode || nodeKeys.size === 0) return false;
      if(nodeKeys.has(eNode)) return true;
      for(const k of nodeKeys){
        if(eNode.includes(k) || k.includes(eNode)) return true;
      }
      return false;
    }

    function isNodeErrorEvent(ev){
      const tp = String(ev?.type || "").toLowerCase();
      const msg = String(ev?.message || "").toLowerCase();
      return tp.includes("error") || tp.includes("fail") || msg.includes("–æ—à–∏–±") || msg.includes("failed");
    }

    function closeNodeDrawer(){
      $("nodeDrawer")?.classList.remove("active");
      nodeDrawerRef = "";
    }

    function renderNodeDrawer(nodeRef, keepOpen=false){
      const row = findNodeRowByRef(nodeRef);
      const drawer = $("nodeDrawer");
      const body = $("nodeDrawerBody");
      if(!drawer || !body) return;
      if(!row){
        if(!keepOpen) showNotice("–ù–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", "err");
        closeNodeDrawer();
        return;
      }

      nodeDrawerRef = String(row.node_id || row.node_name || nodeRef || "");
      const nodeTitle = String(row.node_name || row.node_id || "–ù–æ–¥–∞");
      const statusText = row.online ? "online" : "offline";
      const events = (Array.isArray(logs) ? logs : []).filter(ev=>nodeMatchesEvent(row, ev)).slice(0, 16);
      const errors = events.filter(isNodeErrorEvent).slice(0, 6);
      const actions = events.filter(ev=>{
        const t = String(ev?.type || "").toLowerCase();
        return t.includes("block") || t.includes("clear") || t.includes("manual") || t.includes("sharing");
      }).slice(0, 6);

      $("nodeDrawerTitle").textContent = nodeTitle;
      $("nodeDrawerSub").textContent = `${statusText} ‚Ä¢ ${row.node_id ? `ID: ${row.node_id}` : "–±–µ–∑ ID"}`;

      const list = (items, emptyText) => items.length
        ? `<div class="drawer-list">${items.map(ev=>`<div class="drawer-item"><div class="muted">${t(ev.timestamp)} ‚Ä¢ ${esc(String(ev.type||"event").toUpperCase())}</div><p>${esc(ev.message || "-")}</p></div>`).join("")}</div>`
        : `<div class="muted">${emptyText}</div>`;

      body.innerHTML = `
        <div class="drawer-grid">
          <div class="drawer-kpi"><span>–°—Ç–∞—Ç—É—Å</span><b>${row.online ? "–û–Ω–ª–∞–π–Ω" : "–û—Ñ—Ñ–ª–∞–π–Ω"}</b></div>
          <div class="drawer-kpi"><span>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç—Ä–∞—Ñ–∏–∫</span><b>${rel(row.last_traffic_at)}</b></div>
          <div class="drawer-kpi"><span>Heartbeat</span><b>${rel(row.last_blocker_heartbeat_at)}</b></div>
          <div class="drawer-kpi"><span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</span><b>${rel(row.last_blocker_action_at)}</b></div>
        </div>
        <div class="drawer-actions">
          <button type="button" class="btn" id="nodeDrawerRefreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button type="button" class="btn" id="nodeDrawerLogsBtn">–õ–æ–≥–∏ –Ω–æ–¥—ã</button>
        </div>
        <section class="drawer-card"><h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h4>${list(events, "–ü–æ –Ω–æ–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ –ª–æ–≥–æ–≤.")}</section>
        <section class="drawer-card"><h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</h4>${list(errors, "–û—à–∏–±–∫–∏ –ø–æ –Ω–æ–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")}</section>
        <section class="drawer-card"><h4>–î–µ–π—Å—Ç–≤–∏—è</h4>${list(actions, "–î–µ–π—Å—Ç–≤–∏–π –ø–æ –Ω–æ–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç.")}</section>
      `;

      $("nodeDrawerRefreshBtn").onclick = ()=>liveRefresh();
      $("nodeDrawerLogsBtn").onclick = ()=>{
        switchPage("logs", "–õ–æ–≥–∏");
        renderLogs();
        const rows = Array.from(document.querySelectorAll("#tbLogs tr"));
        const nodeNeedle = normNodeMatch(nodeTitle);
        const hit = rows.find(tr=>{
          const td = tr.children && tr.children[4];
          return td && normNodeMatch(td.textContent).includes(nodeNeedle);
        });
        if(hit){
          hit.scrollIntoView({behavior:"smooth", block:"center"});
          hit.style.outline = "1px solid rgba(26,213,240,.65)";
          setTimeout(()=>{ hit.style.outline = ""; }, 1800);
        }
      };

      if(!keepOpen){
        drawer.classList.add("active");
      }
    }

    function openNodeDrawer(nodeRef){
      renderNodeDrawer(nodeRef, false);
    }

    function nodeSshNodeKey(node){
      const id = String(node?.id || "").trim();
      if(id) return id;
      return String(node?.name || "").trim();
    }

    function nodeSshRows(){
      const healthRows = Array.isArray(nodeHealth) ? nodeHealth : [];
      const healthBy = new Map();
      healthRows.forEach(h=>{
        const name = String(h?.node_name || "").trim().toLowerCase();
        const id = String(h?.node_id || "").trim().toLowerCase();
        if(name) healthBy.set(name, !!h.online);
        if(id) healthBy.set(id, !!h.online);
      });

      const rows = (Array.isArray(nodes) ? nodes : []).map(n=>{
        const key = nodeSshNodeKey(n);
        const id = String(n?.id || "").trim();
        const name = String(n?.name || id || "").trim() || "unknown";
        const address = String(n?.address || "").trim();
        const online = healthBy.get(id.toLowerCase()) ?? healthBy.get(name.toLowerCase()) ?? false;
        const sshEnabled = !!n?.ssh_enabled;
        const selectable = !!address;
        return {key, id, name, address, online, sshEnabled, selectable};
      }).filter(r=>r.key);

      rows.sort((a,b)=>{
        if(a.online !== b.online) return a.online ? -1 : 1;
        return a.name.localeCompare(b.name, "ru");
      });
      return rows;
    }

    function syncNodeSshSelection(rows){
      const valid = new Set(rows.map(r=>r.key));
      nodeSshSelection = new Set([...nodeSshSelection].filter(k=>valid.has(k)));
      if(nodeSshActiveKey && !valid.has(nodeSshActiveKey)){
        nodeSshActiveKey = "";
      }
      if(!nodeSshActiveKey && nodeSshSelection.size === 1){
        nodeSshActiveKey = [...nodeSshSelection][0];
      }
    }

    function nodeSshSelectedRows(rows){
      return rows.filter(r=>nodeSshSelection.has(r.key) && r.selectable);
    }

    function nodeSshActiveRow(rows){
      const byKey = rows.find(r=>r.key === nodeSshActiveKey && r.selectable);
      if(byKey) return byKey;
      const selected = nodeSshSelectedRows(rows);
      if(selected.length === 1) return selected[0];
      return null;
    }

    function renderNodeSshCounter(rows){
      const el = $("nodeSshCounter");
      if(!el) return;
      el.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${nodeSshSelectedRows(rows).length}`;
    }

    function nodeSshHasLiveOutput(){
      if(nodeSshLiveExecId) return true;
      return Object.keys(nodeSshLiveNodes || {}).length > 0;
    }

    function nodeSshHasRenderedOutput(){
      const box = $("nodeSshOutput");
      if(!box) return false;
      return !!box.querySelector(".term-terminal, .term-block");
    }

    function renderNodeSshEmptyState(rows){
      if(nodeSshLastResults.length > 0 || nodeSshHasLiveOutput() || nodeSshHasRenderedOutput()) return;
      const box = $("nodeSshOutput");
      if(!box) return;

      const selected = nodeSshSelectedRows(rows);
      const active = nodeSshActiveRow(rows);
      if(selected.length > 1){
        box.innerHTML = `<div class="term-empty">–ú–∞—Å—Å–æ–≤—ã–π —Ä–µ–∂–∏–º: –≤—ã–±—Ä–∞–Ω–æ ${selected.length} –Ω–æ–¥. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –±–ª–æ–∫–µ "–ö–æ–º–∞–Ω–¥–∞ (–º–∞—Å—Å–æ–≤–æ)".</div>`;
        return;
      }
      if(active){
        box.innerHTML = `<div class="term-empty">–¢–µ—Ä–º–∏–Ω–∞–ª –Ω–æ–¥—ã ${esc(active.name)} –æ—Ç–∫—Ä—ã—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –Ω–æ–¥–µ".</div>`;
        return;
      }
      box.innerHTML = `<div class="term-empty">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª.</div>`;
    }

    function renderNodeSshMode(rows){
      const selected = nodeSshSelectedRows(rows);
      const active = nodeSshActiveRow(rows);
      const multi = selected.length > 1;

      const singlePanel = $("nodeSshSinglePanel");
      const multiPanel = $("nodeSshMultiPanel");
      if(singlePanel) singlePanel.classList.toggle("nodeops-panel-hide", multi);
      if(multiPanel) multiPanel.classList.toggle("nodeops-panel-hide", !multi);

      const title = $("nodeSshOutputTitle");
      if(title){
        title.textContent = multi
          ? `–¢–µ—Ä–º–∏–Ω–∞–ª (${selected.length} –Ω–æ–¥)`
          : (active ? `–¢–µ—Ä–º–∏–Ω–∞–ª: ${active.name}` : "–¢–µ—Ä–º–∏–Ω–∞–ª");
      }

      const singleTitle = $("nodeSshSingleTitle");
      if(singleTitle){
        singleTitle.textContent = active ? `–¢–µ—Ä–º–∏–Ω–∞–ª –Ω–æ–¥—ã: ${active.name}` : "–¢–µ—Ä–º–∏–Ω–∞–ª –Ω–æ–¥—ã";
      }

      const singleHint = $("nodeSshSingleHint");
      if(singleHint){
        singleHint.textContent = active
          ? `–ù–æ–¥–∞: ${active.name}${active.address ? ` (${active.address})` : ""}`
          : "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª.";
      }

      const runSingle = $("nodeSshRunSingle");
      if(runSingle){
        runSingle.disabled = nodeSshRunning || !active;
      }

      const runMulti = $("nodeSshRun");
      if(runMulti){
        runMulti.disabled = nodeSshRunning || !multi;
      }

      const multiSummary = $("nodeSshSummary");
      if(multiSummary && multi){
        multiSummary.textContent = `–ú–∞—Å—Å–æ–≤—ã–π —Ä–µ–∂–∏–º: –≤—ã–±—Ä–∞–Ω–æ ${selected.length} –Ω–æ–¥.`;
      }

      renderNodeSshEmptyState(rows);
    }

    function renderNodeSshNodes(){
      const box = $("nodeSshList");
      if(!box) return;
      const rows = nodeSshRows();
      syncNodeSshSelection(rows);
      renderNodeSshCounter(rows);

      if(rows.length === 0){
        box.innerHTML = `<div class="term-empty">–°–ø–∏—Å–æ–∫ –Ω–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>`;
        renderNodeSshMode(rows);
        return;
      }

      const active = nodeSshActiveRow(rows);
      const activeKey = active ? active.key : "";

      box.innerHTML = rows.map(r=>{
        const cred = nodeSshCreds[r.key];
        const hasCreds = !!cred;
        const credKinds = [];
        if(cred?.has_password) credKinds.push("password");
        if(cred?.has_private_key) credKinds.push("key");
        const credTitle = cred ? `Creds: ${cred.user || ""}${credKinds.length ? ` (${credKinds.join("+")})` : ""}` : "";
        const credDot = hasCreds ? `<i class="nodeops-cred-dot" title="${esc(credTitle)}"></i>` : "";
        return `<div class="nodeops-item ${activeKey === r.key ? "active" : ""}">
        <input type="checkbox" class="nodeSshNodeCb" data-key="${esc(r.key)}" ${nodeSshSelection.has(r.key) ? "checked" : ""} ${!r.selectable ? "disabled" : ""}>
        <button type="button" class="nodeops-open nodeSshOpenBtn" data-key="${esc(r.key)}" ${!r.selectable ? "disabled" : ""}>
          <i class="nodeops-dot ${r.online ? "on" : "off"}"></i>
          <div class="nodeops-meta">
            <div style="display:flex;align-items:center;gap:5px">${credDot}<span class="nodeops-name">${esc(r.name)}</span></div>
            <span class="nodeops-addr">${esc(r.address || "–Ω–µ—Ç address –≤ –ø–∞–Ω–µ–ª–∏")}</span>
          </div>
        </button>
        <span class="nodeops-badge">${!r.selectable ? "no address" : (!r.sshEnabled ? "ssh off" : (r.online ? "online" : "offline"))}</span>
        <button type="button" class="nodeops-gear nodeSshGearBtn" data-key="${esc(r.key)}" data-name="${esc(r.name)}" title="SSH credentials">‚öô</button>
      </div>`;
      }).join("");

      box.querySelectorAll(".nodeSshNodeCb").forEach(cb=>{
        cb.onchange = ()=>{
          const key = String(cb.dataset.key || "");
          if(!key) return;
          if(cb.checked){
            nodeSshSelection.add(key);
            if(nodeSshSelection.size === 1){
              nodeSshActiveKey = key;
            }
          } else {
            nodeSshSelection.delete(key);
            if(nodeSshActiveKey === key){
              nodeSshActiveKey = nodeSshSelection.size === 1 ? [...nodeSshSelection][0] : "";
            }
          }
          renderNodeSshNodes();
        };
      });

      box.querySelectorAll(".nodeSshOpenBtn").forEach(btn=>{
        btn.onclick = (e)=>{
          e.preventDefault();
          const key = String(btn.dataset.key || "");
          if(!key) return;
          nodeSshActiveKey = key;
          nodeSshSelection = new Set([key]);
          renderNodeSshNodes();
        };
      });

      box.querySelectorAll(".nodeSshGearBtn").forEach(btn=>{
        btn.onclick = (e)=>{
          e.preventDefault();
          e.stopPropagation();
          openNodeCredModal(String(btn.dataset.key||""), String(btn.dataset.name||""));
        };
      });

      renderNodeSshMode(rows);
    }

    function nodeSshSelect(mode){
      const rows = nodeSshRows();
      if(mode === "all"){
        nodeSshSelection = new Set(rows.filter(r=>r.selectable).map(r=>r.key));
      } else if(mode === "online"){
        nodeSshSelection = new Set(rows.filter(r=>r.selectable && r.online).map(r=>r.key));
      } else {
        nodeSshSelection = new Set();
      }
      if(nodeSshSelection.size === 0){
        nodeSshActiveKey = "";
      } else if(nodeSshSelection.size === 1){
        nodeSshActiveKey = [...nodeSshSelection][0];
      } else if(!nodeSshSelection.has(nodeSshActiveKey)){
        nodeSshActiveKey = [...nodeSshSelection][0];
      }
      renderNodeSshNodes();
    }

    function ansiToHtml(text){
      const raw = String(text || "");
      if(raw === "") return "";
      if(!ansiUp && window.AnsiUp){
        ansiUp = new window.AnsiUp();
      }
      if(ansiUp && typeof ansiUp.ansi_to_html === "function"){
        return ansiUp.ansi_to_html(raw).replace(/\n/g, "<br>");
      }
      return esc(raw).replace(/\n/g, "<br>");
    }

    function normalizeSshError(raw){
      const msg = String(raw || "").trim();
      if(!msg) return "";
      const low = msg.toLowerCase();
      if(low.includes("unable to authenticate") || low.includes("no supported methods remain")){
        return `${msg}\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ ‚öô —Ä—è–¥–æ–º —Å –Ω–æ–¥–æ–π –∏ –∑–∞–¥–∞–π—Ç–µ user/password, –ª–∏–±–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π NODE_SSH_USER/NODE_SSH_PASSWORD.`;
      }
      if(low.includes("connection refused") || low.includes("i/o timeout") || low.includes("no route to host")){
        return `${msg}\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ address:port –Ω–æ–¥—ã –∏ —Å–µ—Ç–µ–≤—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–∞–Ω–µ–ª–∏.`;
      }
      return msg;
    }

    function initNodeSshLive(execId, command){
      nodeSshLiveExecId = String(execId || "").trim();
      nodeSshLiveHeader = String(command || "").trim();
      nodeSshLiveNodes = {};
      if(!nodeSshLiveExecId) return;
      const box = $("nodeSshOutput");
      if(box){
        box.innerHTML = `<div class="term-terminal">
          <div class="term-headline">
            <span class="term-host">ffxban@panel</span>
            <span class="term-time">${esc(new Date().toLocaleTimeString("ru-RU", {hour12:false}))}</span>
          </div>
          <div class="term-command"><span class="sym">$</span> ${esc(nodeSshLiveHeader || "command")}</div>
          <div class="term-empty">–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞...</div>
        </div>`;
      }
    }

    function renderNodeSshLive(){
      if(!nodeSshLiveExecId) return;
      if(_sshLiveRafId) return;
      _sshLiveRafId = requestAnimationFrame(()=>{ _sshLiveRafId = 0; _doRenderNodeSshLive(); });
    }
    function _doRenderNodeSshLive(){
      if(!nodeSshLiveExecId) return;
      const box = $("nodeSshOutput");
      const summary = $("nodeSshSummary");
      const hint = $("nodeSshSingleHint");
      if(!box) return;

      const entries = Object.values(nodeSshLiveNodes || {});
      const total = entries.length;
      const done = entries.filter(n=>n.done).length;
      const ok = entries.filter(n=>n.done && n.ok).length;
      const fail = entries.filter(n=>n.done && !n.ok).length;

      if(summary){
        summary.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${done}/${total || "?"} ‚Ä¢ OK: ${ok} ‚Ä¢ FAIL: ${fail}`;
      }
      if(hint){
        hint.textContent = summary?.textContent || hint.textContent;
      }

      if(total === 0){
        box.innerHTML = `<div class="term-terminal">
          <div class="term-headline">
            <span class="term-host">ffxban@panel</span>
            <span class="term-time">${esc(new Date().toLocaleTimeString("ru-RU", {hour12:false}))}</span>
          </div>
          <div class="term-command"><span class="sym">$</span> ${esc(nodeSshLiveHeader || "command")}</div>
          <div class="term-empty">–û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞...</div>
        </div>`;
        return;
      }

      const items = entries.map(node=>{
        const body = ansiToHtml((node.lines || []).join("\n"));
        const errHtml = node.error ? `<div class="stderr">${esc(normalizeSshError(node.error)).replace(/\n/g,"<br>")}</div>` : "";
        const code = Number(node.exitCode);
        const duration = Number(node.durationMs || 0);
        return `<article class="term-block ${node.done ? (node.ok ? "ok" : "fail") : ""}">
          <div class="term-head">
            <div class="term-title"><i class="nodeops-dot ${node.done ? (node.ok ? "on" : "off") : "warn"}"></i><b>${esc(node.nodeName || node.nodeKey || "node")}</b></div>
            <div class="term-meta">${node.done ? `exit ${Number.isFinite(code) ? code : "-"} ‚Ä¢ ${duration} ms` : "running..."}</div>
          </div>
          <div class="term-box">${body || "<span class='muted'>–ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥</span>"}${errHtml ? `<br>${errHtml}` : ""}</div>
        </article>`;
      }).join("");

      box.innerHTML = `<div class="term-terminal">
        <div class="term-headline">
          <span class="term-host">ffxban@panel</span>
          <span class="term-time">${esc(new Date().toLocaleTimeString("ru-RU", {hour12:false}))}</span>
        </div>
        <div class="term-command"><span class="sym">$</span> ${esc(nodeSshLiveHeader || "command")}</div>
        ${items}
      </div>`;
    }

    function showNodeSshTransportError(message){
      const msg = String(message || "").trim();
      if(!msg) return;
      const box = $("nodeSshOutput");
      if(!box) return;
      const terminal = box.querySelector(".term-terminal");
      const html = `<div class="stderr">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API: ${esc(msg)}</div>`;
      if(!terminal){
        box.innerHTML = `<div class="term-empty">${html}</div>`;
        return;
      }
      let marker = terminal.querySelector(".term-transport-error");
      if(!marker){
        marker = document.createElement("div");
        marker.className = "term-transport-error";
        terminal.appendChild(marker);
      }
      marker.innerHTML = html;
    }

    function handleNodeSshWsEvent(msg){
      const execId = String(msg?.exec_id || "").trim();
      if(!execId || execId !== nodeSshLiveExecId) return;

      const nodeKey = String(msg?.node_key || msg?.node_id || msg?.node_name || "").trim() || "node";
      if(!nodeSshLiveNodes[nodeKey]){
        nodeSshLiveNodes[nodeKey] = {
          nodeKey,
          nodeName: String(msg?.node_name || msg?.node_id || nodeKey),
          lines: [],
          done: false,
          ok: false,
          exitCode: null,
          durationMs: 0,
          error: ""
        };
      }

      const node = nodeSshLiveNodes[nodeKey];
      if(msg.type === "node_ssh_stream"){
        const line = String(msg?.line || "");
        node.lines.push(line);
        if(node.lines.length > 500){
          node.lines = node.lines.slice(node.lines.length - 500);
        }
      } else if(msg.type === "node_ssh_stream_done"){
        node.done = true;
        node.ok = !!msg?.ok;
        node.exitCode = Number(msg?.exit_code);
        node.durationMs = Number(msg?.duration_ms || 0);
        node.error = String(msg?.error || "");
      }
      renderNodeSshLive();
    }

    function renderNodeSshOutput(payload){
      const box = $("nodeSshOutput");
      const summary = $("nodeSshSummary");
      const singleHint = $("nodeSshSingleHint");
      if(!box || !summary) return;
      const results = Array.isArray(payload?.results) ? payload.results : [];
      const unresolved = Array.isArray(payload?.unresolved) ? payload.unresolved : [];
      const command = String(payload?.command || "").trim();
      nodeSshLiveExecId = "";
      nodeSshLiveHeader = "";
      nodeSshLiveNodes = {};
      nodeSshLastResults = results;

      if(results.length === 0){
        box.innerHTML = `<div class="term-empty">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.</div>`;
      } else {
        const stamp = new Date().toLocaleTimeString("ru-RU", {hour12:false});
        const items = results.map(r=>{
          const ok = !!r.ok;
          const code = Number(r.exit_code);
          const ms = Number(r.duration_ms || 0);
          const stdoutHtml = ansiToHtml(r.stdout || "");
          const stderrHtml = ansiToHtml(r.stderr || "");
          const errorText = normalizeSshError(r.error || "");
          const errHtml = errorText ? `<div class="stderr">${esc(errorText).replace(/\n/g, "<br>")}</div>` : "";
          const body = [stdoutHtml, stderrHtml ? `<div class="stderr">${stderrHtml}</div>` : "", errHtml].filter(Boolean).join("<br>");
          return `<article class="term-block ${ok ? "ok" : "fail"}">
            <div class="term-head">
              <div class="term-title"><i class="nodeops-dot ${ok ? "on" : "off"}"></i><b>${esc(r.node_name || r.node_id || r.address || "node")}</b></div>
              <div class="term-meta">exit ${Number.isFinite(code) ? code : "-"} ‚Ä¢ ${ms} ms</div>
            </div>
            <div class="term-box">${body || "<span class='muted'>–ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥</span>"}</div>
          </article>`;
        }).join("");
        box.innerHTML = `<div class="term-terminal">
          <div class="term-headline">
            <span class="term-host">ffxban@panel</span>
            <span class="term-time">${esc(stamp)}</span>
          </div>
          <div class="term-command"><span class="sym">$</span> ${esc(command || "command")}</div>
          ${items}
        </div>`;
      }

      const okCount = Number(payload?.success_count || 0);
      const failCount = Number(payload?.failed_count || 0);
      const unresCount = unresolved.length;
      const unresolvedText = unresCount > 0
        ? ` ‚Ä¢ –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–æ: ${unresolved.map(u=>String(u.ref || "?")).join(", ")}`
        : "";
      const line = `OK: ${okCount}, FAIL: ${failCount}, RESOLVED: ${results.length}${unresolvedText}`;
      summary.textContent = line;
      if(singleHint){
        const rows = nodeSshRows();
        const selected = nodeSshSelectedRows(rows);
        if(selected.length <= 1){
          singleHint.textContent = line;
        }
      }
      renderNodeSshMode(nodeSshRows());
    }

    async function runNodeSshCommand(){
      if(nodeSshRunning) return;
      const cmd = String($("nodeSshCommand")?.value || "").trim();
      if(!cmd){
        showNotice("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É", "err");
        return;
      }

      const rows = nodeSshRows();
      const selectedRows = nodeSshSelectedRows(rows);
      const selected = selectedRows.map(r=>r.id || r.name || r.address);
      if(selected.length < 2){
        showNotice("–ú–∞—Å—Å–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ 2+ –Ω–æ–¥", "err");
        renderNodeSshMode(rows);
        return;
      }

      const runBtn = $("nodeSshRun");
      const summary = $("nodeSshSummary");
      nodeSshRunning = true;
      renderNodeSshMode(rows);
      if(runBtn){
        runBtn.disabled = true;
        runBtn.textContent = "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...";
      }
      if(summary){
        summary.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ ${selected.length} –Ω–æ–¥(–∞—Ö)...`;
      }

      try{
        const timeoutSeconds = Number($("nodeSshTimeout")?.value || 45);
        const execId = (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : `exec-${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        initNodeSshLive(execId, cmd);
        const payload = await api("/api/nodes/ssh/exec", {
          method: "POST",
          body: JSON.stringify({
            nodes: selected,
            command: cmd,
            timeout_seconds: timeoutSeconds,
            exec_id: execId
          })
        });
        renderNodeSshOutput(payload);
        showNotice(`SSH: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, OK ${payload.success_count||0}, FAIL ${payload.failed_count||0}`, Number(payload.failed_count||0) > 0 ? "err" : "ok");
      }catch(e){
        showNodeSshTransportError(e.message);
        if(summary){
          summary.textContent = `–û—à–∏–±–∫–∞ SSH: ${e.message}`;
        }
        showNotice(`SSH –æ—à–∏–±–∫–∞: ${e.message}`, "err");
      }finally{
        nodeSshRunning = false;
        if(runBtn){
          runBtn.disabled = false;
          runBtn.textContent = "–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö";
        }
        renderNodeSshMode(nodeSshRows());
      }
    }

    async function runNodeSshSingleCommand(){
      if(nodeSshRunning) return;
      const cmd = String($("nodeSshSingleCommand")?.value || "").trim();
      if(!cmd){
        showNotice("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –Ω–æ–¥—ã", "err");
        return;
      }

      const rows = nodeSshRows();
      const active = nodeSshActiveRow(rows);
      if(!active){
        showNotice("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É —Å–ª–µ–≤–∞", "err");
        return;
      }

      const ref = active.id || active.name || active.address;
      const runBtn = $("nodeSshRunSingle");
      const hint = $("nodeSshSingleHint");
      nodeSshRunning = true;
      renderNodeSshMode(rows);
      if(runBtn){
        runBtn.disabled = true;
        runBtn.textContent = "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...";
      }
      if(hint){
        hint.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ –Ω–æ–¥–µ ${active.name}...`;
      }

      try{
        const timeoutSeconds = Number($("nodeSshSingleTimeout")?.value || 45);
        const execId = (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : `exec-${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        initNodeSshLive(execId, cmd);
        const payload = await api("/api/nodes/ssh/exec", {
          method: "POST",
          body: JSON.stringify({
            nodes: [ref],
            command: cmd,
            timeout_seconds: timeoutSeconds,
            exec_id: execId
          })
        });
        renderNodeSshOutput(payload);
        showNotice(`SSH: ${active.name}, OK ${payload.success_count||0}, FAIL ${payload.failed_count||0}`, Number(payload.failed_count||0) > 0 ? "err" : "ok");
      }catch(e){
        showNodeSshTransportError(e.message);
        if(hint){
          hint.textContent = `–û—à–∏–±–∫–∞ SSH: ${e.message}`;
        }
        showNotice(`SSH –æ—à–∏–±–∫–∞: ${e.message}`, "err");
      }finally{
        nodeSshRunning = false;
        if(runBtn){
          runBtn.disabled = false;
          runBtn.textContent = "–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –Ω–æ–¥–µ";
        }
        renderNodeSshMode(nodeSshRows());
      }
    }

    function clearNodeSshOutput(){
      nodeSshLastResults = [];
      nodeSshLiveExecId = "";
      nodeSshLiveHeader = "";
      nodeSshLiveNodes = {};
      const box = $("nodeSshOutput");
      const summary = $("nodeSshSummary");
      if(box){
        box.innerHTML = `<div class="term-empty">–í—ã–≤–æ–¥ –æ—á–∏—â–µ–Ω.</div>`;
      }
      if(summary){
        summary.textContent = "–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é.";
      }
      renderNodeSshMode(nodeSshRows());
    }

    // ‚îÄ‚îÄ Node SSH credentials management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadNodeSSHCreds(){
      try{
        const data = await api("/api/nodes/ssh/creds");
        nodeSshCreds = {};
        (data?.items || []).forEach(it=>{
          if(it.node_key){
            nodeSshCreds[it.node_key] = {
              user: it.user,
              has_password: !!it.has_password,
              has_private_key: !!it.has_private_key
            };
          }
        });
      }catch(_){}
    }

    function openNodeCredModal(nodeKey, nodeName){
      if(!nodeKey) return;
      credModalNodeKey = nodeKey;
      const shell = $("credModalShell");
      const titleEl = $("credModalTitle");
      const subEl = $("credModalSub");
      const userEl = $("credUser");
      const pwEl = $("credPassword");
      const keyEl = $("credPrivateKey");
      const delBtn = $("credDeleteBtn");
      if(!shell) return;

      if(titleEl) titleEl.textContent = `SSH: ${nodeName || nodeKey}`;
      if(subEl) subEl.textContent = `node_key: ${nodeKey}`;

      const saved = nodeSshCreds[nodeKey];
      if(userEl) userEl.value = saved?.user || "";
      if(pwEl) pwEl.value = "";
      if(pwEl) pwEl.placeholder = saved?.has_password ? "‚óè‚óè‚óè‚óè‚óè‚óè (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)" : "–ü–∞—Ä–æ–ª—å SSH";
      if(keyEl) keyEl.value = "";
      if(keyEl) keyEl.placeholder = saved?.has_private_key
        ? "‚óè‚óè‚óè‚óè‚óè‚óè –∫–ª—é—á —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)"
        : "-----BEGIN OPENSSH PRIVATE KEY-----\n...\n-----END OPENSSH PRIVATE KEY-----";
      if(delBtn) delBtn.style.display = saved ? "" : "none";

      shell.classList.add("active");
      setTimeout(()=>{ if(userEl && !userEl.value) userEl.focus(); else if(pwEl) pwEl.focus(); }, 80);
    }

    function closeNodeCredModal(){
      const shell = $("credModalShell");
      if(shell) shell.classList.remove("active");
      credModalNodeKey = "";
    }

    async function saveNodeCred(){
      const key = credModalNodeKey;
      if(!key) return;
      const user = String($("credUser")?.value || "").trim();
      const password = String($("credPassword")?.value || "");
      const privateKey = String($("credPrivateKey")?.value || "").trim();
      if(!user){ showNotice("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH", "err"); return; }
      const saveBtn = $("credSaveBtn");
      if(saveBtn){ saveBtn.disabled = true; saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."; }
      try{
        await api("/api/nodes/ssh/creds", {
          method:"POST",
          body: JSON.stringify({node_key: key, user, password, private_key: privateKey})
        });
        await loadNodeSSHCreds();
        showNotice(`Credentials –¥–ª—è ${key} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`, "ok");
        closeNodeCredModal();
        renderNodeSshNodes();
      }catch(e){
        showNotice(`–û—à–∏–±–∫–∞: ${e.message}`, "err");
      }finally{
        if(saveBtn){ saveBtn.disabled = false; saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; }
      }
    }

    async function deleteNodeCred(){
      const key = credModalNodeKey;
      if(!key) return;
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å SSH-—É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–¥—ã "${key}"?`)) return;
      try{
        await api("/api/nodes/ssh/creds", {
          method:"DELETE",
          body: JSON.stringify({node_key: key})
        });
        await loadNodeSSHCreds();
        showNotice(`Credentials –¥–ª—è ${key} —É–¥–∞–ª–µ–Ω—ã`, "ok");
        closeNodeCredModal();
        renderNodeSshNodes();
      }catch(e){
        showNotice(`–û—à–∏–±–∫–∞: ${e.message}`, "err");
      }
    }

    async function runNodeSshOnAll(){
      if(nodeSshRunning) return;
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ textarea –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ
      const cmd = String($("nodeSshCommand")?.value || $("nodeSshSingleCommand")?.value || "").trim();
      if(!cmd){ showNotice("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É", "err"); return; }
      nodeSshSelect("all");
      await new Promise(r=>setTimeout(r,0));
      const rows = nodeSshRows();
      const all = rows.filter(r=>r.selectable).map(r=>r.id||r.name||r.address);
      if(all.length === 0){ showNotice("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–¥", "err"); return; }
      const runBtn = $("nodeSshRunAll");
      const summary = $("nodeSshSummary");
      nodeSshRunning = true;
      renderNodeSshMode(rows);
      if(runBtn){ runBtn.disabled = true; runBtn.textContent = "‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è..."; }
      if(summary){ summary.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö ${all.length} –Ω–æ–¥–∞—Ö...`; }
      try{
        const timeoutSeconds = Number($("nodeSshTimeout")?.value || $("nodeSshSingleTimeout")?.value || 45);
        const execId = (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : `exec-${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        initNodeSshLive(execId, cmd);
        const payload = await api("/api/nodes/ssh/exec", {
          method:"POST",
          body: JSON.stringify({nodes: all, command: cmd, timeout_seconds: timeoutSeconds, exec_id: execId})
        });
        renderNodeSshOutput(payload);
        showNotice(`ALL SSH: OK ${payload.success_count||0}, FAIL ${payload.failed_count||0}`,
          Number(payload.failed_count||0) > 0 ? "err" : "ok");
      }catch(e){
        showNodeSshTransportError(e.message);
        if(summary){ summary.textContent = `–û—à–∏–±–∫–∞: ${e.message}`; }
        showNotice(`SSH –æ—à–∏–±–∫–∞: ${e.message}`, "err");
      }finally{
        nodeSshRunning = false;
        if(runBtn){ runBtn.disabled = false; runBtn.textContent = "‚ö° –í—Å–µ –Ω–æ–¥—ã"; }
        renderNodeSshMode(nodeSshRows());
      }
    }

    // ‚îÄ‚îÄ SSH Interactive Terminal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const sstSessions = {};   // sessionId ‚Üí {id, nodeKey, nodeName, ws, term, fitAddon, paneEl, tabEl, status}
    let sstIdCounter = 0;

    function sstXterm(){
      return window.Terminal;
    }
    function sstFitAddon(){
      if(window.FitAddon) return window.FitAddon.FitAddon;
      return null;
    }

    async function loadSstNodes(){
      const sel = $("sstNodeSelect");
      if(!sel) return;
      try{
        const data = await api("/api/nodes/ssh/terminal/nodes");
        const nodes = Array.isArray(data?.nodes) ? data.nodes : [];
        const prev = sel.value;
        sel.innerHTML = `<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–¥—É ‚Äî</option>` +
          nodes.sort((a,b)=>String(a.name||a.key).localeCompare(String(b.name||b.key),"ru")).map(n=>{
            const label = esc(n.name || n.key);
            const tag = n.has_creds ? "üîë" : (!n.has_addr ? " ‚ö†" : "");
            return `<option value="${esc(n.key)}" ${!n.has_addr?"disabled":""}>${label}${tag}</option>`;
          }).join("");
        if(nodes.find(n=>n.key===prev)) sel.value = prev;
      }catch(_){}
    }

    function openSstTerminal(nodeKey){
      if(!nodeKey){ showNotice("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–¥—É", "err"); return; }
      const TermClass = sstXterm();
      const FitClass  = sstFitAddon();
      if(!TermClass){ showNotice("xterm.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω", "err"); return; }

      const id = `sst${++sstIdCounter}`;
      const nodeName = (() => {
        const opt = $("sstNodeSelect")?.querySelector(`option[value="${CSS.escape(nodeKey)}"]`);
        return opt ? opt.textContent.replace(/[üîë‚ö†]/g,"").trim() : nodeKey;
      })();

      // Hide empty state
      const emptyEl = $("sstEmptyState");
      if(emptyEl) emptyEl.style.display = "none";

      // Create pane
      const paneEl = document.createElement("div");
      paneEl.id = `pane-${id}`;
      paneEl.className = "sshterm-pane";
      $("sstPanel").appendChild(paneEl);

      // Create xterm
      const term = new TermClass({
        cols: 220,
        rows: 50,
        theme: {
          background:"#04080f", foreground:"#c8e0ff", cursor:"#4df5a3",
          cursorAccent:"#04080f", black:"#000a1a", red:"#ff5477",
          green:"#2fd683", yellow:"#fbbf24", blue:"#4f71ff",
          magenta:"#b06dff", cyan:"#1ad5f0", white:"#dbe8ff",
          brightBlack:"#1e3356", brightRed:"#ff7095", brightGreen:"#4df5a3",
          brightYellow:"#fdd26a", brightBlue:"#7892ff", brightMagenta:"#c89dff",
          brightCyan:"#56eaff", brightWhite:"#ffffff",
          selectionBackground:"rgba(26,213,240,.25)"
        },
        fontFamily:'"Cascadia Code","Fira Code","JetBrains Mono",ui-monospace,Consolas,monospace',
        fontSize:13, lineHeight:1.35, letterSpacing:0.3,
        cursorBlink:true, cursorStyle:"block",
        scrollback:5000, allowTransparency:true,
        convertEol:false,
      });

      let fitAddon = null;
      if(FitClass){
        fitAddon = new FitClass();
        term.loadAddon(fitAddon);
      }
      term.open(paneEl);
      if(fitAddon){ try{ fitAddon.fit(); }catch(_){} }

      // Tab
      const tabEl = document.createElement("div");
      tabEl.className = "sshterm-tab";
      tabEl.id = `tab-${id}`;
      tabEl.innerHTML = `<i class="sshterm-tab-dot connecting" id="tdot-${id}"></i><span class="sshterm-tab-name">${esc(nodeName)}</span><span class="sshterm-tab-close" data-id="${id}">‚úï</span>`;
      tabEl.onclick = e => {
        if(e.target.closest(".sshterm-tab-close")){
          closeSstSession(id);
        } else {
          switchSstTab(id);
        }
      };
      $("sstTabs").appendChild(tabEl);

      // WebSocket
      const proto = location.protocol === "https:" ? "wss:" : "ws:";
      const cols = term.cols || 220;
      const rows = term.rows || 50;
      const wsUrl = `${proto}//${location.host}/api/nodes/ssh/terminal?node_key=${encodeURIComponent(nodeKey)}&cols=${cols}&rows=${rows}`;
      const ws = new WebSocket(wsUrl);
      ws.binaryType = "arraybuffer";

      const session = {id, nodeKey, nodeName, ws, term, fitAddon, paneEl, tabEl, status:"connecting"};
      sstSessions[id] = session;

      ws.onopen = () => {};
      ws.onmessage = ev => {
        if(ev.data instanceof ArrayBuffer){
          term.write(new Uint8Array(ev.data));
        } else {
          try{
            const ctrl = JSON.parse(ev.data);
            if(ctrl.type === "connected"){
              sstSetStatus(id, "conn");
              if(fitAddon){ try{ fitAddon.fit(); }catch(_){} }
              const sz = {cols: term.cols, rows: term.rows};
              ws.send(JSON.stringify({type:"resize", cols:sz.cols, rows:sz.rows}));
            } else if(ctrl.type === "error"){
              sstSetStatus(id, "closed");
              term.write(`\r\n\x1b[1;31m[–û—à–∏–±–∫–∞: ${ctrl.message}]\x1b[0m\r\n`);
            } else if(ctrl.type === "closed"){
              sstSetStatus(id, "closed");
              term.write("\r\n\x1b[33m[–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ]\x1b[0m\r\n");
            }
          }catch(_){}
        }
      };
      ws.onerror = () => {
        sstSetStatus(id, "closed");
        term.write("\r\n\x1b[1;31m[WebSocket –æ—à–∏–±–∫–∞]\x1b[0m\r\n");
      };
      ws.onclose = () => {
        sstSetStatus(id, "closed");
      };

      // Input: terminal ‚Üí WS
      term.onData(data => {
        if(ws.readyState === WebSocket.OPEN){
          const encoded = new TextEncoder().encode(data);
          ws.send(encoded);
        }
      });

      // Resize
      term.onResize(({cols,rows}) => {
        if(ws.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({type:"resize", cols, rows}));
        }
      });

      switchSstTab(id);
      term.focus();
    }

    function sstSetStatus(id, status){
      const session = sstSessions[id];
      if(!session) return;
      session.status = status;
      const dot = document.getElementById(`tdot-${id}`);
      if(dot){
        dot.className = `sshterm-tab-dot ${status === "conn" ? "conn" : "closed"}`;
      }
      const st = $("sstStatus");
      if(st) st.textContent = "";
    }

    function switchSstTab(id){
      Object.values(sstSessions).forEach(s => {
        s.paneEl.classList.remove("active");
        s.tabEl.classList.remove("active");
      });
      const session = sstSessions[id];
      if(!session) return;
      session.paneEl.classList.add("active");
      session.tabEl.classList.add("active");
      // Fit after becoming visible
      setTimeout(() => {
        if(session.fitAddon){ try{ session.fitAddon.fit(); }catch(_){} }
        session.term.focus();
      }, 30);
    }

    function closeSstSession(id){
      const session = sstSessions[id];
      if(!session) return;
      try{ session.ws.close(); }catch(_){}
      try{ session.term.dispose(); }catch(_){}
      session.paneEl.remove();
      session.tabEl.remove();
      delete sstSessions[id];

      const remaining = Object.keys(sstSessions);
      if(remaining.length > 0){
        switchSstTab(remaining[remaining.length - 1]);
      } else {
        const emptyEl = $("sstEmptyState");
        if(emptyEl) emptyEl.style.display = "";
      }
    }

    function closeSstAll(){
      Object.keys(sstSessions).forEach(id => closeSstSession(id));
    }

    function renderSshterm(){
      loadSstNodes();
      // Handle window resize for active terminal
      const active = Object.values(sstSessions).find(s => s.paneEl.classList.contains("active"));
      if(active?.fitAddon){ try{ active.fitAddon.fit(); }catch(_){} }
    }

    // Resize observer for the terminal panel
    let sstResizeObs = null;
    function initSstResizeObserver(){
      const panel = $("sstPanel");
      if(!panel || sstResizeObs) return;
      if(window.ResizeObserver){
        sstResizeObs = new ResizeObserver(() => {
          const active = Object.values(sstSessions).find(s => s.paneEl.classList.contains("active"));
          if(active?.fitAddon){ try{ active.fitAddon.fit(); }catch(_){} }
        });
        sstResizeObs.observe(panel);
      }
    }

    function trafficStatusBadge(row){
      const st = String(row?.status || "").toLowerCase();
      if(st === "disabled" || st === "expired") return semanticBadge("offline", "off");
      if(row?.online || st === "online") return semanticBadge("online", "online");
      if(st === "active") return semanticBadge("warn", "active");
      if(st === "offline") return semanticBadge("offline", "offline");
      return semanticBadge("warn", st || "-");
    }

    function trafficRows(){
      return Array.isArray(trafficData?.rows) ? trafficData.rows : [];
    }

    function syncTrafficFilters(rows){
      const setFrom = (arr, fallback) => {
        if(Array.isArray(arr) && arr.length) return [...new Set(arr.map(v=>String(v||"").trim()).filter(Boolean))];
        return [...new Set((fallback||[]).map(v=>String(v||"").trim()).filter(Boolean))];
      };
      const tariffs = setFrom(trafficData?.filters?.tariffs, rows.map(r=>r.tariff));
      const nodes = setFrom(trafficData?.filters?.nodes, rows.map(r=>r.last_node_display || r.last_node));
      const statuses = setFrom(trafficData?.filters?.statuses, rows.map(r=>r.status));

      const fill = (id, title, values) => {
        const sel = $(id);
        if(!sel) return;
        const prev = sel.value || "all";
        sel.innerHTML = `<option value="all">${title}</option>` + values.sort((a,b)=>a.localeCompare(b,"ru")).map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
        sel.value = values.includes(prev) ? prev : "all";
      };
      fill("fTrafficTariff", "–¢–∞—Ä–∏—Ñ: –≤—Å–µ", tariffs);
      fill("fTrafficNode", "–ù–æ–¥—ã: –≤—Å–µ", nodes);
      fill("fTrafficStatus", "–°—Ç–∞—Ç—É—Å: –≤—Å–µ", statuses);
    }

    function filteredTrafficRows(){
      const rows = trafficRows();
      const q = String($("qTraffic")?.value || "").trim().toLowerCase();
      const tariff = String($("fTrafficTariff")?.value || "all");
      const node = String($("fTrafficNode")?.value || "all");
      const status = String($("fTrafficStatus")?.value || "all");

      return rows.filter(r=>{
        const rowTariff = String(r.tariff || "").trim();
        const rowNode = String(r.last_node_display || r.last_node || "").trim();
        const rowStatus = String(r.status || "").trim();
        if(tariff !== "all" && rowTariff !== tariff) return false;
        if(node !== "all" && rowNode !== node) return false;
        if(status !== "all" && rowStatus !== status) return false;
        if(!q) return true;
        const hay = [
          String(r.user_identifier || ""),
          String(r.username || ""),
          String(r.email || ""),
          rowTariff,
          rowNode,
          rowStatus
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function setTrafficPeriod(period){
      const next = String(period || "").trim();
      if(!next || next === trafficPeriod) return;
      trafficPeriod = next;
      document.querySelectorAll("#trafficPeriodGroup .seg-btn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.period === trafficPeriod);
      });
      load(false);
    }

    function renderTraffic(){
      const rows = trafficRows();
      syncTrafficFilters(rows);

      document.querySelectorAll("#trafficPeriodGroup .seg-btn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.period === trafficPeriod);
      });

      const summary = trafficData?.summary || {};
      $("kTrafficUsers").textContent = Number(summary.total_users || rows.length || 0);
      $("kTrafficOnline").textContent = Number(summary.online_users || 0);
      $("kTrafficUsed").textContent = fmtBytes(Number(summary.total_used_bytes || 0));
      $("kTrafficLimit").textContent = fmtBytes(Number(summary.total_limit_bytes || 0));

      const meta = trafficData?.meta || {};
      const metaParts = [];
      if(meta.period_supported === false) metaParts.push("–ò—Å—Ç–æ—Ä–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –ø–æ–∫–∞–∑–∞–Ω —Å—É–º–º–∞—Ä–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫.");
      if(meta.per_node_breakdown_supported === false) metaParts.push("–†–∞–∑–±–∏–≤–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –Ω–æ–¥–∞–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
      if(meta.generated_at) metaParts.push(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${t(meta.generated_at)}`);
      $("trafficMetaHint").textContent = metaParts.join(" ");

      const filtered = filteredTrafficRows();
      $("tbTraffic").innerHTML = filtered.map(r=>{
        const usedGB = (Number(r.used_traffic_bytes || 0) / (1024**3));
        const lifeGB = (Number(r.lifetime_used_traffic_bytes || 0) / (1024**3));
        const limitGB = (Number(r.traffic_limit_bytes || 0) / (1024**3));
        const coverage = Number(r.used_percent || 0);
        const coverageBadge = Number(r.traffic_limit_bytes || 0) > 0
          ? `<span class="badge ${coverage >= 100 ? "b-red" : (coverage >= 80 ? "b-amber" : "b-green")}">${coverage.toFixed(1)}%</span>`
          : '<span class="badge">–±–µ–∑ –ª–∏–º–∏—Ç–∞</span>';
        const node = resolveNodeLabel(r.last_node_display, r.last_node);
        const user = renderUserCell(r.user_identifier, r.username || r.email || "");
        return `<tr>
          <td>${user}</td>
          <td>${esc(r.tariff || r.tag || "-")}</td>
          <td>${r.device_limit>0?`<span class="badge b-blue">${r.device_limit}</span>`:"-"}</td>
          <td>${r.connected_ips>0?`<span class="badge b-green">${r.connected_ips}</span>`:`<span class="badge">${Number(r.connected_ips||0)}</span>`}</td>
          <td>${usedGB.toFixed(2)}</td>
          <td>${lifeGB.toFixed(2)}</td>
          <td>${limitGB > 0 ? limitGB.toFixed(2) : "-"}</td>
          <td>${coverageBadge}</td>
          <td>${t(r.first_connected_at || r.online_at)}</td>
          <td>${t(r.expire_at)}</td>
          <td>${esc(node)}</td>
          <td>${trafficStatusBadge(r)}</td>
        </tr>`;
      }).join("") || emptyRow(12, "‚óå", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç—Ä–∞—Ñ–∏–∫—É", "–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ API —Ç—Ä–∞—Ñ–∏–∫–∞");
      bindUserOpenLinks($("tbTraffic"));
    }

    function renderViolators(v){
      violatorSel = new Set();
      updateViolBulkBar();
      $("tbViolators").innerHTML = v.map(u=>{
        const nodePrimary = resolveNodeLabel(u.last_node_display, u.last_node);
        const node = nodePrimary !== "unknown"
          ? nodePrimary
          : resolveNodeLabel(u.sharing?.last_node_display, u.sharing?.last_node);
        const when = u.heuristics?.last_event_at || u.last_seen_at || u.sharing?.last_trigger_at || u.sharing?.violator_since || "";
        const sh = u.sharing;
        const hits = sh ? Number(sh.trigger_hits||0) : 0;
        const req = sh ? Math.max(1, Number(sh.trigger_required||1)) : 1;
        const pct = Math.min(100, Math.round(hits/req*100));
        const full = hits >= req;
        const trigBar = `<div class="trig-wrap"><span class="trig-text">${hits}/${req}</span><div class="trig-bar"><div class="trig-fill${full?' full':''}" style="width:${pct}%"></div></div></div>`;
        return `<tr>
          <td class="td-check"><input type="checkbox" class="viol-cb" data-id="${esc(u.user_identifier)}"></td>
          <td>${renderUserCell(u.user_identifier, u.username)}</td>
          <td><span class="badge b-red">${u.ip_count}</span></td>
          <td>${u.limit}</td>
          <td>${trigBar}</td>
          <td>${esc(node)}</td>
          <td>${when ? t(when) : "-"}</td>
        </tr>`;
      }).join("")
        || emptyRow(7, "‚úì", "–ù–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –Ω–µ—Ç", "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤");
      bindUserOpenLinks($("tbViolators"));
      $("tbViolators").querySelectorAll(".viol-cb").forEach(cb=>{
        cb.onchange = () => {
          if(cb.checked) violatorSel.add(cb.dataset.id);
          else violatorSel.delete(cb.dataset.id);
          updateViolBulkBar();
          $("violCheckAll").checked = false;
        };
      });
    }

    function updateViolBulkBar(){
      const bar = $("violBulkBar");
      const cnt = $("violBulkCount");
      if(violatorSel.size > 0){
        bar.classList.add("show");
        cnt.textContent = `${violatorSel.size} –≤—ã–±—Ä–∞–Ω–æ`;
      } else {
        bar.classList.remove("show");
      }
    }

    function renderBan(){
      banSel = new Set();
      updateBanBulkBar();
      const userRows = Array.isArray(sharingBanUsers) ? sharingBanUsers : [];
      if (userRows.length > 0) {
        $("tbBan").innerHTML = userRows.map(b=>{
          const banCount = getBanCount(b.user_identifier);
          return `<tr>
            <td class="td-check"><input type="checkbox" class="ban-cb" data-id="${esc(b.user_identifier)}"></td>
            <td>${renderUserCell(b.user_identifier, b.username)}</td>
            <td>${esc((b.violation_ips||[]).slice(0,3).join(", ") || "-")}</td>
            <td>${Number.isFinite(Number(b.limit)) ? b.limit : "-"}</td>
            <td>${banCount !== "-" ? `<span class="badge b-red">${banCount}</span>` : "-"}</td>
            <td>${t(b.banlist_since || b.violator_since)}</td>
            <td>${Number.isFinite(Number(b.duration_seconds)) ? `${b.duration_seconds} —Å–µ–∫` : "-"}</td>
          </tr>`;
        }).join("") || emptyRow(7, "üîí", "–ë–∞–Ω-–ª–∏—Å—Ç –ø—É—Å—Ç", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–Ω-–ª–∏—Å—Ç–µ –Ω–µ—Ç");
        bindUserOpenLinks($("tbBan"));
        $("tbBan").querySelectorAll(".ban-cb").forEach(cb=>{
          cb.onchange = () => {
            if(cb.checked) banSel.add(cb.dataset.id);
            else banSel.delete(cb.dataset.id);
            updateBanBulkBar();
            $("banCheckAll").checked = false;
          };
        });
        return;
      }

      const rows = Array.isArray(activeBans) ? activeBans : [];
      $("tbBan").innerHTML = rows.map(b=>{
        const userId = Array.isArray(b.users) && b.users.length ? b.users[0] : "";
        const banCount = userId ? getBanCount(userId) : "-";
        return `<tr>
          <td class="td-check"><input type="checkbox" class="ban-cb" data-id="${esc(userId)}"></td>
          <td>${(Array.isArray(b.users) && b.users.length ? b.users : ["-"]).map(uid=>`<div>${renderUserCell(uid)}</div>`).join("")}</td>
          <td>${esc(b.ip || "-")}</td>
          <td>-</td>
          <td>${banCount !== "-" ? `<span class="badge b-red">${banCount}</span>` : "-"}</td>
          <td>${t(b.set_at)}</td>
          <td>${b.seconds_left>0 ? `${b.seconds_left} —Å–µ–∫` : (b.duration || "-")}</td>
        </tr>`;
      }).join("") || emptyRow(7, "üîí", "–ë–∞–Ω-–ª–∏—Å—Ç –ø—É—Å—Ç", "–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–µ—Ç");
      bindUserOpenLinks($("tbBan"));
      $("tbBan").querySelectorAll(".ban-cb").forEach(cb=>{
        cb.onchange = () => {
          const id = cb.dataset.id;
          if(!id) return;
          if(cb.checked) banSel.add(id);
          else banSel.delete(id);
          updateBanBulkBar();
          $("banCheckAll").checked = false;
        };
      });
    }

    function updateBanBulkBar(){
      const bar = $("banBulkBar");
      const cnt = $("banBulkCount");
      if(banSel.size > 0){
        bar.classList.add("show");
        cnt.textContent = `${banSel.size} –≤—ã–±—Ä–∞–Ω–æ`;
      } else {
        bar.classList.remove("show");
      }
    }

    function updateUsersBulkBar(){
      const bar = $("usersBulkBar");
      const cnt = $("usersBulkCount");
      if(!bar || !cnt) return;
      if(usersSel.size > 0){
        bar.classList.add("show");
        cnt.textContent = `${usersSel.size} –≤—ã–±—Ä–∞–Ω–æ`;
      } else {
        bar.classList.remove("show");
      }
    }

    async function bulkBlockUsers(ids){
      if(!ids || ids.size === 0) return;
      const arr = [...ids];
      const duration = $("usersBulkDuration")?.value || "1h";
      const reason = await askReason(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${arr.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${duration}. –ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):`);
      if(reason === null) return;
      let ok = 0, fail = 0;
      for(const id of arr){
        try{
          await api("/api/actions/block",{method:"POST",body:JSON.stringify({user_identifier:id,duration,reason:reason||"bulk_block"})});
          ok++;
        }catch{ fail++; }
      }
      showNotice(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${ok}${fail>0?`, –æ—à–∏–±–æ–∫: ${fail}`:""}`, fail>0?"err":"ok");
      await load(true);
    }

    function getBanCount(userId) {
      const u = (users||[]).find(u => String(u.user_identifier||"") === String(userId||""));
      const bc = Number(u?.sharing?.ban_count);
      return Number.isFinite(bc) ? bc : "-";
    }

    function renderActiveBans(){
      const rows = Array.isArray(activeBans) ? activeBans : [];
      $("tbActiveBans").innerHTML = rows.map(b=>{
        const userLinks = (Array.isArray(b.users) && b.users.length ? b.users : []).slice(0,3)
          .map(uid=>`<div>${renderUserCell(uid)}</div>`).join("") || "-";
        const expiresAt = b.expires_at || "";
        const left = until(expiresAt);
        const expired = b.seconds_left <= 0;
        return `<tr>
          <td><span class="badge b-blue">${esc(b.ip||"-")}</span></td>
          <td>${userLinks}</td>
          <td>${esc(b.node_name||"-")}</td>
          <td>${t(b.set_at)}</td>
          <td>${esc(b.duration||"-")}</td>
          <td><span class="countdown${expired?' expired':''}">${left}</span></td>
        </tr>`;
      }).join("") || emptyRow(6, "üîì", "–ê–∫—Ç–∏–≤–Ω—ã—Ö IP-–±–∞–Ω–æ–≤ –Ω–µ—Ç", "–ù–æ–≤—ã–µ –±–∞–Ω—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏");
      bindUserOpenLinks($("tbActiveBans"));
    }

    function renderPermBan(){
      const rows = Array.isArray(permanentSharers) ? permanentSharers : [];
      $("tbPermBan").innerHTML = rows.map(b=>`<tr>
        <td>${renderUserCell(b.user_identifier, b.username)}</td>
        <td>${esc((b.violation_ips||[]).slice(0,3).join(", ") || "-")}</td>
        <td>${Number.isFinite(Number(b.limit)) ? b.limit : "-"}</td>
        <td>${Number.isFinite(Number(b.trigger_hits)) && Number.isFinite(Number(b.trigger_required)) ? `${b.trigger_hits}/${b.trigger_required}` : "-"}</td>
        <td>${esc((b.violation_nodes||[]).slice(0,3).map(displayNodeName).join(", ") || resolveNodeLabel(b.last_node_display, b.last_node) || "-")}</td>
        <td>${t(b.permanent_ban_since || b.banlist_since || b.violator_since)}</td>
      </tr>`).join("") || emptyRow(6, "‚ò†", "–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã—Ö –±–∞–Ω–æ–≤ –Ω–µ—Ç", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º —à–∞—Ä–∏–Ω–≥–æ–º –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å");
      bindUserOpenLinks($("tbPermBan"));
    }

    function renderNet(){
      const rows = Array.isArray(networkTypes) ? networkTypes : [];
      const badgeClass = (t)=>{
        const tp = String(t||"unknown").toLowerCase();
        if(tp==="mobile") return "b-amber";
        if(tp==="wifi") return "b-cyan";
        if(tp==="cable") return "b-blue";
        return "";
      };
      $("tbNet").innerHTML = rows.map(r=>`<tr>
        <td><span class="badge ${badgeClass(r.network_type)}">${esc(netTypeName(r.network_type))}</span></td>
        <td><span class="badge b-blue">${r.users_count||0}</span></td>
        <td>${r.ips_count||0}</td>
        <td>${(r.providers||[]).slice(0,3).map(esc).join(", ") || "-"}</td>
        <td>${(r.examples||[]).slice(0,6).map(esc).join(", ") || "-"}</td>
      </tr>`).join("") || emptyRow(5, "‚óå", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∏–ø–∞–º —Å–µ—Ç–µ–π", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–æ–≥–æ–≤");
    }

    function buildIPUsageMap(sourceUsers=users){
      const usage = new Map();
      for(const u of (Array.isArray(sourceUsers) ? sourceUsers : [])){
        const uid = String(u?.user_identifier || "").trim();
        const uname = String(displayName(u) || uid || "-").trim();
        if(!uid) continue;
        const seen = new Set();
        for(const rawIP of (Array.isArray(u?.active_ips) ? u.active_ips : [])){
          const ip = String(rawIP || "").trim();
          if(!ip || seen.has(ip)) continue;
          seen.add(ip);
          if(!usage.has(ip)) usage.set(ip, {count:0, ids:[], names:[]});
          const row = usage.get(ip);
          row.count += 1;
          row.ids.push(uid);
          row.names.push(uname);
        }
      }
      return usage;
    }

    function renderShared(){
      const usage = buildIPUsageMap(users);
      const rows = [...usage.entries()]
        .filter(([,row]) => Number(row?.count || 0) > 1)
        .sort((a,b) => (Number(b[1]?.count || 0) - Number(a[1]?.count || 0)));

      $("tbShared").innerHTML = rows.map(([ip,row])=>{
        const ids = Array.isArray(row?.ids) ? row.ids : [];
        const count = Number(row?.count || ids.length || 0);
        const hint = ids.join(", ");
        const links = ids.map(uid => `<div>${renderUserCell(uid)}</div>`).join("") || "-";
        return `<tr>
          <td><span class="badge b-blue">${esc(ip)}</span></td>
          <td title="${esc(hint)}"><span class="badge b-red">${count}</span></td>
          <td>${links}</td>
        </tr>`;
      }).join("") || emptyRow(3, "‚óâ", "–û–±—â–∏—Ö IP –Ω–µ—Ç", "–ö–∞–∂–¥—ã–π IP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
      bindUserOpenLinks($("tbShared"));
    }

    function logCategory(tp){
      const t = String(tp || "").toLowerCase();
      if (t === "block_published" || t === "manual_block" || t === "manual_unblock") return "block";
      if (t === "limit_exceeded" || t === "limit_exceeded_ignored") return "violation";
      if (t.includes("sharing") || t.includes("permanent") || t.includes("banlist")) return "pending";
      return "info";
    }

    function renderLogs(){
      const rows = Array.isArray(logs) ? logs : [];
      const typeBadge = (tp) => {
        const t = String(tp || "").toLowerCase();
        if (t === "block_published" || t === "manual_block") return '<span class="badge b-red">BLOCK</span>';
        if (t === "manual_unblock") return '<span class="badge b-cyan">UNBLOCK</span>';
        if (t === "limit_exceeded") return '<span class="badge b-amber">VIOLATION</span>';
        if (t === "limit_exceeded_ignored") return '<span class="badge">IGNORED</span>';
        if (t === "sharing_pending" || t === "sharing_pending_banlist") return '<span class="badge b-blue">PENDING</span>';
        if (t === "heuristics_rejected") return '<span class="badge b-blue">REJECTED</span>';
        if (t === "network_policy_rejected") return '<span class="badge b-blue">NET_GUARD</span>';
        if (t === "permanent_ban_applied") return '<span class="badge b-red">PERM_BAN</span>';
        if (t === "permanent_ban_failed") return '<span class="badge b-amber">PERM_FAIL</span>';
        if (t === "permanent_ban_skipped") return '<span class="badge">PERM_SKIP</span>';
        if (t === "node_switch") return '<span class="badge b-cyan">NODE_SWITCH</span>';
        if (t === "network_type_changed") return '<span class="badge b-amber">NET_TYPE</span>';
        if (t === "node_parallel") return '<span class="badge b-cyan">PARALLEL</span>';
        if (t === "new_ip") return '<span class="badge b-green">NEW_IP</span>';
        if (t === "sharing_state_reset") return '<span class="badge b-cyan">RESET</span>';
        return `<span class="badge">${esc(String(tp||"event").toUpperCase())}</span>`;
      };

      const filtered = rows.filter(r => logFilters.has(logCategory(r.type)));

      const logRowCls = (tp) => {
        const cat = logCategory(tp);
        if(cat==="block") return "log-block";
        if(cat==="violation") return "log-violation";
        if(tp==="manual_unblock") return "log-unblock";
        if(cat==="pending") return "log-pending";
        return "";
      };
      $("tbLogs").innerHTML = filtered.map(r=>`<tr class="${logRowCls(r.type)}">
        <td style="white-space:nowrap">${t(r.timestamp)}</td>
        <td>${esc(r.user_identifier || "-")}</td>
        <td>${typeBadge(r.type)}</td>
        <td>${esc(r.source_ip || "-")}</td>
        <td>${esc(displayNodeName(r.node_name || "-"))}</td>
        <td>${esc(r.message || "-")}</td>
      </tr>`).join("") || emptyRow(6, "‚ñ™", "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π", "–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞");
    }

    function renderHwid(){
      $("tbHwid").innerHTML=users.map(u=>`<tr><td>${esc(u.user_identifier)}</td><td><span class="badge ${u.exceeds?'st-offline':'b-blue'}">${u.ip_count}</span></td><td>${u.limit}</td><td>${u.exceeds?semanticBadge("warn","–ü—Ä–µ–≤—ã—à–µ–Ω"):semanticBadge("online","–ù–æ—Ä–º–∞")}</td></tr>`).join("")
        || emptyRow(4, "‚óâ", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ HWID", "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π");
    }

    function cfgFormatValue(type, value){
      if(type === "bool") return value ? "‚úì" : "‚úó";
      if(type === "list") return Array.isArray(value) ? value.join(", ") : (value || "-");
      return value !== undefined && value !== null ? String(value) : "-";
    }

    function renderConfigEditor(d){
      const el = $("cfgEditor");
      if(!el) return;
      const overrides = d.runtime_overrides || {};
      const hasOverride = (key)=>Object.prototype.hasOwnProperty.call(overrides, key);
      const renderLabelCell = (row, hint)=>`<div class="cfg-edit-label">
        <div class="cfg-edit-title">${esc(row.label)} ${hint}</div>
        ${row.help ? `<div class="cfg-edit-help"><b>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:</b> ${esc(row.help)}</div>` : ""}
        ${row.note ? `<div class="cfg-edit-note"><b>–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:</b> ${esc(row.note)}</div>` : ""}
        ${row.example ? `<div class="cfg-edit-example"><b>–ü—Ä–∏–º–µ—Ä:</b> ${esc(String(row.example))}</div>` : ""}
      </div>`;

      const rows = CONFIG_EDIT_SCHEMA.map(row=>{
        const key = row.key;
        const value = d[key];
        const hint = hasOverride(key) ? `<span class="badge b-amber">override</span>` : `<span class="badge">base</span>`;
        if(row.type === "bool"){
          const selected = !!value;
          return `<tr>
            <td>${renderLabelCell(row, hint)}</td>
            <td>
              <select id="cfgEdit_${esc(key)}" class="select" style="min-width:140px">
                <option value="true" ${selected ? "selected" : ""}>–í–∫–ª—é—á–µ–Ω–æ</option>
                <option value="false" ${!selected ? "selected" : ""}>–í—ã–∫–ª—é—á–µ–Ω–æ</option>
              </select>
            </td>
          </tr>`;
        }
        const inputType = row.type === "int" ? "number" : "text";
        const attrs = [];
        if(row.type === "int"){
          if(Number.isFinite(row.min)) attrs.push(`min="${row.min}"`);
          if(Number.isFinite(row.max)) attrs.push(`max="${row.max}"`);
          attrs.push(`step="1"`);
        }
        const textValue = row.type === "list"
          ? (Array.isArray(value) ? value.join(", ") : String(value || ""))
          : String(value ?? "");
        const placeholder = String(row.placeholder || "");
        const title = [row.help, row.note, row.example].filter(Boolean).join(" | ");
        return `<tr>
          <td>${renderLabelCell(row, hint)}</td>
          <td><input id="cfgEdit_${esc(key)}" type="${inputType}" class="input" style="width:100%;min-width:220px" value="${esc(textValue)}" placeholder="${esc(placeholder)}" title="${esc(title || row.label)}" ${attrs.join(" ")}></td>
        </tr>`;
      });

      el.innerHTML = `<div class="table-wrap"><table class="cfg-table"><tbody>${rows.join("")}</tbody></table></div>
      <p class="muted" style="margin-top:8px">–§–æ—Ä–º–∞—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: <code>30s</code>, <code>5m</code>, <code>2h</code>, <code>1d</code>, <code>permanent</code>. –°–ø–∏—Å–æ–∫ —Å—Ç—É–ø–µ–Ω–µ–π: —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.</p>`;
    }

    function collectConfigEditorPayload(){
      const payload = {};
      for(const row of CONFIG_EDIT_SCHEMA){
        const el = $(`cfgEdit_${row.key}`);
        if(!el) continue;
        const raw = String(el.value ?? "").trim();
        if(row.type === "bool"){
          payload[row.key] = raw === "true";
          continue;
        }
        if(row.type === "int"){
          const n = Number(raw);
          if(!Number.isInteger(n)) throw new Error(`${row.label}: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ`);
          if(Number.isFinite(row.min) && n < row.min) throw new Error(`${row.label}: –º–∏–Ω–∏–º—É–º ${row.min}`);
          if(Number.isFinite(row.max) && n > row.max) throw new Error(`${row.label}: –º–∞–∫—Å–∏–º—É–º ${row.max}`);
          payload[row.key] = n;
          continue;
        }
        if(row.type === "duration"){
          if(!/^(\d+[smhd]|permanent)$/i.test(raw)) throw new Error(`${row.label}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏`);
          payload[row.key] = raw;
          continue;
        }
        if(row.type === "list"){
          const arr = raw.split(",").map(s=>s.trim()).filter(Boolean);
          if(arr.some(x=>!/^(\d+[smhd]|permanent)$/i.test(x))){
            throw new Error(`${row.label}: —Å–ø–∏—Å–æ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏`);
          }
          payload[row.key] = arr;
          continue;
        }
        payload[row.key] = raw;
      }
      return payload;
    }

    function renderConfig(){
      const el = $("cfgPanel");
      if(!el) return;
      const d = cfgData;
      if(!d || Object.keys(d).length === 0){
        el.innerHTML = '<p class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</p>';
        const editor = $("cfgEditor");
        if(editor) editor.innerHTML = '<p class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      renderConfigEditor(d);
      const ov = d.runtime_overrides || {};
      const hasOv = key => Object.prototype.hasOwnProperty.call(ov, key);
      const rows = CONFIG_EDIT_SCHEMA.map(row=>[
        hasOv(row.key) ? `${row.label} (override)` : row.label,
        cfgFormatValue(row.type, d[row.key])
      ]);
      el.innerHTML = `<div class="table-wrap"><table class="cfg-table"><tbody>${
        rows.map(([k,v])=>`<tr><td>${esc(k)}</td><td>${esc(v)}</td></tr>`).join("")
      }</tbody></table></div>`;
    }

    const CHART_COLORS = {
      green: 'rgba(36,196,122,.85)', amber: 'rgba(255,190,59,.85)',
      red: 'rgba(255,84,119,.85)', blue: 'rgba(79,113,255,.85)',
      cyan: 'rgba(18,201,232,.85)', muted: 'rgba(143,164,201,.55)'
    };
    const CHART_GRID = 'rgba(36,53,82,.5)';
    const CHART_TICK = '#8fa4c9';
    const CHART_LEGEND = { color: '#b7caef', font: { size: 12, weight: '700' } };

    function renderCharts(){
      const normal = users.filter(u=>!u.exceeds&&!u.blocked).length;
      const violatorsCount = users.filter(u=>u.exceeds&&!u.blocked).length;
      const banlistCount = Array.isArray(sharingBanUsers) ? sharingBanUsers.length : 0;
      const permCount = Array.isArray(permanentSharers) ? permanentSharers.length : 0;
      const ctx1 = document.getElementById('chartStatus');
      if(ctx1){
        if(chartStatus){
          chartStatus.data.datasets[0].data = [normal,violatorsCount,banlistCount,permCount];
          chartStatus.update('none');
        } else {
          chartStatus = new Chart(ctx1, {
            type: 'doughnut',
            data: {
              labels: ['–ù–æ—Ä–º–∞','–ù–∞—Ä—É—à–∏—Ç–µ–ª–∏','–ë–∞–Ω-–ª–∏—Å—Ç','–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç'],
              datasets:[{
                data:[normal,violatorsCount,banlistCount,permCount],
                backgroundColor:[CHART_COLORS.green,CHART_COLORS.amber,CHART_COLORS.red,CHART_COLORS.blue],
                borderColor:['#24c47a','#ffbe3b','#ff5477','#4f71ff'],
                borderWidth:1, hoverOffset:6
              }]
            },
            options:{responsive:true,maintainAspectRatio:false,cutout:'62%',plugins:{legend:{labels:CHART_LEGEND,position:'bottom'}}}
          });
        }
      }

      const netRows = Array.isArray(networkTypes)?networkTypes:[];
      const netLabels = netRows.length ? netRows.map(r=>netTypeName(r.network_type)) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
      const netCounts = netRows.length ? netRows.map(r=>r.users_count||0) : [0];
      const netBg = netRows.length ? netRows.map(r=>{
        const tp=String(r.network_type||'').toLowerCase();
        if(tp==='mobile') return CHART_COLORS.amber;
        if(tp==='wifi') return CHART_COLORS.cyan;
        if(tp==='cable') return CHART_COLORS.blue;
        return CHART_COLORS.muted;
      }) : [CHART_COLORS.muted];
      const ctx2 = document.getElementById('chartNetwork');
      if(ctx2){
        if(chartNetwork){
          chartNetwork.data.labels = netLabels;
          chartNetwork.data.datasets[0].data = netCounts;
          chartNetwork.data.datasets[0].backgroundColor = netBg;
          chartNetwork.update('none');
        } else {
          chartNetwork = new Chart(ctx2, {
            type:'bar',
            data:{labels:netLabels,datasets:[{label:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',data:netCounts,backgroundColor:netBg,borderRadius:6,borderWidth:0}]},
            options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:CHART_TICK},grid:{color:CHART_GRID}},y:{ticks:{color:CHART_TICK,precision:0},grid:{color:CHART_GRID},beginAtZero:true}}}
          });
        }
      }

      const onlineN = (nodeHealth||[]).filter(n=>n.online).length;
      const offlineN = (nodeHealth||[]).length - onlineN;
      const ctx3 = document.getElementById('chartNodes');
      if(ctx3){
        if(chartNodes){
          chartNodes.data.datasets[0].data = [onlineN||0,offlineN||0];
          chartNodes.update('none');
        } else {
          chartNodes = new Chart(ctx3, {
            type:'doughnut',
            data:{labels:['–û–Ω–ª–∞–π–Ω','–û—Ñ—Ñ–ª–∞–π–Ω'],datasets:[{data:[onlineN||0,offlineN||0],backgroundColor:[CHART_COLORS.green,CHART_COLORS.red],borderColor:['#24c47a','#ff5477'],borderWidth:1,hoverOffset:6}]},
            options:{responsive:true,maintainAspectRatio:false,cutout:'62%',plugins:{legend:{labels:CHART_LEGEND,position:'bottom'}}}
          });
        }
      }

      const ctx4 = document.getElementById('chartTrend');
      if(ctx4 && trendHistory.timestamps.length > 0){
        if(chartTrend){
          chartTrend.data.labels = [...trendHistory.timestamps];
          chartTrend.data.datasets[0].data = [...trendHistory.activeUsers];
          chartTrend.data.datasets[1].data = [...trendHistory.violators];
          chartTrend.data.datasets[2].data = [...trendHistory.bans];
          chartTrend.update('none');
        } else {
          chartTrend = new Chart(ctx4, {
            type:'line',
            data:{
              labels: trendHistory.timestamps,
              datasets:[
                {label:'–û–Ω–ª–∞–π–Ω',data:[...trendHistory.activeUsers],borderColor:'rgba(36,196,122,.9)',backgroundColor:'rgba(36,196,122,.08)',tension:.35,pointRadius:0,borderWidth:2,fill:true},
                {label:'–ù–∞—Ä—É—à–∏—Ç–µ–ª–∏',data:[...trendHistory.violators],borderColor:'rgba(255,190,59,.9)',backgroundColor:'rgba(255,190,59,.07)',tension:.35,pointRadius:0,borderWidth:2,fill:true},
                {label:'–ë–∞–Ω—ã',data:[...trendHistory.bans],borderColor:'rgba(255,84,119,.9)',backgroundColor:'rgba(255,84,119,.07)',tension:.35,pointRadius:0,borderWidth:2,fill:true}
              ]
            },
            options:{
              responsive:true,maintainAspectRatio:false,animation:false,
              plugins:{legend:{labels:CHART_LEGEND,position:'bottom'}},
              scales:{
                x:{ticks:{color:CHART_TICK,maxTicksLimit:8,maxRotation:0},grid:{color:CHART_GRID}},
                y:{ticks:{color:CHART_TICK,precision:0},grid:{color:CHART_GRID},beginAtZero:true}
              }
            }
          });
        }
      }
    }

    function tlTypeLabel(type){
      const t=String(type||"").toLowerCase();
      const L={
        block_published:"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",manual_block:"–ë–∞–Ω –≤—Ä—É—á–Ω—É—é",manual_unblock:"–†–∞–∑–±–∞–Ω –≤—Ä—É—á–Ω—É—é",
        limit_exceeded:"–õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω",limit_exceeded_ignored:"–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ",
        sharing_pending:"–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤",sharing_pending_banlist:"–û–∂–∏–¥–∞–Ω–∏–µ ban-list",
        banlist_added:"–î–æ–±–∞–≤–ª–µ–Ω –≤ ban-list",violator_started:"–°—Ç–∞—Ç—É—Å –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è",violator_cleared:"–°—Ç–∞—Ç—É—Å —Å–Ω—è—Ç",
        new_ip:"–ù–æ–≤—ã–π IP",node_switch:"–°–º–µ–Ω–∞ –Ω–æ–¥—ã",node_parallel:"–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã",
        network_type_changed:"–¢–∏–ø —Å–µ—Ç–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è",
        permanent_ban_applied:"–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω",permanent_ban_failed:"–û—à–∏–±–∫–∞ –ø–µ—Ä–º–±–∞–Ω–∞",permanent_ban_skipped:"–ü–µ—Ä–º–±–∞–Ω –ø—Ä–æ–ø—É—â–µ–Ω",
        clear_done:"IP –æ—á–∏—â–µ–Ω—ã",clear_scheduled:"–û—á–∏—Å—Ç–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞",clear_failed:"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏",clear_canceled:"–û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞",
        alert_sent:"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",alert_failed:"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
        alert_sent_permanent:"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø–µ—Ä–º–±–∞–Ω)",alert_failed_permanent:"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–µ—Ä–º–±–∞–Ω)",
        geo_sharing_detected:"–ì–µ–æ-—à–∞—Ä–∏–Ω–≥",sharing_state_reset:"–°–±—Ä–æ—Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤",
        process_error:"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏",block_skipped:"–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞",block_failed:"–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏",
      };
      return L[t]||String(type||"—Å–æ–±—ã—Ç–∏–µ").replace(/_/g," ");
    }

    function tlMsgHtml(type,msg,sourceIp){
      const t=String(type||"").toLowerCase();
      const ipHtml=sourceIp?` <span class="tl-ip">${esc(sourceIp)}</span>`:"";
      if(t==="sharing_pending_banlist"||t==="sharing_pending"){
        const srcM=(msg||"").match(/sources=(\d+)\/(\d+)/);
        const trgM=(msg||"").match(/triggers=(\d+)\/(\d+)/);
        if(srcM&&trgM){
          const sc=parseInt(srcM[1]),sl=parseInt(srcM[2]);
          const th=parseInt(trgM[1]),tr=parseInt(trgM[2]);
          const dots=Array.from({length:tr},(_,i)=>`<span class="tl-trig ${i<th?'hit':'miss'}"></span>`).join("");
          const srcC=sc>sl?"var(--red)":"var(--green)";
          return `<span style="color:var(--muted)">IP</span> <b style="color:${srcC}">${sc}</b><span style="color:var(--muted)">/${sl}</span>&ensp;<span style="color:var(--muted)">–¢—Ä–∏–≥–≥–µ—Ä—ã</span> <span class="tl-trigs">${dots}</span> <b style="color:var(--blue)">${th}/${tr}</b>${ipHtml}`;
        }
      }
      return `${esc(msg||"-")}${ipHtml}`;
    }

    function tlDotClass(type){
      const t = String(type||"").toLowerCase();
      if(t==="block_published"||t==="manual_block") return "block";
      if(t==="manual_unblock") return "unblock";
      if(t==="limit_exceeded"||t==="limit_exceeded_ignored") return "violation";
      if(t.includes("permanent")) return "perm";
      if(t.includes("geo")) return "geo";
      if(t==="sharing_pending"||t==="sharing_pending_banlist"||t==="banlist_added"||t==="violator_started") return "pending";
      return "";
    }

    async function openUser(id, silent=false){
      openCardId = id;
      try{
        const d = await api(`/api/users/${encodeURIComponent(id)}`);
        
        const name = (d.username && String(d.username).trim()) ? d.username : d.user_identifier;
        const history = (d.history || []).slice(0, 10);
        const firstActivity = d.first_activity_at || (history.length ? history[history.length - 1].timestamp : "");
        const lastActivity = d.last_activity_at || d.last_seen_at || d.heuristics?.last_event_at || (history.length ? history[0].timestamp : "");
        const totalEvents = Number.isFinite(Number(d.total_events)) ? Number(d.total_events) : history.length;
        const blockedEvents = Number.isFinite(Number(d.blocked_events))
          ? Number(d.blocked_events)
          : countByTypes(history, ["block_published", "manual_block"]);
        const sharing = d.sharing || null;
        const triggerInfo = sharing ? `${sharing.trigger_hits}/${sharing.trigger_required}` : "-";
        const banlistStatus = sharing?.in_banlist ? "–î–∞" : "–ù–µ—Ç";
        const permanentBanStatus = sharing?.permanent_ban ? "–î–∞" : "–ù–µ—Ç";
        const permanentBanSince = sharing?.permanent_ban_since || "";
        const concurrentInfo = sharing ? `${sharing.concurrent_ips}/${sharing.concurrent_limit}` : "-";
        const concurrentState = sharing ? (sharing.current_exceeds_in_window ? "–î–∞" : "–ù–µ—Ç") : "-";
        const windowSeconds = Number.isFinite(Number(sharing?.trigger_period_seconds)) ? Number(sharing.trigger_period_seconds) : 30;
        const banCount = Number.isFinite(Number(sharing?.ban_count)) ? Number(sharing.ban_count) : 0;
        const geoCountries = Array.isArray(sharing?.geo_countries) ? sharing.geo_countries : [];
        const geoMismatch = sharing?.geo_mismatch || false;
        const nodeName = resolveNodeLabel(d.last_node_display, d.last_node);
        const ipRows = Array.isArray(d.active_ips) ? d.active_ips : [];
        const ipUsage = buildIPUsageMap(users);
        const sourceSet = new Set(ipRows.map(ip => String(ip.subnet24 || ip.ip || "").trim()).filter(Boolean));
        const sourceCount = sourceSet.size;
        const networkCounters = { mobile: 0, wifi: 0, cable: 0, unknown: 0 };
        for (const ip of ipRows) {
          const tp = String(ip.network_type || "unknown").toLowerCase();
          if (Object.prototype.hasOwnProperty.call(networkCounters, tp)) networkCounters[tp] += 1;
          else networkCounters.unknown += 1;
        }
        const networkSummary = `–°–æ—Ç–æ–≤—ã–π: ${networkCounters.mobile}, Wi-Fi: ${networkCounters.wifi}, –ö–∞–±–µ–ª—å–Ω—ã–π: ${networkCounters.cable}, –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ: ${networkCounters.unknown}`;
        const activeNodeList = [...new Set(
          ipRows.map(ip => String(resolveNodeLabel(ip.node_display, ip.node_name)).trim()).filter(Boolean)
        )];
        if (activeNodeList.length === 0 && nodeName && nodeName !== "unknown") {
          activeNodeList.push(nodeName);
        }
        const nodeBadges = activeNodeList.length
          ? activeNodeList.map(n => `<span class="badge b-cyan">${esc(n)}</span>`).join("")
          : '<span class="badge">unknown</span>';
        const parallelLive = activeNodeList.length >= 2;
        const lastParallelEvent = history.find(h => String(h.type || "").toLowerCase() === "node_parallel");
        const parallelSince = lastParallelEvent?.timestamp || "";
        const connectionBadge = d.online ? semanticBadge("online", "–û–Ω–ª–∞–π–Ω") : semanticBadge("offline", "–û—Ñ—Ñ–ª–∞–π–Ω");
        const blockedNow = !!d.blocked_now;
        const statusBadge = blockedNow
          ? semanticBadge("offline", "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
          : (d.exceeds ? semanticBadge("warn", "–ù–∞—Ä—É—à–∏—Ç–µ–ª—å") : semanticBadge("online", "–ù–æ—Ä–º–∞"));
        const warning = blockedNow
          ? `<div class="warn-box"><b>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞:</b> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –±–∞–Ω–µ.</div>`
          : (d.exceeds
          ? `<div class="warn-box"><b>–ù–∞—Ä—É—à–µ–Ω–∏–µ:</b> –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (${d.ip_count}/${d.limit}) –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.</div>`
          : (d.ip_count > d.limit
              ? `<div class="warn-box"><b>–ü–æ—è—Å–Ω–µ–Ω–∏–µ:</b> IP –ø—É–ª (${d.ip_count}/${d.limit}) –≤—ã—à–µ –ª–∏–º–∏—Ç–∞, –Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.</div>`
              : ""));
        const hwidDevices = Array.isArray(d.hwid_devices) ? d.hwid_devices : [];
        const hwidCount = Number.isFinite(Number(d.hwid_devices_count)) ? Number(d.hwid_devices_count) : hwidDevices.length;
        const baseAccount = String(d.base_account || d.user_identifier || "-");
        const keySlot = String(d.key_slot || "").trim();
        const clipUa = (ua) => {
          const text = String(ua || "").trim();
          if (!text) return "-";
          return text.length > 110 ? `${text.slice(0, 110)}...` : text;
        };

        const timelineHtml = history.length ? `<div class="timeline">${history.map(h=>{
          const dc = tlDotClass(h.type);
          return `<div class="tl-item">
            <div class="tl-dot${dc?' '+dc:''}"></div>
            <div class="tl-body">
              <div class="tl-head">
                <span class="tl-badge${dc?' '+dc:''}">${tlTypeLabel(h.type)}</span>
                <span class="tl-time">${t(h.timestamp)}</span>
              </div>
              <div class="tl-msg">${tlMsgHtml(h.type,h.message||"",h.source_ip||"")}</div>
            </div>
          </div>`;
        }).join("")}</div>` : `<p class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>`;

        const geoSection = geoCountries.length > 0 || geoMismatch
          ? `<div class="facts-row"><span>–ì–µ–æ-–º–∏—Å–º–∞—Ç—á</span><b>${geoMismatch ? semanticBadge("warn", "–î–∞") : semanticBadge("online", "–ù–µ—Ç")}</b></div>
             <div class="facts-row"><span>–°—Ç—Ä–∞–Ω—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span><b>${geoCountries.length ? geoCountries.map(esc).join(", ") : "-"}</b></div>`
          : "";

        $("mTitle").textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`;
        $("mBody").innerHTML = `
          <div class="user-shell">
            <section class="user-top">
              <div class="user-top-left">
                <h2 class="user-title">${esc(name)}</h2>
                <div class="user-id">${esc(d.user_identifier || "-")}</div>
                <div class="user-tags">
                  <span class="meta-chip"><span class="k">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>${connectionBadge}</span>
                  <span class="meta-chip"><span class="k">–°—Ç–∞—Ç—É—Å</span>${statusBadge}</span>
                  <span class="meta-chip multi"><span class="k">–ù–æ–¥—ã</span>${nodeBadges}</span>
                  <span class="meta-chip"><span class="k">Ban-list</span>${sharing?.in_banlist ? semanticBadge("warn", "–î–∞") : semanticBadge("online", "–ù–µ—Ç")}</span>
                  <span class="meta-chip"><span class="k">–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç</span>${sharing?.permanent_ban ? semanticBadge("offline", "–î–∞") : semanticBadge("online", "–ù–µ—Ç")}</span>
                </div>
              </div>
              <div class="user-actions">
                <div class="user-actions-row">
                  <button class="btn" id="actReset">‚Ü∫ –¢—Ä–∏–≥–≥–µ—Ä—ã</button>
                  <button class="btn" id="actUnblock">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>
                  <button class="btn" id="actClear">–°–±—Ä–æ—Å–∏—Ç—å IP</button>
                </div>
                <div class="user-actions-row ban-row">
                  <select id="actDuration" class="dur-select">
                    <option value="5m">5 –º–∏–Ω</option>
                    <option value="30m" selected>30 –º–∏–Ω</option>
                    <option value="1h">1 —á–∞—Å</option>
                    <option value="6h">6 —á–∞—Å–æ–≤</option>
                    <option value="24h">24 —á–∞—Å–∞</option>
                    <option value="permanent">–ù–∞–≤—Å–µ–≥–¥–∞</option>
                  </select>
                  <button class="btn primary" id="actBlock">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
              </div>
            </section>
            ${warning}
            <section class="user-kpi">
              <div class="kpi-item"><small>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö IP</small><b>${d.ip_count}</b></div>
              <div class="kpi-item"><small>–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (/24)</small><b>${sourceCount}</b></div>
              <div class="kpi-item"><small>–õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</small><b>${d.limit}</b></div>
              <div class="kpi-item"><small>HWID —É—Å—Ç—Ä–æ–π—Å—Ç–≤</small><b>${hwidCount}</b></div>
              <div class="kpi-item"><small>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ live</small><b>${esc(concurrentInfo)}</b></div>
              <div class="kpi-item"><small>–¢—Ä–∏–≥–≥–µ—Ä—ã</small><b>${esc(triggerInfo)}</b></div>
              <div class="kpi-item"><small>–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</small><b>${totalEvents}</b></div>
              <div class="kpi-item"><small>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</small><b class="slim">${rel(lastActivity)}</b></div>
            </section>
            <section class="user-panels">
              <div class="user-card">
                <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
                <div class="facts-row"><span>Telegram ID</span><b>${esc(d.telegram_id || "-")}</b></div>
                <div class="facts-row"><span>Username</span><b>${esc(name)}</b></div>
                <div class="facts-row"><span>–ë–∞–∑–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</span><b>${esc(baseAccount)}</b></div>
                <div class="facts-row"><span>–°–ª–æ—Ç –∫–ª—é—á–∞</span><b>${esc(keySlot || "-")}</b></div>
                <div class="facts-row"><span>–û–ø–∏—Å–∞–Ω–∏–µ</span><b>${esc(d.description || "‚Äî")}</b></div>
                <div class="facts-row"><span>–ü–µ—Ä–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span><b>${t(firstActivity)}</b></div>
                <div class="facts-row"><span>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span><b>${rel(lastActivity)}</b></div>
              </div>
              <div class="user-card">
                <h3>–õ–∏–º–∏—Ç—ã –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h3>
                <div class="facts-row"><span>–í ban-list</span><b>${esc(banlistStatus)}</b></div>
                <div class="facts-row"><span>–ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –±–∞–Ω</span><b>${esc(permanentBanStatus)}</b></div>
                <div class="facts-row"><span>–ù–∞–≤—Å–µ–≥–¥–∞ —Å</span><b>${permanentBanSince ? t(permanentBanSince) : "-"}</b></div>
                <div class="facts-row"><span>–ü–æ–ø–∞–¥–∞–Ω–∏–π –≤ ban-list</span><b style="color:${banCount>0?'#ff9fb4':'inherit'}">${banCount}</b></div>
                <div class="facts-row"><span>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–∑</span><b style="color:${blockedEvents>0?'#ff9fb4':'inherit'}">${blockedEvents}</b></div>
                <div class="facts-row"><span>–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–µ–π—á–∞—Å</span><b>${esc(concurrentState)}</b></div>
                <div class="facts-row"><span>–ü–µ—Ä–∏–æ–¥ —Ç—Ä–∏–≥–≥–µ—Ä–∞</span><b>${windowSeconds} —Å–µ–∫</b></div>
                <div class="facts-row"><span>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–µ–π—á–∞—Å</span><b>${parallelLive ? semanticBadge("warn", "–î–∞") : semanticBadge("online", "–ù–µ—Ç")}</b></div>
                <div class="facts-row"><span>–ù–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</span><b>${activeNodeList.length}</b></div>
                <div class="facts-row"><span>–ü–æ—Å–ª–µ–¥–Ω–∏–π parallel</span><b>${parallelSince ? rel(parallelSince) : "-"}</b></div>
                ${geoSection}
              </div>
            </section>
            <section class="user-card">
              <h3>–¢–µ–∫—É—â–∏–µ IP –∞–¥—Ä–µ—Å–∞ (–∑–∞ TTL)</h3>
              <div class="facts-row"><span>–°–≤–æ–¥–∫–∞ –ø–æ —Å–µ—Ç—è–º</span><b>${esc(networkSummary)}</b></div>
              <div class="table-wrap"><table><thead><tr><th>IP</th><th>–° IP —Å–µ–π—á–∞—Å</th><th>–ù–æ–¥–∞</th><th>TTL</th><th>–ü–æ–¥—Å–µ—Ç—å</th><th>–°–µ—Ç—å</th><th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th></tr></thead><tbody>${ipRows.map(ip=>{
                const ipKey = String(ip.ip || "").trim();
                const shared = ipUsage.get(ipKey);
                const members = Array.isArray(shared?.ids) && shared.ids.length ? shared.ids : [String(d.user_identifier || "-")];
                const connCount = Number(shared?.count || members.length || 1);
                const hint = members.join(", ");
                const countBadge = connCount > 1
                  ? `<span class="badge b-red">${connCount}</span>`
                  : `<span class="badge b-green">${connCount}</span>`;
                return `<tr><td>${esc(ip.ip)}</td><td title="${esc(hint)}">${countBadge}</td><td>${esc(resolveNodeLabel(ip.node_display, ip.node_name))}</td><td>${ip.ttl_seconds}s</td><td>${esc(ip.subnet24)}</td><td>${esc(netTypeName(ip.network_type))}</td><td>${esc(ip.network_provider||"-")}</td><td>${esc(ip.network_country||"-")}</td><td>${esc(ip.network_org||"-")}</td></tr>`;
              }).join("") || `<tr><td colspan="9" class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö IP</td></tr>`}</tbody></table></div>
            </section>
            <section class="user-card">
              <h3>HWID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (${hwidCount})</h3>
              <div class="table-wrap"><table><thead><tr><th>HWID</th><th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th><th>–ú–æ–¥–µ–ª—å</th><th>OS</th><th>User-Agent</th><th>–°–æ–∑–¥–∞–Ω–æ</th><th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th></tr></thead><tbody>${hwidDevices.map(dev=>`<tr><td>${esc(dev.hwid||"-")}</td><td>${esc(dev.platform||"-")}</td><td>${esc(dev.model||"-")}</td><td>${esc(dev.os||"-")}</td><td title="${esc(dev.user_agent||"")}">${esc(clipUa(dev.user_agent))}</td><td>${t(dev.created_at)}</td><td>${t(dev.updated_at)}</td></tr>`).join("") || `<tr><td colspan="7" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ HWID</td></tr>`}</tbody></table></div>
            </section>
            <section class="user-card">
              <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</h3>
              ${timelineHtml}
            </section>
          </div>`;
        $("modal").classList.add("active");
        $("actBlock").onclick = () => {
          const dur = $("actDuration").value;
          manualBlock(id, dur);
        };
        $("actReset").onclick = () => resetSharing(id);
        $("actUnblock").onclick = () => manualUnblock(id);
        $("actClear").onclick = () => manualClear(id);
      }catch(e){
        showNotice("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É: "+e.message, "err");
      }
    }

    async function manualBlock(id, duration){
      const reason = await askReason("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É", "–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):");
      if (reason === null) return;
      try{
        await api("/api/actions/block",{method:"POST",body:JSON.stringify({user_identifier:id,duration,reason:reason||""})});
        showNotice(`–ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (${duration}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`, "ok");
        await load(true);
        await openUser(id);
      }catch(e){
        showNotice("–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: "+e.message, "err");
      }
    }

    async function manualClear(id){
      const reason = await askReason("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É IP", "–ü—Ä–∏—á–∏–Ω–∞ –æ—á–∏—Å—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):");
      if (reason === null) return;
      try{
        await api("/api/actions/clear",{method:"POST",body:JSON.stringify({user_identifier:id,reason:reason||""})});
        showNotice("IP –æ—á–∏—â–µ–Ω—ã", "ok");
        await load(true);
        await openUser(id);
      }catch(e){
        showNotice("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: "+e.message, "err");
      }
    }

    async function manualUnblock(id){
      const reason = await askReason("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É", "–ü—Ä–∏—á–∏–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):");
      if (reason === null) return;
      try{
        await api("/api/actions/unblock",{method:"POST",body:JSON.stringify({user_identifier:id,reason:reason||""})});
        showNotice("–ö–æ–º–∞–Ω–¥–∞ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞", "ok");
        await load(true);
        await openUser(id);
      }catch(e){
        showNotice("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: "+e.message, "err");
      }
    }

    async function resetSharing(id){
      const reason = await askReason("–°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã —à–∞—Ä–∏–Ω–≥–∞", "–ü—Ä–∏—á–∏–Ω–∞ —Å–±—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):", "manual_panel_reset");
      if (reason === null) return;
      try{
        await api("/api/actions/reset_sharing",{method:"POST",body:JSON.stringify({user_identifier:id,reason:reason||"manual_panel_reset"})});
        showNotice("–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã", "ok");
        await load(true);
        await openUser(id);
      }catch(e){
        showNotice("–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞: "+e.message, "err");
      }
    }

    async function bulkUnban(ids){
      if(!ids || ids.size === 0) return;
      const arr = [...ids];
      const reason = await askReason(`–†–∞–∑–±–∞–Ω–∏—Ç—å ${arr.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, "–ü—Ä–∏—á–∏–Ω–∞:");
      if (reason === null) return;
      let ok = 0, fail = 0;
      for(const id of arr){
        try{
          await api("/api/actions/unblock",{method:"POST",body:JSON.stringify({user_identifier:id,reason:reason||"bulk_unban"})});
          ok++;
        }catch{ fail++; }
      }
      showNotice(`–†–∞–∑–±–∞–Ω–µ–Ω–æ: ${ok}${fail>0?`, –æ—à–∏–±–æ–∫: ${fail}`:""}`, fail>0?"err":"ok");
      await load(true);
    }

    async function bulkClear(ids){
      if(!ids || ids.size === 0) return;
      const arr = [...ids];
      const reason = await askReason(`–°–±—Ä–æ—Å–∏—Ç—å IP —É ${arr.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, "–ü—Ä–∏—á–∏–Ω–∞:");
      if (reason === null) return;
      let ok = 0, fail = 0;
      for(const id of arr){
        try{
          await api("/api/actions/clear",{method:"POST",body:JSON.stringify({user_identifier:id,reason:reason||"bulk_clear"})});
          ok++;
        }catch{ fail++; }
      }
      showNotice(`–û—á–∏—â–µ–Ω–æ: ${ok}${fail>0?`, –æ—à–∏–±–æ–∫: ${fail}`:""}`, fail>0?"err":"ok");
      await load(true);
    }

    function exportCSV(filename, rows, headers){
      const escape = v => {
        const s = String(v ?? "");
        if(s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      const lines = [headers.map(escape).join(","), ...rows.map(r=>r.map(escape).join(","))];
      const blob = new Blob([lines.join("\r\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function exportViolators(){
      const viol = users.filter(u=>u.exceeds);
      exportCSV("violators.csv", viol.map(u=>{
        const node = resolveNodeLabel(u.last_node_display, u.last_node);
        const sh = u.sharing;
        return [
          u.user_identifier,
          displayName(u),
          u.ip_count,
          u.limit,
          sh ? `${sh.trigger_hits}/${sh.trigger_required}` : "-",
          node,
          u.last_seen_at || ""
        ];
      }), ["ID", "–ò–º—è", "IP", "–õ–∏–º–∏—Ç", "–¢—Ä–∏–≥–≥–µ—Ä—ã", "–ù–æ–¥–∞", "–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"]);
    }

    function exportBanList(){
      const rows = Array.isArray(sharingBanUsers) && sharingBanUsers.length > 0 ? sharingBanUsers : activeBans;
      exportCSV("banlist.csv", rows.map(b=>{
        const userId = b.user_identifier || (Array.isArray(b.users) ? b.users[0] : "");
        return [
          userId,
          b.username || displayName((users||[]).find(u=>u.user_identifier===userId)||{}),
          (b.violation_ips||b.ip||""),
          b.limit || "-",
          getBanCount(userId),
          b.banlist_since || b.set_at || "",
          b.duration_seconds ? b.duration_seconds+"s" : (b.duration || "-")
        ];
      }), ["ID", "–ò–º—è", "IP", "–õ–∏–º–∏—Ç", "–ë–∞–Ω–æ–≤", "–î–æ–±–∞–≤–ª–µ–Ω", "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"]);
    }

    function exportTrafficCSV(){
      const rows = filteredTrafficRows();
      exportCSV("traffic_usage.csv", rows.map(r=>[
        r.user_identifier || "",
        r.username || r.email || "",
        r.tariff || r.tag || "",
        r.device_limit || "",
        r.connected_ips || 0,
        r.used_traffic_bytes || 0,
        r.lifetime_used_traffic_bytes || 0,
        r.traffic_limit_bytes || 0,
        Number(r.used_percent || 0).toFixed(2),
        r.first_connected_at || "",
        r.expire_at || "",
        r.last_node_display || r.last_node || "",
        r.status || ""
      ]), [
        "ID",
        "–ò–º—è",
        "–¢–∞—Ä–∏—Ñ",
        "–õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤",
        "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–π",
        "Used bytes",
        "Lifetime used bytes",
        "Limit bytes",
        "Used %",
        "First connected",
        "Expire at",
        "Last node",
        "Status"
      ]);
    }

    async function changePassword(){
      const cur=$("curPass").value;
      const n1=$("newPass").value;
      const n2=$("newPass2").value;
      if(n1!==n2){ $("passMsg").textContent="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"; return; }
      if(n1.length<8){ $("passMsg").textContent="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤"; return; }
      try{
        await api("/api/panel/password",{method:"POST",body:JSON.stringify({current_password:cur,new_password:n1})});
        $("passMsg").textContent="–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω";
        $("curPass").value=""; $("newPass").value=""; $("newPass2").value="";
      }catch{
        $("passMsg").textContent="–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å";
      }
    }

    async function saveRuntimeOverrides(){
      const msg = $("runtimeCfgMsg");
      if(msg) msg.textContent = "";
      try{
        const payload = collectConfigEditorPayload();
        const data = await api("/api/config/overrides", {method:"POST", body: JSON.stringify(payload)});
        cfgData = data?.config || cfgData;
        renderConfig();
        if(msg) msg.textContent = "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞";
        showNotice("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞", "ok");
      }catch(e){
        if(msg) msg.textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
        showNotice(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${e.message}`, "err");
      }
    }

    async function resetRuntimeOverrides(){
      const msg = $("runtimeCfgMsg");
      if(msg) msg.textContent = "";
      try{
        const data = await api("/api/config/overrides", {method:"DELETE"});
        cfgData = data?.config || cfgData;
        renderConfig();
        if(msg) msg.textContent = "Runtime overrides —Å–±—Ä–æ—à–µ–Ω—ã";
        showNotice("Runtime overrides —Å–±—Ä–æ—à–µ–Ω—ã", "ok");
      }catch(e){
        if(msg) msg.textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
        showNotice(`–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ overrides: ${e.message}`, "err");
      }
    }

    function renderPageContents(pageId){
      const meta = collectDashboardMeta();
      if(pageId === "dashboard"){
        applyDashboardMeta(meta);
        renderAlertsCenter(meta);
        renderNodeFilters();
        renderTopNodes();
        renderHotUsers();
        renderCharts();
        renderSysinfo();
        return;
      }
      if(pageId === "users"){
        renderNodeFilters();
        renderUsers();
        return;
      }
      if(pageId === "traffic"){ renderTraffic(); return; }
      if(pageId === "violators"){ renderViolators(meta.viol); return; }
      if(pageId === "ban"){ renderBan(); return; }
      if(pageId === "activebans"){ renderActiveBans(); return; }
      if(pageId === "nodeops"){ loadNodeSSHCreds().then(()=>renderNodeSshNodes()); return; }
      if(pageId === "sshterm"){ renderSshterm(); initSstResizeObserver(); return; }
      if(pageId === "permanent-ban"){ renderPermBan(); return; }
      if(pageId === "net"){ renderNet(); return; }
      if(pageId === "shared"){ renderShared(); return; }
      if(pageId === "logs"){ renderLogs(); return; }
      if(pageId === "hwid"){ renderHwid(); return; }
      if(pageId === "settings"){ renderConfig(); return; }
    }

    function switchPage(pageId, title){
      document.querySelectorAll(".menu").forEach(x=>x.classList.remove("active"));
      const activeBtn = document.querySelector(`.menu[data-p="${pageId}"]`);
      if(activeBtn) activeBtn.classList.add("active");
      document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
      const target = $("p-"+pageId);
      if(target) target.classList.add("active");
      const cp = $("currentPage");
      if(cp) cp.textContent = title || (activeBtn ? activeBtn.dataset.title : "–ü–∞–Ω–µ–ª—å");
      renderPageContents(pageId);
    }

    // Event listeners
    document.querySelectorAll(".menu").forEach(b=>{ b.onclick=()=>switchPage(b.dataset.p, b.dataset.title); });
    $("refreshBtn").onclick=()=>load(false);
    $("logoutBtn").onclick=logout;
    $("loginBtn").onclick=login;
    $("loginPass").onkeydown=e=>{ if(e.key==="Enter") login(); };
    $("closeM").onclick=()=>{ $("modal").classList.remove("active"); openCardId=null; };
    $("modal").onclick=e=>{ if(e.target===$("modal")){ $("modal").classList.remove("active"); openCardId=null; } };
    $("nodeDrawerClose").onclick=closeNodeDrawer;
    $("nodeDrawerBackdrop").onclick=closeNodeDrawer;
    $("qUser").oninput=()=>{ usersPage=0; renderUsers(); };
    $("fState").onchange=()=>{ usersPage=0; renderUsers(); };
    $("fNode").onchange=()=>{ usersPage=0; renderUsers(); };
    if($("fHotNode")) $("fHotNode").onchange=()=>renderHotUsers();
    $("qTraffic").oninput=renderTraffic;
    $("fTrafficTariff").onchange=renderTraffic;
    $("fTrafficNode").onchange=renderTraffic;
    $("fTrafficStatus").onchange=renderTraffic;
    document.querySelectorAll("#trafficPeriodGroup .seg-btn").forEach(btn=>btn.onclick=()=>setTrafficPeriod(btn.dataset.period));
    if($("nodesToggleBtn")) $("nodesToggleBtn").onclick=toggleDashboardNodes;
    $("changePassBtn").onclick=changePassword;
    if($("saveOverridesBtn")) $("saveOverridesBtn").onclick=saveRuntimeOverrides;
    if($("resetOverridesBtn")) $("resetOverridesBtn").onclick=resetRuntimeOverrides;
    $("sidebarToggle").onclick=toggleSidebar;
    $("globalSearch").onkeydown=e=>{ if(e.key==="Enter") globalSearch(); };
    $("exportViolatorsBtn").onclick=exportViolators;
    $("exportBanBtn").onclick=exportBanList;
    $("trafficExportBtn").onclick=exportTrafficCSV;
    $("nodeSshSelectAll").onclick=()=>nodeSshSelect("all");
    $("nodeSshSelectOnline").onclick=()=>nodeSshSelect("online");
    $("nodeSshClear").onclick=()=>nodeSshSelect("none");
    $("nodeSshRefresh").onclick=()=>liveRefresh();
    $("nodeSshRunSingle").onclick=runNodeSshSingleCommand;
    $("nodeSshRun").onclick=runNodeSshCommand;
    $("nodeSshRunAll").onclick=runNodeSshOnAll;
    $("nodeSshOutputClear").onclick=clearNodeSshOutput;
    $("nodeSshSingleClear").onclick=clearNodeSshOutput;
    $("nodeSshSingleCommand").onkeydown=e=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ runNodeSshSingleCommand(); } };
    $("nodeSshCommand").onkeydown=e=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ runNodeSshCommand(); } };
    // Credentials modal
    $("credModalClose").onclick=closeNodeCredModal;
    $("credCancelBtn").onclick=closeNodeCredModal;
    $("credModalBackdrop").onclick=closeNodeCredModal;
    $("credSaveBtn").onclick=saveNodeCred;
    $("credDeleteBtn").onclick=deleteNodeCred;
    $("credOpenTermBtn").onclick=()=>{
      const key = credModalNodeKey;
      if(!key) return;
      closeNodeCredModal();
      switchPage("sshterm", "SSH –¢–µ—Ä–º–∏–Ω–∞–ª");
      setTimeout(()=>{
        const sel = $("sstNodeSelect");
        if(sel){ sel.value = key; }
        openSstTerminal(key);
      }, 150);
    };
    $("credPwToggle").onclick=()=>{
      const pw=$("credPassword");
      if(!pw) return;
      pw.type = pw.type==="password" ? "text" : "password";
    };
    $("credUser").onkeydown=e=>{ if(e.key==="Enter") $("credPassword")?.focus(); };
    $("credPassword").onkeydown=e=>{
      if(e.key === "Enter"){
        e.preventDefault();
        $("credPrivateKey")?.focus();
      }
    };
    $("credPrivateKey").onkeydown=e=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter") saveNodeCred(); };
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeNodeCredModal(); });
    // SSH Terminal page
    $("sstConnect").onclick=()=>openSstTerminal(String($("sstNodeSelect")?.value||"").trim());
    $("sstDisconnectAll").onclick=closeSstAll;
    $("sstNodeSelect").onkeydown=e=>{ if(e.key==="Enter") openSstTerminal(String($("sstNodeSelect")?.value||"").trim()); };

    // Violator bulk actions
    $("violCheckAll").onchange=function(){
      const cbs = document.querySelectorAll(".viol-cb");
      violatorSel = new Set();
      cbs.forEach(cb=>{ cb.checked=this.checked; if(this.checked) violatorSel.add(cb.dataset.id); });
      updateViolBulkBar();
    };
    $("violBulkUnban").onclick=()=>bulkUnban(violatorSel);
    $("violBulkClear").onclick=()=>bulkClear(violatorSel);
    $("violBulkDeselect").onclick=()=>{
      violatorSel=new Set();
      document.querySelectorAll(".viol-cb").forEach(cb=>cb.checked=false);
      $("violCheckAll").checked=false;
      updateViolBulkBar();
    };

    // Users bulk actions
    $("usersCheckAll").onchange=function(){
      const cbs = document.querySelectorAll(".user-cb");
      usersSel = new Set();
      cbs.forEach(cb=>{ cb.checked=this.checked; if(this.checked&&cb.dataset.id) usersSel.add(cb.dataset.id); });
      updateUsersBulkBar();
    };
    $("usersBulkBlock").onclick=()=>bulkBlockUsers(usersSel);
    $("usersBulkUnblock").onclick=()=>bulkUnban(usersSel);
    $("usersBulkDeselect").onclick=()=>{
      usersSel=new Set();
      document.querySelectorAll(".user-cb").forEach(cb=>cb.checked=false);
      const allCb=$("usersCheckAll"); if(allCb) allCb.checked=false;
      updateUsersBulkBar();
    };

    // Ban bulk actions
    $("banCheckAll").onchange=function(){
      const cbs = document.querySelectorAll(".ban-cb");
      banSel = new Set();
      cbs.forEach(cb=>{ cb.checked=this.checked; if(this.checked&&cb.dataset.id) banSel.add(cb.dataset.id); });
      updateBanBulkBar();
    };
    $("banBulkUnban").onclick=()=>bulkUnban(banSel);
    $("banBulkDeselect").onclick=()=>{
      banSel=new Set();
      document.querySelectorAll(".ban-cb").forEach(cb=>cb.checked=false);
      $("banCheckAll").checked=false;
      updateBanBulkBar();
    };

    // Log filter
    document.querySelectorAll(".lf-cb").forEach(cb=>{
      cb.onchange=()=>{
        if(cb.checked) logFilters.add(cb.dataset.cat);
        else logFilters.delete(cb.dataset.cat);
        renderLogs();
      };
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && $("nodeDrawer")?.classList.contains("active")){
        closeNodeDrawer();
      }
    });
    document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible") liveRefresh(); });
    checkAuth();
  </script>
</body>
</html>
