# ═══════════════════════════════════════════════════════════════════
# FFXBan Agent — Vector config для 3x-ui ноды
# Не требует nginx. Читает логи напрямую из Docker-контейнера x-ui.
# Замените NODE_NAME и OBSERVER_URL на свои значения.
# ═══════════════════════════════════════════════════════════════════

# ─── ИСТОЧНИК 1: Xray access log (VPN-подключения) ──────────────────
# Монтируется через docker-compose-agent.yml: /usr/local/x-ui/access.log
[sources.xray_logs]
type = "file"
include = ["/var/log/xray/access.log"]
read_from = "end"

# ─── ТРАНСФОРМАЦИЯ 1: Xray → {user_email, source_ip, node_name} ─────
[transforms.parse_xray]
type = "remap"
inputs = ["xray_logs"]
source = '''
  pattern = r'from (?:tcp:)?(?P<ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):\d+.*?email:\s*(?P<email>\S+)'
  parsed, err = parse_regex(.message, pattern)
  if err != null { abort }
  . = {
    "user_email": string!(parsed.email),
    "source_ip":  string!(parsed.ip),
    "node_name":  "NODE_NAME"
  }
'''

# ─── ИСТОЧНИК 2: Docker-логи x-ui контейнера (подписки) ─────────────
# Gin пишет: [GIN] date | status | latency | ip | METHOD "/path/sub/email@example.com"
# Из этого извлекаем email в момент обновления подписки клиентом.
[sources.xui_docker_logs]
type = "docker_logs"
include_containers = ["3x-ui"]

# ─── ТРАНСФОРМАЦИЯ 2: Gin sub-запрос → {user_email, user_agent} ─────
[transforms.parse_xui_sub]
type = "remap"
inputs = ["xui_docker_logs"]
source = '''
  msg = string!(.message)

  # Ищем только строки с /sub/ (запросы подписок)
  if !contains(msg, "/sub/") && !contains(msg, "/subscription/") { abort }

  # Парсим Gin формат: "... | ip | METHOD \"/path\""
  gin_pattern = r'\|\s*(?P<ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\s*\|\s*(?:GET|POST)\s+"(?P<path>[^"]+)"'
  parsed, err = parse_regex(msg, gin_pattern)
  if err != null { abort }

  # Извлекаем email из URL-пути
  email_pattern = r'(?P<email>[a-zA-Z0-9._%+\-]{1,60}@[a-zA-Z0-9.\-]{1,60}\.[a-zA-Z]{2,10})'
  email_match, err2 = parse_regex(string!(parsed.path), email_pattern)
  if err2 != null { abort }

  . = {
    "user_email": string!(email_match.email),
    "user_agent": "Sub-fetch from " + string!(parsed.ip),
    "node_name":  "NODE_NAME"
  }
'''

# ─── SINK 1: VPN логи → /log-entry ──────────────────────────────────
[sinks.ffxban_logs]
type = "http"
inputs = ["parse_xray"]
uri = "https://observer.example.com:38213/"
method = "post"
encoding.codec = "json"
compression = "gzip"

  [sinks.ffxban_logs.batch]
  max_events   = 100
  timeout_secs = 5

  [sinks.ffxban_logs.request]
  retry_attempts     = 5
  retry_backoff_secs = 2
  timeout_secs       = 10

  [sinks.ffxban_logs.tls]
  verify_certificate = false

# ─── SINK 2: Подписки → /device-report ──────────────────────────────
[sinks.ffxban_devices]
type = "http"
inputs = ["parse_xui_sub"]
uri = "https://observer.example.com:38213/device-report"
method = "post"
encoding.codec = "json"
compression = "gzip"

  [sinks.ffxban_devices.batch]
  max_events   = 50
  timeout_secs = 15

  [sinks.ffxban_devices.request]
  retry_attempts     = 3
  retry_backoff_secs = 5
  timeout_secs       = 10

  [sinks.ffxban_devices.tls]
  verify_certificate = false

# ─────────────────────────────────────────────────────────────────────
# ОПЦИОНАЛЬНО: если перед x-ui стоит nginx и он пишет User-Agent в лог,
# раскомментируйте блок ниже — тогда Platform/Model/OS будут определяться.
#
# [sources.nginx_sub_logs]
# type = "file"
# include = ["/var/log/nginx/sub.log"]
# read_from = "end"
#
# [transforms.parse_nginx_sub]
# type = "remap"
# inputs = ["nginx_sub_logs"]
# source = '''
#   pattern = r'"(?:GET|POST) (?P<path>[^"]+) HTTP[^"]*" "(?P<ua>[^"]+)"'
#   parsed, err = parse_regex(.message, pattern)
#   if err != null || parsed.ua == "-" || parsed.ua == "" { abort }
#   email_pattern = r'(?P<email>[a-zA-Z0-9._%+\-]{1,60}@[a-zA-Z0-9.\-]{1,60}\.[a-zA-Z]{2,10})'
#   email_match, err2 = parse_regex(string!(parsed.path), email_pattern)
#   if err2 != null { abort }
#   . = {"user_email": string!(email_match.email), "user_agent": string!(parsed.ua), "node_name": "NODE_NAME"}
# '''
#
# # Добавьте "parse_nginx_sub" в inputs для ffxban_devices выше.
