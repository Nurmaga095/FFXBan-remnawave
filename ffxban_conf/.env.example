# =============================================================================
# ffxban Observer — пример конфигурации
# Скопируйте этот файл в .env и заполните ВСЕ обязательные поля (помечены [REQUIRED])
# =============================================================================

# -----------------------------------------------------------------------------
# [REQUIRED] Пароль для веб-панели администратора
# После первого старта можно сменить через раздел "Настройки" в панели.
# Минимум 12 символов, используйте случайную строку (например: openssl rand -hex 16)
# -----------------------------------------------------------------------------
PANEL_PASSWORD=

# Время жизни сессии панели (часы)
PANEL_SESSION_TTL_HOURS=24

# -----------------------------------------------------------------------------
# [REQUIRED] Токен для внутренних API-эндпоинтов (/api/stats, /api/users и т.д.)
# Генерация: openssl rand -hex 32
# Используется Telegram-ботом или внешними интеграциями. Если не задан —
# API доступно только через сессию панели (менее безопасно).
# -----------------------------------------------------------------------------
INTERNAL_API_TOKEN=

# -----------------------------------------------------------------------------
# [REQUIRED] RabbitMQ — брокер очередей между Observer и Blocker-нодами
# Формат: amqp://USER:PASSWORD@rabbitmq:5672/
# USER и PASSWORD должны совпадать с RABBIT_USER / RABBIT_PASSWD ниже.
# -----------------------------------------------------------------------------
RABBIT_USER=
RABBIT_PASSWD=
RABBITMQ_URL=
# Пример: RABBITMQ_URL=amqp://ffxban_user:StrongPassword123@rabbitmq:5672/

# exchange для отчётов от blocker-агентов (action/heartbeat)
BLOCKING_STATUS_EXCHANGE_NAME=blocking_status_exchange

# Через сколько секунд без heartbeat нода считается offline
NODE_HEARTBEAT_TIMEOUT_SECONDS=120

# -----------------------------------------------------------------------------
# Redis
# -----------------------------------------------------------------------------
REDIS_URL=redis://redis:6379/0

# Авто-очистка Redis от «сиротских» ключей (ip_ttl/ip_node без живого user_ips)
REDIS_HOUSEKEEPING_ENABLED=true
REDIS_HOUSEKEEPING_INTERVAL_SECONDS=600
REDIS_HOUSEKEEPING_MAX_KEYS=5000

# -----------------------------------------------------------------------------
# Лимиты IP-адресов
# -----------------------------------------------------------------------------
# Глобальный лимит: при превышении все IP пользователя попадают под блокировку.
# Если подключена панель Remnawave (PANEL_URL/PANEL_TOKEN), лимит берётся оттуда.
MAX_IPS_PER_USER=12

# Время жизни IP-адреса пользователя в Redis (секунды). По умолчанию — 24 часа.
USER_IP_TTL_SECONDS=86400

# Задержка перед очисткой IP после блокировки (секунды)
CLEAR_IPS_DELAY_SECONDS=30

# Кулдаун уведомлений (секунды): не отправлять повторный вебхук быстрее этого порога
ALERT_COOLDOWN_SECONDS=30

# Продолжительность блокировки, передаётся в nftables (формат: <число><s|m|h|d>)
BLOCK_DURATION=5m

# -----------------------------------------------------------------------------
# Webhook-уведомления (Telegram-бот или другой сервис)
# -----------------------------------------------------------------------------
ALERT_WEBHOOK_URL=
# Пример: ALERT_WEBHOOK_URL=https://bot.example.com/webhook/alert

# Режим вебхука:
#   legacy  — стандартный JSON ffxban (по умолчанию)
#   ban_api — формат для Remnawave-бота (/send: notification_type, ip_count и т.д.)
ALERT_WEBHOOK_MODE=legacy

# Токен аутентификации для вебхука (передаётся в заголовке ALERT_WEBHOOK_AUTH_HEADER)
ALERT_WEBHOOK_TOKEN=

# Заголовок для токена (X-API-Key или Authorization для Bearer-токена)
ALERT_WEBHOOK_AUTH_HEADER=X-API-Key

# Префикс username при формировании имени из user_identifier (пример: 447 → user_447)
ALERT_WEBHOOK_USERNAME_PREFIX=user_

# -----------------------------------------------------------------------------
# Интеграция с панелью Remnawave (динамические лимиты, HWID, ноды)
# Если заполнены — лимиты из панели приоритетнее MAX_IPS_PER_USER
# -----------------------------------------------------------------------------
PANEL_URL=
PANEL_TOKEN=

# Интервал фоновой синхронизации лимитов из панели (секунды)
PANEL_RELOAD_INTERVAL_SECONDS=300

# On-demand синхронизация при открытии карточки пользователя:
# подтягиваем данные из панели, если кэш старше N секунд
PANEL_ON_DEMAND_SYNC_MAX_AGE_SECONDS=20

# Разделитель для per-device ключей в user_identifier.
# Пример: user_1601717535#iphone, user_1601717535#pc
PER_DEVICE_KEY_DELIMITER=#

# -----------------------------------------------------------------------------
# SSH-управление нодами из админки (выполнение команд по выбранным нодам)
# -----------------------------------------------------------------------------
# Включить/выключить функционал SSH в панели
NODE_SSH_ENABLED=false

# SSH-логин для всех нод (общий). Если пусто — SSH API отключается.
NODE_SSH_USER=

# Один из методов аутентификации:
# 1) пароль
NODE_SSH_PASSWORD=
# 2) приватный ключ (одной строкой, \n для переносов)
# Пример: NODE_SSH_PRIVATE_KEY=-----BEGIN OPENSSH PRIVATE KEY-----\n...\n-----END OPENSSH PRIVATE KEY-----
NODE_SSH_PRIVATE_KEY=

# Порт по умолчанию, если в адресе ноды из панели порт не указан
NODE_SSH_DEFAULT_PORT=22

# Таймауты и ограничения
NODE_SSH_CONNECT_TIMEOUT_SECONDS=8
NODE_SSH_COMMAND_TIMEOUT_SECONDS=45
NODE_SSH_MAX_PARALLEL=5
NODE_SSH_MAX_OUTPUT_BYTES=262144

# -----------------------------------------------------------------------------
# Белые списки
# -----------------------------------------------------------------------------
# Пользователи, которые никогда не проверяются (через запятую, без пробелов)
EXCLUDED_USERS=
# Алиас EXCLUDED_USERS (для удобства)
WHITELIST_EMAILS=

# IP-адреса, которые никогда не блокируются (через запятую, без пробелов)
# Обязательно укажите IP адреса ваших нод!
EXCLUDED_IPS=

# -----------------------------------------------------------------------------
# Anti-false-positive эвристики
# Анализируют паттерн смены IP, чтобы не банить мобильных пользователей
# -----------------------------------------------------------------------------
HEURISTICS_ENABLED=true
HEURISTICS_WINDOW_SECONDS=120
HEURISTICS_MIN_SAMPLES=8
HEURISTICS_MAX_SAMPLES=30
HEURISTICS_MIN_SUBNET24=2
HEURISTICS_MIN_SWITCH_RATE=0.45
HEURISTICS_MIN_DIVERSITY_RATIO=0.35

# -----------------------------------------------------------------------------
# Классификация типа сети IP (mobile / wifi / cable / unknown)
# -----------------------------------------------------------------------------
NETWORK_DETECT_ENABLED=true

# Провайдер lookup: ipwho | ipinfo
NETWORK_LOOKUP_PROVIDER=ipwho

# URL для ipwho (по умолчанию):
NETWORK_LOOKUP_URL=https://ipwho.is/{ip}

# Токен для ipinfo lite (если используется ipinfo):
NETWORK_LOOKUP_TOKEN=

NETWORK_LOOKUP_TIMEOUT_SECONDS=3
NETWORK_CACHE_TTL_SECONDS=3600

# -----------------------------------------------------------------------------
# Политика блокировок с учётом типа сети
# -----------------------------------------------------------------------------
NETWORK_POLICY_ENABLED=true

# mobile: +1 IP к лимиту (меньше ложных банов при переключении LTE/WiFi)
NETWORK_MOBILE_GRACE_IPS=1
# wifi/cable: без послаблений
NETWORK_WIFI_GRACE_IPS=0
NETWORK_CABLE_GRACE_IPS=0
# unknown/mixed: без послаблений
NETWORK_UNKNOWN_GRACE_IPS=0
NETWORK_MIXED_GRACE_IPS=0
# Если превышение >= limit + N — баним всегда, независимо от типа сети
NETWORK_FORCE_BLOCK_EXCESS_IPS=3

# -----------------------------------------------------------------------------
# Детекция шаринга подписок (рекомендуемые production-значения)
# -----------------------------------------------------------------------------
SHARING_DETECTION_ENABLED=true

# Окно «одновременности» (сек): уникальные IP считаются в этом окне
CONCURRENT_WINDOW_SECONDS=2

# Окно активности источников (сек): учитываются только IP, реально видимые в трафике
SHARING_SOURCE_WINDOW_SECONDS=180

# Минимальная длительность непрерывного превышения для записи триггера (сек)
SHARING_SUSTAIN_SECONDS=90

# Период накопления триггеров (сек)
TRIGGER_PERIOD_SECONDS=900

# Количество триггеров за период для присвоения статуса «нарушитель»
TRIGGER_COUNT=8

# Минимальный интервал между триггерами (сек) — защита от счёта по каждому пакету
TRIGGER_MIN_INTERVAL_SECONDS=30

# Через сколько секунд непрерывного статуса нарушителя добавлять в ban-list
BANLIST_THRESHOLD_SECONDS=900

# Автобан навсегда для подтверждённого нарушителя из ban-list
SHARING_PERMANENT_BAN_ENABLED=false
SHARING_PERMANENT_BAN_DURATION=permanent

# Если HWID устройств не превышает лимит — не применяем блокировку
SHARING_HARDWARE_GUARD_ENABLED=true

# Блокировка только после статуса «нарушитель» (TRIGGER_COUNT триггеров)
SHARING_BLOCK_ON_VIOLATOR_ONLY=true

# Самый безопасный режим: блокировка только после попадания в ban-list
# Рекомендуется true для минимизации ложных банов
SHARING_BLOCK_ON_BANLIST_ONLY=true

# Группировать IP по /24-подсети (меньше ложных срабатываний при churn внутри подсети)
SUBNET_GROUPING=true

# -----------------------------------------------------------------------------
# Эскалация банов (нарастающие длительности блокировки)
# При BAN_ESCALATION_ENABLED=true длительность бана зависит от числа прошлых банов.
# Лестница: 1-й бан=1h, 2-й=6h, 3-й=24h, 4-й и далее=permanent
# Работает только если SHARING_PERMANENT_BAN_ENABLED=true
# -----------------------------------------------------------------------------
BAN_ESCALATION_ENABLED=false
BAN_ESCALATION_DURATIONS=1h,6h,24h,permanent

# -----------------------------------------------------------------------------
# Гео-анализ шаринга (IP из разных стран)
# Если у пользователя одновременно активны IP из 2+ стран — подозрение на шаринг.
# Событие geo_sharing_detected записывается в историю пользователя.
# Требует NETWORK_DETECT_ENABLED=true для определения страны IP.
# -----------------------------------------------------------------------------
GEO_SHARING_ENABLED=false
GEO_SHARING_MIN_COUNTRIES=2

# -----------------------------------------------------------------------------
# Prometheus-метрики
# GET /metrics — текстовый формат Prometheus (без аутентификации).
# Метрики: violators, banlist, permanent bans, geo mismatches, active bans,
#           node health, queue lengths.
# ВНИМАНИЕ: эндпоинт публичный — не открывайте порт наружу без nginx/firewall.
# -----------------------------------------------------------------------------
PROMETHEUS_ENABLED=false
