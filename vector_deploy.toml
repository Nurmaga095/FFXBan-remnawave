# FFXBan Agent - Vector config for 3x-ui node (NODE_NAME)

# ─── SOURCE 1: Xray access log (VPN connections) ──────────────────
[sources.xray_logs]
type = "file"
include = ["/var/log/x-ui/access.log"]
read_from = "end"

# ─── TRANSFORM 1: Xray -> {user_email, source_ip, node_name} ─────
[transforms.parse_xray]
type = "remap"
inputs = ["xray_logs"]
source = '''
  # Xray log pattern: ... email: user@example.com
  pattern = r'email:\s*(?P<email>\S+)'
  parsed, err = parse_regex(.message, pattern)
  if err != null { abort }
  
  .user_email = string!(parsed.email)
  .node_name = "NODE_NAME"

  # Extract IP if present (usually "from 1.2.3.4")
  ip_pattern = r'from (?:tcp:)?(?P<ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})'
  ip_match, err2 = parse_regex(.message, ip_pattern)
  if err2 == null {
    .source_ip = string!(ip_match.ip)
  }
'''

# ─── SOURCE 2: Nginx access log (Subscription updates with UA) ────
[sources.nginx_logs]
type = "file"
include = ["/var/log/nginx/access.log"]
read_from = "end"

# ─── TRANSFORM 2: Nginx -> {user_email, user_agent, node_name} ────
[transforms.parse_nginx]
type = "remap"
inputs = ["nginx_logs"]
source = '''
  # Nginx log pattern: IP - - [Time] "GET /path HTTP/1.1" Status Size "-" "UserAgent"
  pattern = r'^(?P<ip>\S+) - \S+ \[(?P<timestamp>[^\]]+)\] "(?P<method>\S+) (?P<path>\S+) \S+" (?P<status>\d+) \d+ "[^"]*" "(?P<ua>[^"]+)"'
  parsed, err = parse_regex(.message, pattern)
  if err != null { abort }

  # Ensure types
  path = string!(parsed.path)

  # Filter for subscription requests
  if !match(path, r'/sub/') { abort }

  # Extract UUID from path (e.g., /sub/UUID)
  uuid_pattern = r'(?P<uuid>[a-f0-9-]{36})'
  uuid_match, err2 = parse_regex(path, uuid_pattern)
  
  if err2 == null {
    .user_email = string!(uuid_match.uuid)
  } else {
    # Fallback to email regex if path contains email
    email_pattern = r'(?P<email>[a-zA-Z0-9._%+\-]{1,60}@[a-zA-Z0-9.\-]{1,60}\.[a-zA-Z]{2,10})'
    email_match, err3 = parse_regex(path, email_pattern)
    if err3 == null {
      .user_email = string!(email_match.email)
    } else {
      abort # Skip if no UUID/Email identifier found
    }
  }

  .user_agent = string!(parsed.ua)
  .source_ip = string!(parsed.ip)
  .node_name = "NODE_NAME"
'''

# ─── SINK 1: VPN logs -> /log-entry ──────────────────────────────
[sinks.ffxban_logs]
type = "http"
inputs = ["parse_xray"]
uri = "https://observer.example.com:38213/"
method = "post"
encoding.codec = "json"
compression = "gzip"
  [sinks.ffxban_logs.tls]
  verify_certificate = false

# ─── SINK 2: Subscription logs -> /device-report ─────────────────
[sinks.ffxban_devices]
type = "http"
inputs = ["parse_nginx"]
uri = "https://observer.example.com:38213/device-report"
method = "post"
encoding.codec = "json"
compression = "gzip"
  [sinks.ffxban_devices.tls]
  verify_certificate = false
